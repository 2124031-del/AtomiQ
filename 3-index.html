<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>原子クイズ</title>
    <style>
        :root {
            --bg-color: #2c3044;
            --primary-text-color: #E0E0E0;
            --button-bg: #4E5476;
            --button-hover-bg: #6A7094;
            --green-btn: #4CAF50;
            --green-btn-hover: #5CBF60;
            --gray-btn: #6c757d;
            --gray-btn-hover: #828a91;
            --light-gray-btn: #adb5bd;
            --light-gray-btn-hover: #c1c8ce;
            --yellow-btn: #ffc107;
            --yellow-btn-hover: #ffca2c;
            --red-btn: #dc3545;
            --red-btn-hover: #e45b68;
            --dark-lemon-btn: #FBC02D;
            --dark-lemon-btn-hover: #F9A825;
            --yellow-green-btn: #AFB42B;
            --yellow-green-btn-hover: #9E9D24;
            --correct-color: #28a745;
            --incorrect-color: #dc3545;
            --enter-key-color: #00BFFF;
            --shift-key-active-color: #00BFFF;
            --font-family: 'Helvetica Neue', 'Arial', 'Hiragino Kaku Gothic ProN', 'Hiragino Sans', 'Meiryo', sans-serif;

            /* Genre Colors */
            --genre-seni: #FF4500; --genre-tenkei: #00BFFF; --genre-alkali: #DC143C;
            --genre-alkali-earth: #FFD700; --genre-halogen: #9ACD32; --genre-kigasu: #00FFFF;
            --genre-lanthanoid: #FFA500; --genre-actinoid: #708090;

            /* Format Colors */
            --format-color-1: #E53935; --format-color-2: #EC407A; --format-color-3: #D81B60;
            --format-color-4: #1E88E5; --format-color-5: #8E24AA; --format-color-6: #5E31B1;
            --format-color-7: #FDD835; --format-color-8: #7CB342; --format-color-9: #C62828;
            --format-color-10: #00897B; --format-color-11: #FB8C00; --format-color-12: #78909C;

            /* Mode Colors */
            --mode-survival: #FF9800; --mode-endless: #F44336; --mode-hardcore: #212121;
            --mode-hardcore-glow: #9C27B0;
        }

        @keyframes hardcore-glow {
            0%, 100% { box-shadow: 0 0 8px 3px var(--mode-hardcore); }
            50% { box-shadow: 0 0 12px 6px var(--mode-hardcore-glow); }
        }

        @keyframes endless-glow {
            0%, 100% { box-shadow: 0 0 8px 3px var(--mode-hardcore); }
            50% { box-shadow: 0 0 12px 6px var(--mode-endless); }
        }
        
        /* --- Theme Transition --- */
        .theme-transition,
        .theme-transition *,
        .theme-transition *:before,
        .theme-transition *:after {
             transition: background-color 5s ease, color 5s ease, border-color 5s ease, fill 5s ease !important;
        }
        
        body.theme-light {
            --bg-color: #ffffff; --primary-text-color: #000000; --button-bg: #E0E0E0;
            --button-hover-bg: #BDBDBD; --gray-btn: #757575; --gray-btn-hover: #616161;
            --light-gray-btn: #757575; --light-gray-btn-hover: #616161;
        }
        
        body {
            background-color: var(--bg-color); color: var(--primary-text-color); font-family: var(--font-family);
            margin: 0; padding: 20px; display: flex; justify-content: center; align-items: flex-start;
            min-height: 100vh; text-align: center; user-select: none; -webkit-user-select: none; overflow-y: auto;
        }

        body.modal-open {
            overflow: hidden;
        }

        .container { 
            width: 100%; max-width: 800px; padding: 20px; box-sizing: border-box; position: relative;
            transition: transform 0.5s ease-in-out;
        }
        .container.rotated {
            transform: rotate(180deg);
        }

        #title-screen, #quiz-screen { display: none; }
        #title-screen.active, #quiz-screen.active { display: block; }
        h1 { font-size: 2.5rem; margin-bottom: 1rem; color: var(--primary-text-color); text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3); }
        .range-settings { background-color: rgba(0, 0, 0, 0.2); padding: 20px; border-radius: 15px; margin-bottom: 1rem; }
        body.theme-light .range-settings { background-color: rgba(0,0,0,0.1); }
        .range-control { margin-bottom: 1rem; }
        .range-control:last-child { margin-bottom: 0; }
        .range-label { font-size: 1.5rem; margin-bottom: 0.5rem; display: block; font-weight: bold; }
        .range-value { font-size: 3rem; font-weight: bold; color: var(--primary-text-color); margin-bottom: 1rem; }
        .range-buttons { display: flex; justify-content: center; flex-wrap: wrap; gap: 5px; }
        .btn {
            padding: 10px 15px; font-size: 1rem; border: none; border-radius: 8px; cursor: pointer;
            transition: transform 0.1s ease; color: white; min-width: 45px; box-sizing: border-box;
        }
        body.theme-light .btn { color: var(--primary-text-color); }
        .btn:active { transform: scale(0.95); }
        .range-btn { background-color: var(--button-bg); }
        .range-btn:hover { background-color: var(--button-hover-bg); }
        body.theme-light .range-btn { background-color: #757575; color: #fff; }

        .title-actions { display: flex; justify-content: center; align-items: center; gap: 10px; margin-top: 1rem; }
        #start-btn, #format-btn { padding: 15px 40px; font-size: 1.5rem; }
        #start-btn { background-color: var(--green-btn); }
        #start-btn:hover { background-color: var(--green-btn-hover); }
        #start-btn.hardcore-active { background-color: var(--mode-hardcore); animation: hardcore-glow 2s infinite; }
        #format-btn { background-color: var(--gray-btn); }
        #default-range-btn { background-color: var(--gray-btn); padding: 10px 20px; font-size: 1rem; margin-top: 10px; }
        body.theme-light #default-range-btn { color: #fff; }
        #default-range-btn:hover { background-color: var(--gray-btn-hover); }
        #expansion-btn {
            margin-top: 15px; font-size: 0.9rem; padding: 12px 20px; background-color: var(--dark-lemon-btn);
            color: #000; position: relative; overflow: hidden;
        }
        #expansion-btn::before {
            content: ''; position: absolute; top: 0; left: 0; height: 100%;
            width: var(--fill-width, 0%); background-color: rgba(255, 0, 0, 0.3);
        }
        #expansion-btn.genshicho { background-color: var(--yellow-green-btn); color: #FFF; }
        #expansion-btn.genshicho:hover { background-color: var(--yellow-green-btn-hover); }

        #quiz-screen { position: relative; padding-top: 60px; }
        #quiz-info { position: absolute; top: 0; left: 0; right: 0; display: flex; justify-content: space-between; align-items: flex-start; padding: 10px 20px 0; }
        #normal-stats { display: flex; flex-direction: column; align-items: flex-start; }
        #battle-stats { display: none; flex-direction: column; align-items: flex-start; gap: 8mm; }
        #player1-stats, #player2-stats { display: flex; flex-direction: column; align-items: flex-start; gap: 5px; font-size: 1.2rem; }
        
        #timer-display { position: absolute; top: 40px; left: 50%; transform: translateX(-50%); font-size: 1.5rem; font-weight: bold; }
        #turn-indicator { font-size: 1.5rem; font-weight: bold; margin-bottom: 0.5rem; }
        #question-container { margin-top: 0; margin-bottom: 1rem; }
        #question-text { font-size: 2.5rem; font-weight: bold; }
        #options-grid { display: grid; gap: 10px; margin-top: 20px; }
        .option-btn { background-color: var(--button-bg); padding: 18px 10px; font-size: 1.1rem; }
        .option-btn:hover { background-color: var(--button-hover-bg); }
        .option-btn.correct { background-color: var(--correct-color); }
        .option-btn.incorrect { background-color: var(--incorrect-color); }
        .option-btn:disabled { cursor: default; opacity: 0.8; }
        .option-btn.faded { opacity: 0.5; }
        .icon-btn { position: absolute; top: 20px; right: 20px; background: none; border: none; cursor: pointer; padding: 10px; z-index: 10; }
        .icon-btn:disabled { opacity: 0.5; cursor: default; }
        .icon-btn svg { width: 32px; height: 32px; fill: var(--primary-text-color); }
        .icon-btn:hover:not(:disabled) svg { transform: scale(1.1); }
        #coin-display { position: absolute; top: 20px; right: 70px; background-color: var(--yellow-btn); color: #000; font-size: 1.2rem; font-weight: bold; padding: 8px 15px; }
        
        .heart-path { stroke-width: 1.5; }
        body.theme-dark .heart-path { stroke: white; }
        body.theme-light .heart-path { stroke: black; }


        #input-container { margin-top: 1rem; margin-bottom: 1rem; }
        #answer-input {
            font-size: 1.5rem; padding: 10px; border-radius: 8px; border: 2px solid var(--button-bg);
            background-color: var(--bg-color); color: var(--primary-text-color); text-align: center;
            width: 100%; box-sizing: border-box;
        }
        #input-helper { font-size: 0.9rem; margin-top: 5px; opacity: 0.7; }
        
        #custom-keyboard { display: none; flex-direction: column; gap: 8px; margin-top: 10px; }
        .keyboard-layout { display: none; }
        .keyboard-layout.active { display: grid; }
        #keyboard-mode-buttons { display: flex; gap: 8px; justify-content: center; margin-bottom: 5px; }
        .keyboard-mode-btn { padding: 10px 25px; font-size: 1.1rem; background-color: var(--light-gray-btn); color: #000; }
        body.theme-light .keyboard-mode-btn { color: #fff; }
        .keyboard-mode-btn.active { background-color: var(--green-btn); color: white !important;}

        #katakana-keyboard, #kanji-keyboard { gap: 5px; width: 100%; }
        #katakana-keyboard { grid-template-columns: repeat(11, 1fr); grid-template-rows: repeat(5, 1fr); }
        #kanji-keyboard { grid-template-columns: repeat(10, 1fr); grid-template-rows: repeat(4, 1fr); }
        
        #alphanumeric-keyboard { display: none; flex-direction: column; gap: 5px; }
        #alphanumeric-keyboard.active { display: flex; }
        .keyboard-row { display: grid; gap: 5px; }
        
        .keyboard-btn {
            padding: 10px 5px; font-size: 1rem; background-color: var(--button-bg); color: var(--primary-text-color);
            display: flex; justify-content: center; align-items: center; height: 100%;
        }
        .keyboard-btn[disabled] { opacity: 0.6; pointer-events: none; }
        body.theme-light .keyboard-btn { color: #000; }
        .keyboard-btn-func { background-color: var(--light-gray-btn); color: #000; }
        body.theme-light .keyboard-btn-func { color: #fff; }
        .keyboard-btn-enter { background-color: var(--enter-key-color) !important; color: white !important; }
        #katakana-keyboard .keyboard-btn-enter, #kanji-keyboard .keyboard-btn-enter { grid-row: span 2; }
        
        .keyboard-btn-shift { background-color: var(--light-gray-btn); color: #000; padding: 5px !important; }
        .keyboard-btn-shift svg .arrow { fill: white; stroke: black; stroke-width: 1.5; }
        .keyboard-btn-shift.active { background-color: var(--shift-key-active-color); }
        .keyboard-btn-shift.active svg .arrow { fill: black; stroke: none; }

        .keyboard-row-1 { grid-template-columns: repeat(10, 1fr); }
        .keyboard-row-2 { grid-template-columns: repeat(11, 1fr); padding: 0 4%; }
        .keyboard-row-3 { grid-template-columns: repeat(11, 1fr); padding: 0 8%; }
        .keyboard-row-3 .keyboard-btn[data-key="enter"] { grid-column: span 2; }
        .keyboard-row-4 { grid-template-columns: repeat(10, 1fr); padding: 0 12%; }
        .keyboard-row-4 .keyboard-btn[data-key="clear"] { grid-column: span 2; }

        #genre-container { background-color: rgba(0, 0, 0, 0.2); padding: 15px; border-radius: 15px; margin-top: 1rem; }
        body.theme-light #genre-container { background-color: rgba(0,0,0,0.1); }
        #genre-buttons { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; }
        .genre-btn { position: relative; background-color: var(--light-gray-btn); color: #000; font-size: 0.9rem; padding: 8px 12px; }
        .genre-btn.locked { background-color: #424242; color: #bdbdbd; }
        .lock-icon { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 24px; height: 24px; fill: rgba(255, 255, 255, 0.7); }
        .genre-btn.selected[data-genre="遷移元素"] { background-color: var(--genre-seni); color: white; }
        .genre-btn.selected[data-genre="典型元素"] { background-color: var(--genre-tenkei); color: white; }
        .genre-btn.selected[data-genre="アルカリ金属"] { background-color: var(--genre-alkali); color: white; }
        .genre-btn.selected[data-genre="アルカリ土類金属"] { background-color: var(--genre-alkali-earth); color: #000; }
        .genre-btn.selected[data-genre="ハロゲン"] { background-color: var(--genre-halogen); color: #000; }
        .genre-btn.selected[data-genre="貴ガス"] { background-color: var(--genre-kigasu); color: #000; }
        .genre-btn.selected[data-genre="ランタノイド"] { background-color: var(--genre-lanthanoid); color: #000; }
        .genre-btn.selected[data-genre="アクチノイド"] { background-color: var(--genre-actinoid); color: white; }

        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.7);
            display: none; justify-content: center; align-items: center; z-index: 1000;
        }
        body.theme-light .modal-overlay { background-color: rgba(255, 255, 255, 0.7); }
        .modal-overlay.active { display: flex; }
        .modal-content {
            background-color: var(--bg-color); padding: 30px 40px; border-radius: 15px; border: 1px solid var(--button-bg);
            display: flex; flex-direction: column; min-width: 300px; max-width: 90%; max-height: 90vh; 
        }
        #settings-modal .modal-content { overflow-y: auto; }
        .modal-content > *:not(:last-child) { margin-bottom: 20px; }
        .modal-content.rotated { transform: rotate(180deg); }

        .modal-content h2 { margin-top: 0; font-size: 1.8rem; margin-bottom: 20px; }
        .modal-btn { width: 100%; padding: 15px; font-size: 1.2rem; }
        #retry-btn { background-color: var(--yellow-btn); color: #000; }
        #title-btn, .gray-close-btn, #confirm-no-btn { background-color: var(--light-gray-btn); color: #000; }
        #title-btn { background-color: var(--red-btn); color: white; }
        #title-btn:hover { background-color: var(--red-btn-hover); }
        #results-to-title-btn { background-color: var(--light-gray-btn); color: #000; }
        body.theme-light #title-btn, body.theme-light .gray-close-btn, body.theme-light #confirm-no-btn,
        body.theme-light .genre-btn, body.theme-light .format-btn, body.theme-light .keyboard-btn-func,
        body.theme-light .keyboard-btn-shift, body.theme-light .option-count-btn {
            color: #fff;
        }
        #confirm-yes-btn { background-color: var(--red-btn); }
        .confirmation-buttons { display: flex; gap: 10px; justify-content: center; }
        .setting-item { border-top: 1px solid var(--button-bg); padding-top: 20px; }
        .setting-item h3 { margin-top: 0; margin-bottom: 10px; }
        .setting-value { font-size: 2rem; font-weight: bold; margin-bottom: 15px; }
        .setting-buttons { display: flex; flex-wrap: nowrap; justify-content: center; gap: 4px; overflow-x: auto; padding-bottom: 10px; }
        .setting-buttons .btn { flex-shrink: 0; font-size: 0.8rem; padding: 8px; min-width: 40px; }
        #options-count-buttons { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
        #options-count-buttons .btn { font-size: 1rem; background-color: var(--light-gray-btn); color: #000; }
        #options-count-buttons .btn.active { 
            background-color: var(--enter-key-color);
            color: white !important; 
            box-shadow: 0 0 10px var(--enter-key-color);
        }
        body.theme-light #options-count-buttons .btn { color: #fff; }
        body.theme-light #options-count-buttons .btn.active { color: #000 !important; }
        
        #fictional-elements-btn { background-color: var(--light-gray-btn); color: #000; }
        body.theme-light #fictional-elements-btn { color: #fff; }
        #fictional-elements-btn.active { background-color: var(--enter-key-color); color: white !important; }
        body.theme-light #fictional-elements-btn.active { color: #000 !important; }


        .theme-btn { background-color: var(--light-gray-btn); color: #000; }
        body.theme-light .theme-btn { color: #fff; }
        .theme-btn.active { border: 3px solid #FFF; }
        .theme-btn.active[data-theme="light"] { background-color: #FFEB3B; color: black; }
        .theme-btn.active[data-theme="dark"] { background-color: #3F51B5; color: white; }
        body.theme-light .theme-btn.active { border: 3px solid #000; }
        #results-text { font-size: 1.2rem; }
        .mode-btn-container { display: flex; justify-content: center; gap: 10px; }
        body.theme-dark .mode-btn { color: #000; }
        body.theme-light .mode-btn { color: #fff; }
        #hardcore-mode-btn.hardcore { color: white !important; }
        #survival-section { display: none; }
        #friend-battle-btn { background-color: var(--light-gray-btn); color: #000;}
        body.theme-light #friend-battle-btn { color: #fff; }
        
        .mode-btn.endless { animation: endless-glow 2s infinite; }
        .mode-btn.hardcore { animation: hardcore-glow 2s infinite; }
        .switch { position: relative; display: inline-block; width: 60px; height: 34px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 26px; width: 26px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked+.slider { background-color: var(--green-btn); }
        input:checked+.slider:before { transform: translateX(26px); }
        #interrupt-overlay { flex-direction: column; gap: 20px; color: white; }
        #interrupt-circle { width: 100px; height: 100px; }
        #interrupt-circle-path { fill: none; stroke: var(--red-btn); stroke-width: 10; stroke-linecap: round; transform: rotate(-90deg); transform-origin: 50% 50%; }
        #format-modal .modal-content { max-width: 800px; }
        #format-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
        .format-btn { font-size: 1rem; padding: 15px 10px; background-color: var(--light-gray-btn); color: #000; }
        .format-btn.selected { color: white; }
        #save-formats-btn { background-color: #616161; color: #fff;}

        #genshicho-modal .modal-content { width: 90vw; max-width: 500px; height: 70vh; max-height: 700px; padding: 20px; }
        #genshicho-content { display: grid; grid-template-rows: auto 1fr auto; grid-template-columns: 1fr auto 1fr; position: relative; height: 100%; }
        #genshicho-header { grid-column: 1 / 4; display: flex; justify-content: space-between; align-items: center; font-size: 1.1rem; }
        #genshicho-main { grid-column: 1 / 4; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        #genshicho-footer { grid-column: 1 / 4; display: flex; justify-content: space-between; align-items: center; }
        #genshicho-symbol { font-size: 10rem; font-weight: bold; line-height: 1; }
        #genshicho-name { font-size: 2.5rem; margin-top: 10px; }
        #genshicho-footer .btn { padding: 10px 20px; }
        #genshicho-center-controls { display: flex; gap: 10px; position: absolute; left: 50%; bottom: 20px; transform: translateX(-50%); }
        #genshicho-list-modal .modal-content { max-width: 700px; }
        #genshicho-list-container { flex-grow: 1; overflow-y: auto; }
        .genshicho-list-category { margin-top: 20px; border-top: 2px solid var(--button-bg); padding-top: 10px; }
        .genshicho-list-category h3 { margin: 0 0 15px 0; font-size: 1.5rem; }
        .genshicho-list-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; }
        .genshicho-list-grid .btn { width: 100%; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; padding: 10px; }
        
        #color-selection-modal .modal-content { max-width: 600px; }
        #color-grid { overflow-y: auto; flex-grow: 1; display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }
        .color-btn { font-size: 1rem; padding: 20px; border: 2px solid #fff; white-space: nowrap; }
        .color-btn[disabled] { opacity: 0.3; }
    </style>
</head>
<body class="theme-dark">
    <div class="container">
        <div id="title-screen" class="active">
            <button id="coin-display" class="btn">🪙×5</button>
            <button id="settings-btn" class="icon-btn">
                <svg viewBox="0 0 24 24"><path d="M19.14,12.94c0.04-0.3,0.06-0.61,0.06-0.94c0-0.32-0.02-0.64-0.07-0.94l2.03-1.58c0.18-0.14,0.23-0.41,0.12-0.61 l-1.92-3.32c-0.12-0.22-0.37-0.29-0.59-0.22l-2.39,0.96c-0.5-0.38-1.03-0.7-1.62-0.94L14.4,2.81c-0.04-0.24-0.24-0.41-0.48-0.41 h-3.84c-0.24,0-0.44,0.17-0.48,0.41L9.12,5.22C8.53,5.46,8,5.78,7.5,6.16L5.11,5.2c-0.22-0.08-0.47,0-0.59,0.22L2.6,8.74 c-0.11,0.2-0.06,0.47,0.12,0.61l2.03,1.58C4.7,11.36,4.68,11.68,4.68,12s0.02,0.64,0.07,0.94l-2.03,1.58 c-0.18,0.14-0.23,0.41-0.12,0.61l1.92,3.32c0.12,0.22,0.37,0.29,0.59,0.22l2.39-0.96c0.5,0.38,1.03,0.7,1.62,0.94l0.48,2.41 c0.04,0.24,0.24,0.41,0.48,0.41h3.84c0.24,0,0.44-0.17,0.48-0.41l0.48-2.41c0.59-0.24,1.12-0.56,1.62-0.94l2.39,0.96 c0.22,0.08,0.47,0,0.59-0.22l1.92-3.32c0.11-0.2,0.06-0.47-0.12-0.61L19.14,12.94z M12,15.6c-1.98,0-3.6-1.62-3.6-3.6 s1.62-3.6,3.6-3.6s3.6,1.62,3.6,3.6S13.98,15.6,12,15.6z"></path></svg>
            </button>
            <h1>原子クイズ</h1>
            <div class="range-settings">
                <div class="range-control">
                    <span class="range-label">min</span>
                    <div id="min-value" class="range-value">1</div>
                    <div class="range-buttons"></div>
                </div>
                <div class="range-control">
                    <span class="range-label">Max</span>
                    <div id="max-value" class="range-value">20</div>
                    <div class="range-buttons"></div>
                    <button id="default-range-btn" class="btn">デフォルトの範囲に戻す</button>
                    <button id="expansion-btn" class="btn"></button>
                </div>
            </div>
            <div id="genre-container">
                <div id="genre-buttons"></div>
            </div>
            <div class="title-actions">
                <button id="format-btn" class="btn">形式</button>
                <button id="start-btn" class="btn">スタート</button>
            </div>
        </div>
        <div id="quiz-screen"></div>
    </div>
    <div id="pause-menu" class="modal-overlay"></div>
    <div id="confirmation-popup" class="modal-overlay"></div>
    <div id="settings-modal" class="modal-overlay"></div>
    <div id="coin-info-modal" class="modal-overlay"></div>
    <div id="results-modal" class="modal-overlay"></div>
    <div id="info-popup" class="modal-overlay"></div>
    <div id="unlock-modal" class="modal-overlay"></div>
    <div id="genshicho-modal" class="modal-overlay"></div>
    <div id="genshicho-list-modal" class="modal-overlay"></div>
    <div id="format-modal" class="modal-overlay"></div>
    <div id="interrupt-overlay" class="modal-overlay"></div>
    <div id="color-selection-modal" class="modal-overlay"></div>

    <script>
        const elementData = [{number:1,symbol:"H",name:"水素",period:1,group:1,categories:["典型元素"]},{number:2,symbol:"He",name:"ヘリウム",period:1,group:18,categories:["貴ガス","典型元素"]},{number:3,symbol:"Li",name:"リチウム",period:2,group:1,categories:["アルカリ金属","典型元素"]},{number:4,symbol:"Be",name:"ベリリウム",period:2,group:2,categories:["アルカリ土類金属","典型元素"]},{number:5,symbol:"B",name:"ホウ素",period:2,group:13,categories:["半金属","典型元素"]},{number:6,symbol:"C",name:"炭素",period:2,group:14,categories:["典型元素"]},{number:7,symbol:"N",name:"窒素",period:2,group:15,categories:["典型元素"]},{number:8,symbol:"O",name:"酸素",period:2,group:16,categories:["典型元素"]},{number:9,symbol:"F",name:"フッ素",period:2,group:17,categories:["ハロゲン","典型元素"]},{number:10,symbol:"Ne",name:"ネオン",period:2,group:18,categories:["貴ガス","典型元素"]},{number:11,symbol:"Na",name:"ナトリウム",period:3,group:1,categories:["アルカリ金属","典型元素"]},{number:12,symbol:"Mg",name:"マグネシウム",period:3,group:2,categories:["アルカリ土類金属","典型元素"]},{number:13,symbol:"Al",name:"アルミニウム",period:3,group:13,categories:["典型元素"]},{number:14,symbol:"Si",name:"ケイ素",period:3,group:14,categories:["半金属","典型元素"]},{number:15,symbol:"P",name:"リン",period:3,group:15,categories:["典型元素"]},{number:16,symbol:"S",name:"硫黄",period:3,group:16,categories:["典型元素"]},{number:17,symbol:"Cl",name:"塩素",period:3,group:17,categories:["ハロゲン","典型元素"]},{number:18,symbol:"Ar",name:"アルゴン",period:3,group:18,categories:["貴ガス","典型元素"]},{number:19,symbol:"K",name:"カリウム",period:4,group:1,categories:["アルカリ金属","典型元素"]},{number:20,symbol:"Ca",name:"カルシウム",period:4,group:2,categories:["アルカリ土類金属","典型元素"]},{number:21,symbol:"Sc",name:"スカンジウム",period:4,group:3,categories:["遷移元素"]},{number:22,symbol:"Ti",name:"チタン",period:4,group:4,categories:["遷移元素"]},{number:23,symbol:"V",name:"バナジウム",alias:["ヴァナジウム"],period:4,group:5,categories:["遷移元素"]},{number:24,symbol:"Cr",name:"クロム",period:4,group:6,categories:["遷移元素"]},{number:25,symbol:"Mn",name:"マンガン",period:4,group:7,categories:["遷移元素"]},{number:26,symbol:"Fe",name:"鉄",period:4,group:8,categories:["遷移元素"]},{number:27,symbol:"Co",name:"コバルト",period:4,group:9,categories:["遷移元素"]},{number:28,symbol:"Ni",name:"ニッケル",period:4,group:10,categories:["遷移元素"]},{number:29,symbol:"Cu",name:"銅",period:4,group:11,categories:["遷移元素"]},{number:30,symbol:"Zn",name:"亜鉛",period:4,group:12,categories:["遷移元素"]},{number:31,symbol:"Ga",name:"ガリウム",period:4,group:13,categories:["典型元素"]},{number:32,symbol:"Ge",name:"ゲルマニウム",period:4,group:14,categories:["半金属","典型元素"]},{number:33,symbol:"As",name:"ヒ素",period:4,group:15,categories:["半金属","典型元素"]},{number:34,symbol:"Se",name:"セレン",period:4,group:16,categories:["典型元素"]},{number:35,symbol:"Br",name:"臭素",period:4,group:17,categories:["ハロゲン","典型元素"]},{number:36,symbol:"Kr",name:"クリプトン",period:4,group:18,categories:["貴ガス","典型元素"]},{number:37,symbol:"Rb",name:"ルビジウム",period:5,group:1,categories:["アルカリ金属","典型元素"]},{number:38,symbol:"Sr",name:"ストロンチウム",period:5,group:2,categories:["アルカリ土類金属","典型元素"]},{number:39,symbol:"Y",name:"イットリウム",period:5,group:3,categories:["遷移元素"]},{number:40,symbol:"Zr",name:"ジルコニウム",period:5,group:4,categories:["遷移元素"]},{number:41,symbol:"Nb",name:"ニオブ",period:5,group:5,categories:["遷移元素"]},{number:42,symbol:"Mo",name:"モリブデン",period:5,group:6,categories:["遷移元素"]},{number:43,symbol:"Tc",name:"テクネチウム",period:5,group:7,categories:["遷移元素"]},{number:44,symbol:"Ru",name:"ルテニウム",period:5,group:8,categories:["遷移元素"]},{number:45,symbol:"Rh",name:"ロジウム",period:5,group:9,categories:["遷移元素"]},{number:46,symbol:"Pd",name:"パラジウム",period:5,group:10,categories:["遷移元素"]},{number:47,symbol:"Ag",name:"銀",period:5,group:11,categories:["遷移元素"]},{number:48,symbol:"Cd",name:"カドミウム",period:5,group:12,categories:["遷移元素"]},{number:49,symbol:"In",name:"インジウム",period:5,group:13,categories:["典型元素"]},{number:50,symbol:"Sn",name:"スズ",period:5,group:14,categories:["典型元素"]},{number:51,symbol:"Sb",name:"アンチモン",period:5,group:15,categories:["半金属","典型元素"]},{number:52,symbol:"Te",name:"テルル",period:5,group:16,categories:["半金属","典型元素"]},{number:53,symbol:"I",name:"ヨウ素",period:5,group:17,categories:["ハロゲン","典型元素"]},{number:54,symbol:"Xe",name:"キセノン",period:5,group:18,categories:["貴ガス","典型元素"]},{number:55,symbol:"Cs",name:"セシウム",period:6,group:1,categories:["アルカリ金属","典型元素"]},{number:56,symbol:"Ba",name:"バリウム",period:6,group:2,categories:["アルカリ土類金属","典型元素"]},{number:57,symbol:"La",name:"ランタン",period:6,group:null,categories:["ランタノイド"]},{number:58,symbol:"Ce",name:"セリウム",period:6,group:null,categories:["ランタノイド"]},{number:59,symbol:"Pr",name:"プラセオジム",period:6,group:null,categories:["ランタノイド"]},{number:60,symbol:"Nd",name:"ネオジム",period:6,group:null,categories:["ランタノイド"]},{number:61,symbol:"Pm",name:"プロメチウム",period:6,group:null,categories:["ランタノイド"]},{number:62,symbol:"Sm",name:"サマリウム",period:6,group:null,categories:["ランタノイド"]},{number:63,symbol:"Eu",name:"ユウロピウム",period:6,group:null,categories:["ランタノイド"]},{number:64,symbol:"Gd",name:"ガドリニウム",period:6,group:null,categories:["ランタノイド"]},{number:65,symbol:"Tb",name:"テルビウム",period:6,group:null,categories:["ランタノイド"]},{number:66,symbol:"Dy",name:"ジスプロシウム",period:6,group:null,categories:["ランタノイド"]},{number:67,symbol:"Ho",name:"ホルミウム",period:6,group:null,categories:["ランタノイド"]},{number:68,symbol:"Er",name:"エルビウム",period:6,group:null,categories:["ランタノイド"]},{number:69,symbol:"Tm",name:"ツリウム",period:6,group:null,categories:["ランタノイド"]},{number:70,symbol:"Yb",name:"イッテルビウム",period:6,group:null,categories:["ランタノイド"]},{number:71,symbol:"Lu",name:"ルテチウム",period:6,group:3,categories:["ランタノイド","遷移元素"]},{number:72,symbol:"Hf",name:"ハフニウム",period:6,group:4,categories:["遷移元素"]},{number:73,symbol:"Ta",name:"タンタル",period:6,group:5,categories:["遷移元素"]},{number:74,symbol:"W",name:"タングステン",period:6,group:6,categories:["遷移元素"]},{number:75,symbol:"Re",name:"レニウム",period:6,group:7,categories:["遷移元素"]},{number:76,symbol:"Os",name:"オスミウム",period:6,group:8,categories:["遷移元素"]},{number:77,symbol:"Ir",name:"イリジウム",period:6,group:9,categories:["遷移元素"]},{number:78,symbol:"Pt",name:"白金",alias:["プラチナ"],period:6,group:10,categories:["遷移元素"]},{number:79,symbol:"Au",name:"金",period:6,group:11,categories:["遷移元素"]},{number:80,symbol:"Hg",name:"水銀",period:6,group:12,categories:["遷移元素"]},{number:81,symbol:"Tl",name:"タリウム",period:6,group:13,categories:["典型元素"]},{number:82,symbol:"Pb",name:"鉛",period:6,group:14,categories:["典型元素"]},{number:83,symbol:"Bi",name:"ビスマス",period:6,group:15,categories:["典型元素"]},{number:84,symbol:"Po",name:"ポロニウム",period:6,group:16,categories:["半金属","典型元素"]},{number:85,symbol:"At",name:"アスタチン",period:6,group:17,categories:["ハロゲン","半金属"]},{number:86,symbol:"Rn",name:"ラドン",period:6,group:18,categories:["貴ガス","典型元素"]},{number:87,symbol:"Fr",name:"フランシウム",period:7,group:1,categories:["アルカリ金属","典型元素"]},{number:88,symbol:"Ra",name:"ラジウム",period:7,group:2,categories:["アルカリ土類金属","典型元素"]},{number:89,symbol:"Ac",name:"アクチニウム",period:7,group:null,categories:["アクチノイド"]},{number:90,symbol:"Th",name:"トリウム",period:7,group:null,categories:["アクチノイド"]},{number:91,symbol:"Pa",name:"プロトアクチニウム",period:7,group:null,categories:["アクチノイド"]},{number:92,symbol:"U",name:"ウラン",period:7,group:null,categories:["アクチノイド"]},{number:93,symbol:"Np",name:"ネプツニウム",period:7,group:null,categories:["アクチノイド"]},{number:94,symbol:"Pu",name:"プルトニウム",period:7,group:null,categories:["アクチノイド"]},{number:95,symbol:"Am",name:"アメリシウム",period:7,group:null,categories:["アクチノイド"]},{number:96,symbol:"Cm",name:"キュリウム",period:7,group:null,categories:["アクチノイド"]},{number:97,symbol:"Bk",name:"バークリウム",period:7,group:null,categories:["アクチノイド"]},{number:98,symbol:"Cf",name:"カリホルニウム",period:7,group:null,categories:["アクチノイド"]},{number:99,symbol:"Es",name:"アインスタイニウム",period:7,group:null,categories:["アクチノイド"]},{number:100,symbol:"Fm",name:"フェルミウム",period:7,group:null,categories:["アクチノイド"]},{number:101,symbol:"Md",name:"メンデレビウム",period:7,group:null,categories:["アクチノイド"]},{number:102,symbol:"No",name:"ノーベリウム",period:7,group:null,categories:["アクチノイド"]},{number:103,symbol:"Lr",name:"ローレンシウム",period:7,group:3,categories:["アクチノイド","遷移元素"]},{number:104,symbol:"Rf",name:"ラザホージウム",period:7,group:4,categories:["遷移元素"]},{number:105,symbol:"Db",name:"ドブニウム",period:7,group:5,categories:["遷移元素"]},{number:106,symbol:"Sg",name:"シーボーギウム",period:7,group:6,categories:["遷移元素"]},{number:107,symbol:"Bh",name:"ボーリウム",period:7,group:7,categories:["遷移元素"]},{number:108,symbol:"Hs",name:"ハッシウム",period:7,group:8,categories:["遷移元素"]},{number:109,symbol:"Mt",name:"マイトネリウム",period:7,group:9,categories:["遷移元素"]},{number:110,symbol:"Ds",name:"ダームスタチウム",period:7,group:10,categories:["遷移元素"]},{number:111,symbol:"Rg",name:"レントゲニウム",period:7,group:11,categories:["遷移元素"]},{number:112,symbol:"Cn",name:"コペルニシウム",period:7,group:12,categories:["遷移元素"]},{number:113,symbol:"Nh",name:"ニホニウム",period:7,group:13,categories:["典型元素"]},{number:114,symbol:"Fl",name:"フレロビウム",period:7,group:14,categories:["典型元素"]},{number:115,symbol:"Mc",name:"モスコビウム",period:7,group:15,categories:["典型元素"]},{number:116,symbol:"Lv",name:"リバモリウム",period:7,group:16,categories:["典型元素"]},{number:117,symbol:"Ts",name:"テネシン",period:7,group:17,categories:["ハロゲン","典型元素"]},{number:118,symbol:"Og",name:"オガネソン",period:7,group:18,categories:["貴ガス","典型元素"]}];
        const expansionTiers = [{limit:36,cost:5},{limit:54,cost:5},{limit:71,cost:7},{limit:103,cost:10},{limit:118,cost:15}];
        const formatPeriodGroup=(el)=>`${el.period}周期`+(el.group!==null?`${el.group}族`:'');
        const quizFormats={'number_to_name':{text:'原子番号→元素名',getQuestionText:el=>`原子番号: ${el.number}`,getOptionText:el=>el.name,answerType:"元素名",color:'var(--format-color-1)'},'number_to_symbol':{text:'原子番号→元素記号',getQuestionText:el=>`原子番号: ${el.number}`,getOptionText:el=>el.symbol,answerType:"元素記号",color:'var(--format-color-2)'},'number_to_period_group':{text:'原子番号→周期・族',getQuestionText:el=>`原子番号: ${el.number}`,getOptionText:el=>formatPeriodGroup(el),answerType:"周期・族",color:'var(--format-color-3)'},'symbol_to_number':{text:'元素記号→原子番号',getQuestionText:el=>`元素記号: ${el.symbol}`,getOptionText:el=>el.number,answerType:"原子番号",color:'var(--format-color-4)'},'symbol_to_name':{text:'元素記号→元素名',getQuestionText:el=>`元素記号: ${el.symbol}`,getOptionText:el=>el.name,answerType:"元素名",color:'var(--format-color-5)'},'symbol_to_period_group':{text:'元素記号→周期・族',getQuestionText:el=>`元素記号: ${el.symbol}`,getOptionText:el=>formatPeriodGroup(el),answerType:"周期・族",color:'var(--format-color-6)'},'name_to_number':{text:'元素名→原子番号',getQuestionText:el=>`元素名: ${el.name}`,getOptionText:el=>el.number,answerType:"原子番号",color:'var(--format-color-7)'},'name_to_symbol':{text:'元素名→元素記号',getQuestionText:el=>`元素名: ${el.name}`,getOptionText:el=>el.symbol,answerType:"元素記号",color:'var(--format-color-8)'},'name_to_period_group':{text:'元素名→周期・族',getQuestionText:el=>`元素名: ${el.name}`,getOptionText:el=>formatPeriodGroup(el),answerType:"周期・族",color:'var(--format-color-9)'},'period_group_to_number':{text:'周期・族→原子番号',getQuestionText:el=>formatPeriodGroup(el),getOptionText:el=>el.number,answerType:"原子番号",color:'var(--format-color-10)'},'period_group_to_symbol':{text:'周期・族→元素記号',getQuestionText:el=>formatPeriodGroup(el),getOptionText:el=>el.symbol,answerType:"元素記号",color:'var(--format-color-11)'},'period_group_to_name':{text:'周期・族→元素名',getQuestionText:el=>formatPeriodGroup(el),getOptionText:el=>el.name,answerType:"元素名",color:'var(--format-color-12)'}};
        const trueKanji="水 素 炭 窒 酸 硫 黄 塩 白 金 銀 鉛 鉄 銅 亜 臭 周 期 族".split(" ");
        const falseKanji="嵐 霞 霧 雷 虹 滝 潮 岳 砂 嶺 森 樹 炎 震 霜 雫 渓 峰 宙 暁 露 雲 嵩 鋼 銃 鎖 鎧 磁 機 弾 電 圧 炉 鋭 構 械 爆 壊 導 線 管 蒸 駆 燃 鋳 閃 魔 幻 呪 封 霊 魂 闇 詠 陣 召 翼 契 紋 冥 祈 儀 咎 戒 祓 黎 煌 理 論 究 析 測 検 数 質 量 密 実 験 証 粒 体 融 計 演 算 統 龍 麗 耀 顕 瞬 鏡 繚 環 覇 斬 殲 誓 滅 創 聖 絶 鎮 籠 斎 禍 火 木 愛 減 英 石 改 食 目 〆 鹵 巫 腑 覡 見 据 風 土 星 肺 胃 腸 大 小 中 央 怏 第 笑 膵 翠 藍 魚 鮭 鱒 鮎 鱫 鯛 魯 鮮 鯵 鯖 鮫 鮨 鮟 鱇 顰 蹙 齟 齬 王 蟲 鸚 鵡 暗 澹 烙 印 曖 昧 模 糊 演 繹 厭 闊 達 紺 碧 慟 哭 輪 廻 懺 悔 招 聘 敏 捷 冒 涜 瀆 膠 陥 罝 敷 衍 峡 岩 崖 浜 礫 瀬 岬 湾 丘 平 原 畔 堤 淵 谷 峠 亀 虎 狼 熊 鹿 狐 馬 牛 象 猫 犬 鷲 鷹 鴨 鵜 燕 雀 獅 猿 狸 鼬 桜 松 杉 梅 竹 菊 蓮 萩 柊 蘭 葛 蔦 杏 茗 芽 蔓 苗 玉 晶 瑪 瑠 珀 琥 硝 巖 箱 杯 膳 釜 鍋 匙 櫃 杖 桶 簪 帚 灯 庵 庁 堂 亭 楼 蔵 舎 塀 塚 塔 碑 宿 肌 声 唇 爪 眉 胆 志 性 意 悟 慧 夢 想 憧 憶 覚 喜 怒 哀 楽 憤 懐 嘆 慕 誇 菜 果 豆 麺 粥 粟 醸 釉 袴 裳 襟 袂 帯 緒 佩 履 巾 着 舟 帆 舵 橇 轍 輿 鈴 駕 舶 舷 笛 琴 弦 鼓 拍 謡 唱 節 旋 碁 棋 将 戯 抒 投 射 打 蹴 医 匠 司 裁 匿 旅 牧 伐 鍛 彫 刻 織 編 調 錬 砥 漆 染 栗 梨 柑 檀 椰 椿 榎 桑 柚 鳩 鷺 潜 暦 旬 歳 朔 望 晩 朧 季 厘 釐 匁 卯 酉 午 辰 沿 岸 沖 際 端 境 律 章 鑑 典 徽 盟 徴 位 層 格 域 父 母 祖 孫 兄 弟 姉 妹 伯 叔 嫁 婿 子 嫡 員 師 長 部 係 官 署 局 会 議 属 職 務 監 執 参 顧 歩 跳 走 泳 舞 翔 飛 滞 流 増 侵 退 抜 補 維 続 情 慈 恨 悲 憎 穏 温 狡 勇 臆 忍 慎 堅 柔 法 令 判 訴 裁 刑 例 条 規 制 憲 権 商 貿 資 財 債 価 費 益 売 買 市 帳 税 融 備 療 診 処 治 抗 剤 病 傷 癌 癒 授 試 単 範 伝 送 接 網 版 塁 桁 梁 階 廊 床 舗 耕 牧 漁 標 畑 田 圃 果 園 栽 蜂 蝶 蚊 蟻 蜘蛛 蝸 犀 蝙 蝟 朱 紅 褐 蒼 鈍 秒 分 時 期 巻 詩 篇 撰 記 編 訳 校 評 酒 酢 酪 菓 漬 腐 燻 旨 競 駆 剣 拳 祭 禊 盆 縁 架 骨 構 柱 組 継 都 府 県 区 界 誠 忠 義 礼 信 責 鯉 鰹 鰻 鱈 鰈 鰤 鱚 鱸 鯔 鯨 鰍 鰆 貝 牡 蠣 海 老 帆 立 鰊 鳳 麟 彁 妛 墸 壥 垈 國 嶋 櫻 樂 學 覺 會 鶴 巖 禽 橫".split(/ |\u3000/);
        const fictionalElements=[{name:"アークニウム",symbol:"Aa"},{name:"ヴォルニウム",symbol:"Vo"},{name:"ノクスニウム",symbol:"Nk"},{name:"ゼファニウム",symbol:"Ze"},{name:"ストラニウム",symbol:"Su"},{name:"カレニウム",symbol:"Ka"},{name:"ファントニウム",symbol:"Fa"},{name:"ヴェイルニウム",symbol:"Ve"},{name:"ルインジウム",symbol:"Ri"},{name:"シャドジウム",symbol:"Sh"},{name:"ブレイズジウム",symbol:"Bu"},{name:"ヴォイドジウム",symbol:"Vi"},{name:"ノクティジウム",symbol:"Nu"},{name:"アルケジウム",symbol:"Ak"},{name:"ゼルジウム",symbol:"Zu"},{name:"ノクティシウム",symbol:"Nt"},{name:"ムーンシウム",symbol:"Mm"},{name:"アッシュシウム",symbol:"Ah"},{name:"グリモシウム",symbol:"Gm"},{name:"ルナシウム",symbol:"Ln"},{name:"ベイルシウム",symbol:"Bl"},{name:"フェインシウム",symbol:"Fn"},{name:"シェイドシウム",symbol:"Sd"},{name:"ノクスン",symbol:"Nx"},{name:"レヴァン",symbol:"Le"},{name:"シャドン",symbol:"So"},{name:"グリムン",symbol:"Gn"},{name:"カルヴァン",symbol:"Kv"},{name:"ヴォルン",symbol:"Vn"},{name:"ルミン",symbol:"Rm"},{name:"ゼルヴァン",symbol:"Zv"},{name:"クロノン",symbol:"Ch"},{name:"エーテロン",symbol:"Et"},{name:"ネクサオン",symbol:"Xa"},{name:"ヴァルオン",symbol:"Va"},{name:"セレオン",symbol:"Sl"},{name:"ルミオン",symbol:"Ro"},{name:"アクシオン",symbol:"Ax"},{name:"ゼトロン",symbol:"Zt"},{name:"アストリウム",symbol:"Ao"},{name:"クオンリウム",symbol:"Kn"},{name:"ヴィリリウム",symbol:"Vu"},{name:"メメントリウム",symbol:"Me"},{name:"ノクタリウム",symbol:"Nr"},{name:"サンクリウム",symbol:"Sk"},{name:"ルシリウム",symbol:"Rr"},{name:"オルディリウム",symbol:"Or"},{name:"エグザウム",symbol:"Eg"},{name:"プリズウム",symbol:"Pi"},{name:"ネクサウム",symbol:"Nm"},{name:"ノルウム",symbol:"Nl"},{name:"ヴェルウム",symbol:"Vl"},{name:"ドレウム",symbol:"Do"},{name:"シェルウム",symbol:"Sx"},{name:"ファントウム",symbol:"Ph"}];
        let state={min:1,max:20,defaultMin:1,defaultMax:20,unlockedMaxLimit:20,quizLength:10,numberOfOptions:12,questions:[],currentQuestionIndex:0,correctAnswers:0,confirmAction:null,coins:5,fibonacciBonusClaimed:false,twoPowerBonusClaimed:false,genshichoCurrentIndex:0,modalZIndex:1000,selectedGenres:[],unlockedGenres:[],selectedFormats:['number_to_name'],formatColorInterval:null,currentQuizFormat:null,longPressTimer:null,isLongPress:false,pressAnimation:null,timeLimitEnabled:false,timeLimit:10,quizTimer:null,interruptTimer:null,survivalMode:false,endlessMode:false,hardcoreMode:false,inputMode:false,friendBattleMode:false,fictionalElementsEnabled:false,lives:3,theme:'dark',keyboardMode:'katakana',isShiftOn:false,players:[],currentPlayerIndex:0,turnCount:1,targetGenre:null};
        let tempSettings={};
        const showModal=(id)=>{document.body.classList.add('modal-open');const modal=document.getElementById(id);if(modal){state.modalZIndex++;modal.style.zIndex=state.modalZIndex;modal.classList.add('active');}};
        const hideModal=(modalOrId)=>{const modal=typeof modalOrId==='string'?document.getElementById(modalOrId):modalOrId;if(modal){modal.classList.remove('active');}const anyModalActive=document.querySelector('.modal-overlay.active');if(!anyModalActive){document.body.classList.remove('modal-open');}};
        const updateCoinDisplay=()=>{document.getElementById('coin-display').textContent=`🪙×${state.coins}`;};
        const updateRangeDisplay=()=>{document.getElementById('min-value').textContent=state.min;document.getElementById('max-value').textContent=state.max;};
        const showInfoPopup=(title,text)=>{document.getElementById('info-popup').querySelector('h2').textContent=title;document.getElementById('info-popup').querySelector('p').textContent=text;showModal('info-popup');};
        const showConfirmation=(title,text,action)=>{document.getElementById('confirmation-popup').querySelector('h2').textContent=title;document.getElementById('confirmation-popup').querySelector('p').textContent=text;state.confirmAction=action;showModal('confirmation-popup');};
        const showTitleScreen=()=>{document.getElementById('title-screen').classList.add('active');document.getElementById('quiz-screen').classList.remove('active');document.querySelector('.container').classList.remove('rotated');document.querySelectorAll('.modal-overlay').forEach(hideModal);clearInterval(state.quizTimer);clearTimeout(state.interruptTimer);document.body.classList.remove('modal-open');};
        const applyTheme=(newTheme,isPreview)=>{const body=document.body;if(!isPreview){document.querySelectorAll('body, .btn, .icon-btn svg, .modal-content, .range-settings, #genre-container, #answer-input').forEach(el=>el.classList.add('theme-transition'));}if(newTheme==='light'){body.classList.add('theme-light');body.classList.remove('theme-dark');}else{body.classList.add('theme-dark');body.classList.remove('theme-light');}if(!isPreview){state.theme=newTheme;setTimeout(()=>{document.querySelectorAll('.theme-transition').forEach(el=>el.classList.remove('theme-transition'));},5000);}};
        const updateExpansionButton=()=>{const btn=document.getElementById('expansion-btn');if(!btn)return;if(state.unlockedMaxLimit>=118){btn.textContent='原子帳';btn.classList.add('genshicho');}else{const nextTier=expansionTiers.find(t=>t.limit>state.unlockedMaxLimit);if(nextTier){btn.textContent=`範囲上限up (🪙×${nextTier.cost})`;btn.classList.remove('genshicho');}}};
        const updateFormatButtonColor=()=>{const btn=document.getElementById('format-btn');clearInterval(state.formatColorInterval);const selectedColors=state.selectedFormats.map(f=>quizFormats[f].color);if(selectedColors.length===1){btn.style.backgroundColor=selectedColors[0];}else if(selectedColors.length>1){let colorIndex=0;btn.style.backgroundColor=selectedColors[colorIndex];state.formatColorInterval=setInterval(()=>{colorIndex=(colorIndex+1)%selectedColors.length;btn.style.backgroundColor=selectedColors[colorIndex];},1000);}else{btn.style.backgroundColor='var(--gray-btn)';}};
        const adjustRange=(target,value)=>{if(target==='min'){state.min=Math.max(1,Math.min(state.max-1,state.min+value));}else if(target==='Max'){state.max=Math.min(state.unlockedMaxLimit,Math.max(state.min+1,state.max+value));}updateRangeDisplay();};
        const updateQuizInfo=()=>{const normalStats=document.getElementById('normal-stats');const battleStats=document.getElementById('battle-stats');const heartSVG=(color)=>`<svg viewBox="0 0 24 24" width="24" height="24" style="fill:${color}; vertical-align: middle;"><path class="heart-path" d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"></path></svg>`;if(state.friendBattleMode){normalStats.style.display='none';battleStats.style.display='block';const p1=state.players[0];const p2=state.players[1];const colorHex={'赤':'#dc3545','朱':'#EB6101','林檎':'#d9333f','緋':'#D3381C','スカーレット':'#FF2400','ルビー':'#E0115F','ガーネット':'#733635','ワインレッド':'#722F37','バーガンディ':'#800020','黄':'#ffc107','檸檬':'#FFF44F','カーキー':'#F0E68C','ベージュ':'#eedcb3','バフ':'#F0DC82','マスタード':'#FFDB58','バナナ':'#FFE135','トパーズ':'#FFC87C','向日葵':'#FFDA03','ブロンド':'#f2d58a','ハニー':'#FFC30B','アンバー':'#FFBF00','ゴールド':'#FFD700','黄土':'#c39143','キャメル':'#C19A6B','緑':'#28a745','ミントブルー':'#AAF0D1','ミント':'#9CFCCF','オパール':'#A8C3BC','ペリドット':'#B4C424','エメラルド':'#50C878','青林檎':'#8DB600','若草':'#7BA23F','翡翠':'#3F9877','モスグリーン':'#8A9A5B','鶯':'#928c36','シーグリーン':'#2E8B57','ジェイド':'#00A86B','オリーブ':'#808000','深緑':'#0A2F23','ダークグリーン':'#006400','フォレストグリーン':'#228B22','ハンターグリーン':'#355E3B','ブリティッシュレーシンググリーン':'#004225','ボトルグリーン':'#006A4E','ダークオリーブ':'#556B2F','オリーブドラブ':'#6B8E23','パイングリーン':'#01796F','エバーグリーン':'#05472A','ブランズウィックグリーン':'#1B4D3E','マラカイト':'#046A38','ビリジアン':'#40826D','天鵞城':'#2F5D50','緑黒':'#032B2B','新檜皮':'#123B2B','ジュニパー':'#154734','フォーンダーク':'#20382E','フォレストナイト':'#062E23','青':'#007bff','水':'#17a2b8','空':'#87CEEB','トルマリン':'#7C9ED9','群青':'#4C6CB3','スチールブルー':'#4682B4','セルリアンブルー':'#007BA7','ティール':'#008080','デニム':'#1560BD','インディペンデンス':'#4C516D','サファイア':'#0F52BA','コバルト':'#0047AB','宇宙':'#1D2951','闇夜':'#003366','プルシアン':'#003153','インペリアルブルー':'#002395','アドミラルブルー':'#0D2B45','深夜':'#191970','呉須':'#0014A8','ブルーブラック':'#101F30','オックスフォードブルー':'#002147','ネイビー':'#000080','ダークネイビー':'#00053a','紫':'#6f42c1','ラベンダー':'#E6E6FA','モーブ':'#E0B0FF','梅':'#DDA0DD','ヘリオトロープ':'#DF73FF','オーキッド':'#DA70D6','紫灰':'#A593A5','アメジスト':'#9966CC','バイオレット':'#714f9d','グレープ':'#6F2DA8','桃':'#e83e8c','コーラルピンク':'#FF7F50','サーモン':'#FA8072','ローズ':'#e83f5f','チェリーピンク':'#DE3163','マゼンタ':'#e4007f','茶':'#8B4513','タン':'#D2B48C','淡モカ':'#BEA493','ブロンズ':'#CD7F32','茶褐色':'#664C28','暗モカ':'#6D3B07','セピア':'#704214','モカ':'#3B2F2F','黒':'#343a40','チャコール':'#36454F','アイボリーブラック':'#333132','灰':'#6c757d','プラチナ':'#E5E4E2','シルバー':'#C0C0C0','白':'#f8f9fa','アイボリー':'#FFFFF0','クリーム':'#FFFDD0','シャンパン':'#F7E7CE'};document.getElementById('turn-counter').innerHTML=`T ${state.turnCount}/${state.endlessMode ? '∞' : state.quizLength}`;document.getElementById('player1-stats').innerHTML=`<span>${p1.color}: ${p1.score}</span><span>${heartSVG(colorHex[p1.color]||'#dc3545')}×${p1.lives}</span>`;document.getElementById('player2-stats').innerHTML=`<span>${p2.color}: ${p2.score}</span><span>${heartSVG(colorHex[p2.color]||'#dc3545')}×${p2.lives}</span>`;}else{normalStats.style.display='block';battleStats.style.display='none';document.getElementById('turn-indicator').textContent='';document.getElementById('question-counter').textContent=`Q ${state.currentQuestionIndex+1}/${state.endlessMode?'∞':state.quizLength}`;document.getElementById('score-display').textContent=`Score: ${state.correctAnswers}`;document.getElementById('lives-display').style.display=state.survivalMode?'block':'none';document.getElementById('lives-display').innerHTML=`${heartSVG('#dc3545')}×${state.lives}`;}};
        const startQuiz=()=>{if(state.friendBattleMode){startFriendBattleSetup();return;}let availableElements=elementData.filter(el=>{const inRange=el.number>=state.min&&el.number<=state.max;if(!inRange)return false;if(state.selectedGenres.length===0)return true;return state.selectedGenres.some(genre=>el.categories.includes(genre));});if(availableElements.length<1){showInfoPopup("エラー",`選択された範囲・ジャンルに該当する原子がありません。`);return;}state.questions=Array.from({length:state.quizLength},()=>availableElements[Math.floor(Math.random()*availableElements.length)].number);state.currentQuestionIndex=0;state.correctAnswers=0;state.lives=(state.survivalMode&&state.endlessMode)?1:3;const formatKey=state.selectedFormats[Math.floor(Math.random()*state.selectedFormats.length)];state.currentQuizFormat=quizFormats[formatKey];document.getElementById('title-screen').classList.remove('active');document.getElementById('quiz-screen').classList.add('active');updateQuizInfo();loadQuestion(true);};
        const generateKanjiKeyboard=()=>{const grid=document.getElementById('kanji-keyboard');grid.innerHTML='';const shuffledFalseKanji=[...falseKanji].sort(()=>0.5-Math.random());const selectedFalseKanji=shuffledFalseKanji.slice(0,17);const keyboardChars=[...trueKanji,...selectedFalseKanji].sort(()=>0.5-Math.random());for(let i=0;i<36;i++){const btn=document.createElement('button');btn.className='btn keyboard-btn';btn.textContent=keyboardChars[i];btn.dataset.key=keyboardChars[i];btn.style.gridColumn=`${(i%9)+1}`;btn.style.gridRow=`${Math.floor(i/9)+1}`;grid.appendChild(btn);}const funcs={'backspace':{label:'←',row:'1'},'clear':{label:'clear',row:'2'},'enter':{label:'enter',row:'3 / span 2'},};for(const[key,{label,row}]of Object.entries(funcs)){const btn=document.createElement('button');btn.className='btn keyboard-btn';btn.classList.add(key==='enter'?'keyboard-btn-enter':'keyboard-btn-func');btn.textContent=label;btn.dataset.key=key;btn.style.gridColumn='10';btn.style.gridRow=row;grid.appendChild(btn);}};
        const loadQuestion=(isNewQuiz=false)=>{clearInterval(state.quizTimer);if((!state.friendBattleMode&&!state.endlessMode&&state.currentQuestionIndex>=state.quizLength)||(state.survivalMode&&!state.friendBattleMode&&state.lives<=0)){endQuiz();return;}if(state.friendBattleMode&&!state.endlessMode&&state.turnCount>state.quizLength){endQuiz();return;}updateQuizInfo();if(state.inputMode&&isNewQuiz){generateKanjiKeyboard();}document.getElementById('pause-btn').style.display=state.timeLimitEnabled?'none':'block';document.getElementById('interrupt-btn').style.display=state.timeLimitEnabled?'block':'none';const timerDisplay=document.getElementById('timer-display');if(state.timeLimitEnabled){let timeLeft=state.timeLimit;timerDisplay.textContent=`${timeLeft}s`;timerDisplay.style.display='block';state.quizTimer=setInterval(()=>{timeLeft--;timerDisplay.textContent=`${timeLeft}s`;if(timeLeft<=0){clearInterval(state.quizTimer);checkAnswer(null);}},1000);}else{timerDisplay.style.display='none';}const optionsGrid=document.getElementById('options-grid');const customKeyboard=document.getElementById('custom-keyboard');const inputContainer=document.getElementById('input-container');optionsGrid.innerHTML='';if(state.endlessMode&&!state.friendBattleMode){let availableElements=elementData.filter(el=>{const inRange=el.number>=state.min&&el.number<=state.max;if(!inRange)return false;if(state.selectedGenres.length===0)return true;return state.selectedGenres.some(genre=>el.categories.includes(genre));});state.questions[state.currentQuestionIndex]=availableElements[Math.floor(Math.random()*availableElements.length)].number;}const format=state.currentQuizFormat;const currentAtomicNumber=state.questions[state.currentQuestionIndex];const correctAnswerElement=elementData.find(el=>el.number===currentAtomicNumber);if(state.friendBattleMode){document.getElementById('turn-indicator').textContent=`${state.players[state.currentPlayerIndex].color}のターン`;}document.getElementById('question-text').textContent=format.getQuestionText(correctAnswerElement);if(state.inputMode){inputContainer.style.display='block';customKeyboard.style.display='flex';optionsGrid.style.display='none';document.getElementById('answer-input').value='';document.getElementById('answer-input').readOnly=true;let exampleText='';switch(format.answerType){case"元素名":exampleText='水素';break;case"原子番号":exampleText='1';break;case"元素記号":exampleText='H';break;case"周期・族":exampleText='1周期1族';break;}document.getElementById('input-helper').textContent=`解答例: ${exampleText} (${format.answerType}で答えよ)`;}else{inputContainer.style.display='none';customKeyboard.style.display='none';optionsGrid.style.display='grid';document.getElementById('answer-input').readOnly=false;const correctAnswerText=format.getOptionText(correctAnswerElement).toString();let optionsSet=new Set([correctAnswerText]);let elementPool=elementData.filter(el=>{const inRange=el.number>=state.min&&el.number<=state.max;if(!inRange)return false;if(state.selectedGenres.length===0)return true;return state.selectedGenres.some(genre=>el.categories.includes(genre));});if(elementPool.length===0)elementPool=[...elementData];let incorrectOptionsPool=[...new Set(elementPool.map(el=>format.getOptionText(el).toString()))].filter(text=>text!==correctAnswerText);if(state.fictionalElementsEnabled&&(format.answerType==='元素名'||format.answerType==='元素記号')){const fictionalCount=Math.floor(state.numberOfOptions/4);const shuffledFictional=fictionalElements.sort(()=>0.5-Math.random());for(let i=0;i<fictionalCount&&optionsSet.size<state.numberOfOptions;i++){optionsSet.add(format.answerType==='元素名'?shuffledFictional[i].name:shuffledFictional[i].symbol);}}while(optionsSet.size<state.numberOfOptions&&incorrectOptionsPool.length>0){const randomIndex=Math.floor(Math.random()*incorrectOptionsPool.length);optionsSet.add(incorrectOptionsPool.splice(randomIndex,1)[0]);}while(optionsSet.size<state.numberOfOptions){const randomElement=elementData[Math.floor(Math.random()*elementData.length)];optionsSet.add(format.getOptionText(randomElement).toString());}const shuffledOptions=Array.from(optionsSet).sort(()=>Math.random()-0.5);optionsGrid.style.gridTemplateColumns=(state.numberOfOptions<=8)?'repeat(2, 1fr)':'repeat(4, 1fr)';shuffledOptions.forEach(optionText=>{const button=document.createElement('button');button.textContent=optionText;button.classList.add('btn','option-btn');button.addEventListener('click',()=>checkAnswer(button));optionsGrid.appendChild(button);});}};
        const checkAnswer=(element=null)=>{if(state.inputMode && state.keyboardMode === 'kanji'){generateKanjiKeyboard();}const correctAnswerElement=elementData.find(el=>el.number===state.questions[state.currentQuestionIndex]);let correctAnswerText=state.currentQuizFormat.getOptionText(correctAnswerElement).toString();if(state.currentQuizFormat.answerType==="周期・族"){correctAnswerText=correctAnswerText.replace(/\s/g,'');}let isCorrect=false;if(state.inputMode){const userInput=document.getElementById('answer-input').value.trim();isCorrect=userInput.toLowerCase()===correctAnswerText.toLowerCase();if(!isCorrect&&state.currentQuizFormat.answerType==='元素名'&&correctAnswerElement.alias){isCorrect=correctAnswerElement.alias.some(a=>userInput.toLowerCase()===a.toLowerCase());}}else if(element){isCorrect=element.textContent===correctAnswerText;}clearInterval(state.quizTimer);document.getElementById('interrupt-btn').disabled=true;if(state.inputMode){document.querySelectorAll('#custom-keyboard button').forEach(btn=>btn.disabled=true);}if(!isCorrect){if(state.hardcoreMode){endQuiz(true);return;}if(state.survivalMode){if(state.friendBattleMode){state.players[state.currentPlayerIndex].lives--;if(state.players[state.currentPlayerIndex].lives<=0){endQuiz(true);return;}}else{state.lives--;if(state.lives<=0){endQuiz(true);return;}}}}else{if(state.friendBattleMode){state.players[state.currentPlayerIndex].score++;}else{state.correctAnswers++;}}updateQuizInfo();if(state.inputMode){const answerInput=document.getElementById('answer-input');answerInput.style.backgroundColor=isCorrect?'var(--correct-color)':'var(--incorrect-color)';}else{Array.from(document.getElementById('options-grid').children).forEach(btn=>{btn.disabled=true;if(btn.textContent===correctAnswerText)btn.classList.add('correct');else btn.classList.add('faded');});if(!isCorrect&&element){element.classList.remove('faded');element.classList.add('incorrect');}}setTimeout(()=>{if(state.friendBattleMode){state.currentPlayerIndex=(state.currentPlayerIndex+1)%2;if(state.currentPlayerIndex===0){state.turnCount++;}document.querySelector('.container').classList.toggle('rotated',state.currentPlayerIndex===1);let availableElements=elementData.filter(el=>{const inRange=el.number>=state.min&&el.number<=state.max;if(!inRange)return false;if(state.selectedGenres.length===0)return true;return state.selectedGenres.some(genre=>el.categories.includes(genre));});state.questions[state.currentQuestionIndex]=availableElements[Math.floor(Math.random()*availableElements.length)].number;}else{state.currentQuestionIndex++;}document.getElementById('interrupt-btn').disabled=false;if(state.inputMode){document.getElementById('answer-input').style.backgroundColor='var(--bg-color)';document.querySelectorAll('#custom-keyboard button').forEach(btn=>btn.disabled=false);}loadQuestion();},1500);};
        const endQuiz=(isGameOver=false)=>{clearInterval(state.quizTimer);let resultMessage=isGameOver?(state.friendBattleMode?"勝負あり！":"ゲームオーバー！"):"終了！";let detailMessage;if(state.friendBattleMode){const p1=state.players[0];const p2=state.players[1];if(isGameOver){const winner=p1.lives>0?p1:p2;const loser=p1.lives<=0?p1:p2;detailMessage=`${loser.color}のライフが0になったため、${winner.color}の勝ち！`;}else{const p1Points=p1.score+(p1.lives*2);const p2Points=p2.score+(p2.lives*2);if(p1Points>p2Points){detailMessage=`${p1.color}の勝ち！ (${p1Points}pt vs ${p2Points}pt)`;}else if(p2Points>p1Points){detailMessage=`${p2.color}の勝ち！ (${p1Points}pt vs ${p2Points}pt)`;}else{detailMessage=`引き分け！ (${p1Points}pt vs ${p2Points}pt)`;}}}else{let earnedCoins=0;if(state.hardcoreMode&&!isGameOver){earnedCoins=Math.floor(state.correctAnswers/2);}else if(isGameOver&&state.hardcoreMode){earnedCoins=0;}else if(state.survivalMode&&state.endlessMode){earnedCoins=Math.floor(state.correctAnswers/2*(state.correctAnswers/3));}else if(state.survivalMode){earnedCoins=Math.floor(state.correctAnswers/2)+state.lives;}else{earnedCoins=Math.floor(state.correctAnswers/2);}state.coins+=earnedCoins;updateCoinDisplay();detailMessage=`コインを${earnedCoins}枚獲得しました！`;}document.getElementById('results-modal').querySelector('h2').textContent=resultMessage;document.getElementById('results-modal').querySelector('p').textContent=detailMessage;showModal('results-modal');};
        const showGenshicho=(atomicNumber)=>{state.genshichoCurrentIndex=atomicNumber-1;const el=elementData[state.genshichoCurrentIndex];if(!el)return;document.getElementById('genshicho-number').textContent=`原子番号${el.number}`;document.getElementById('genshicho-category').textContent=el.categories.join('・');let periodGroup=`${el.period}周期`;if(el.group!==null)periodGroup+=` ${el.group}族`;document.getElementById('genshicho-period-group').textContent=periodGroup;document.getElementById('genshicho-symbol').textContent=el.symbol;document.getElementById('genshicho-name').textContent=el.name;showModal('genshicho-modal');};
        const showGenshichoList=()=>{const container=document.getElementById('genshicho-list-modal').querySelector('#genshicho-list-container');container.innerHTML='';const categories=[{name:'全元素',filter:()=>true},{name:'遷移元素',filter:el=>el.categories.includes('遷移元素')},{name:'典型元素',filter:el=>el.categories.includes('典型元素')},{name:'アルカリ金属',filter:el=>el.categories.includes('アルカリ金属')},{name:'アルカリ土類金属',filter:el=>el.categories.includes('アルカリ土類金属')},{name:'ハロゲン',filter:el=>el.categories.includes('ハロゲン')},{name:'貴ガス',filter:el=>el.categories.includes('貴ガス')},{name:'半金属',filter:el=>el.categories.includes('半金属')},{name:'ランタノイド',filter:el=>el.categories.includes('ランタノイド')},{name:'アクチノイド',filter:el=>el.categories.includes('アクチノイド')}];categories.forEach(cat=>{const section=document.createElement('div');section.className='genshicho-list-category';section.innerHTML=`<h3>---${cat.name}---</h3>`;const grid=document.createElement('div');grid.className='genshicho-list-grid';elementData.filter(cat.filter).forEach(el=>{const btn=document.createElement('button');btn.className='btn range-btn';btn.textContent=`${el.number} ${el.name}`;btn.addEventListener('click',()=>{hideModal('genshicho-list-modal');showGenshicho(el.number);});grid.appendChild(btn);});section.appendChild(grid);container.appendChild(section);});showModal('genshicho-list-modal');};
        const handleSettingsClick=()=>{tempSettings={quizLength:state.quizLength,numberOfOptions:state.numberOfOptions,timeLimitEnabled:state.timeLimitEnabled,timeLimit:state.timeLimit,survivalMode:state.survivalMode,hardcoreMode:state.hardcoreMode,inputMode:state.inputMode,endlessMode:state.endlessMode,friendBattleMode:state.friendBattleMode,fictionalElementsEnabled:state.fictionalElementsEnabled,theme:state.theme};document.getElementById('settings-modal').querySelector('#quiz-length-display').textContent=tempSettings.quizLength;document.getElementById('time-limit-display').textContent=`${tempSettings.timeLimit}s`;document.getElementById('time-limit-switch').checked=tempSettings.timeLimitEnabled;document.querySelectorAll('.option-count-btn').forEach(btn=>btn.classList.toggle('active',parseInt(btn.dataset.count)===tempSettings.numberOfOptions));document.querySelectorAll('.theme-btn').forEach(btn=>btn.classList.toggle('active',btn.dataset.theme===tempSettings.theme));document.getElementById('fictional-elements-btn').classList.toggle('active',tempSettings.fictionalElementsEnabled);document.getElementById('fictional-elements-btn').style.backgroundColor=tempSettings.fictionalElementsEnabled?'var(--enter-key-color)':'var(--light-gray-btn)';updateModeButtons(true);showModal('settings-modal');};
        const handleCoinClick=()=>{if(state.min===11&&state.max===23&&!state.fibonacciBonusClaimed){state.coins+=112;state.fibonacciBonusClaimed=true;showInfoPopup('ボーナス！','フィボナッチボーナス！ 112コイン獲得！');updateCoinDisplay();}else if(state.min===12&&state.max===48&&!state.twoPowerBonusClaimed){state.coins+=128;state.twoPowerBonusClaimed=true;showInfoPopup('ボーナス！','2ⁿ⁻¹ボーナス！ 128コイン獲得！');updateCoinDisplay();}else{showModal('coin-info-modal');}};
        const handleFormatClick=()=>{tempSettings.formats=[...state.selectedFormats];document.querySelectorAll('.format-btn').forEach(btn=>{const formatKey=btn.dataset.formatKey;btn.classList.toggle('selected',tempSettings.formats.includes(formatKey));btn.style.backgroundColor=tempSettings.formats.includes(formatKey)?quizFormats[formatKey].color:'var(--light-gray-btn)';});showModal('format-modal');};
        const handleExpansion=(isBulk=false)=>{if(state.unlockedMaxLimit>=118){showGenshicho(1);return;}if(isBulk){const tiersToUnlock=expansionTiers.filter(t=>t.limit>state.unlockedMaxLimit);if(tiersToUnlock.length===0)return;const totalCost=tiersToUnlock.reduce((sum,tier)=>sum+tier.cost,0);const purchaseAction=()=>{if(state.coins>=totalCost){state.coins-=totalCost;state.unlockedMaxLimit=118;if(state.defaultMax<36)state.defaultMax=36;updateCoinDisplay();updateExpansionButton();showInfoPopup('範囲拡張',`範囲を 118 まで一括で拡張しました！`);}else{showInfoPopup('コイン不足','コインが足りません。');}};showConfirmation('範囲一括拡張',`残り全ての範囲を🪙×${totalCost}で一括解放しますか？`,purchaseAction);}else{const nextTier=expansionTiers.find(t=>t.limit>state.unlockedMaxLimit);if(!nextTier)return;const purchaseAction=()=>{if(state.coins>=nextTier.cost){state.coins-=nextTier.cost;state.unlockedMaxLimit=nextTier.limit;if(state.unlockedMaxLimit>=36&&state.defaultMax<36){state.defaultMax=36;}updateCoinDisplay();updateExpansionButton();showInfoPopup('範囲拡張',`範囲を ${nextTier.limit} まで拡張しました！`);}else{showInfoPopup('コイン不足','コインが足りません。');}};showConfirmation('範囲拡張',`🪙×${nextTier.cost}で範囲拡張をしますか？`,purchaseAction);}};
        function updateModeButtons(useTemp=false){const settings=useTemp?tempSettings:state;const survivalBtn=document.getElementById('survival-mode-btn');const hardcoreBtn=document.getElementById('hardcore-mode-btn');const inputBtn=document.getElementById('input-mode-btn');const endlessBtn=document.getElementById('endless-mode-btn');const friendBattleBtn=document.getElementById('friend-battle-btn');survivalBtn.style.backgroundColor=settings.survivalMode?'var(--mode-survival)':'var(--light-gray-btn)';hardcoreBtn.style.backgroundColor=settings.hardcoreMode?'var(--mode-hardcore)':'var(--light-gray-btn)';hardcoreBtn.classList.toggle('hardcore',settings.hardcoreMode);inputBtn.style.backgroundColor=settings.inputMode?'var(--enter-key-color)':'var(--light-gray-btn)';endlessBtn.style.backgroundColor=settings.endlessMode?'var(--mode-endless)':'var(--light-gray-btn)';endlessBtn.classList.toggle('endless',settings.endlessMode);friendBattleBtn.style.backgroundColor=settings.friendBattleMode? 'var(--green-btn)' : 'var(--light-gray-btn)';document.getElementById('survival-section').style.display=settings.survivalMode?'block':'none';}
        const startFriendBattleSetup=()=>{const colors=['赤','朱','林檎','緋','スカーレット','ルビー','ガーネット','ワインレッド','バーガンディ','黄','檸檬','カーキー','ベージュ','バフ','マスタード','バナナ','トパーズ','向日葵','ブロンド','ハニー','アンバー','ゴールド','黄土','キャメル','緑','ミントブルー','ミント','オパール','ペリドット','エメラルド','青林檎','若草','翡翠','モスグリーン','鶯','シーグリーン','ジェイド','オリーブ','深緑','ダークグリーン','フォレストグリーン','ハンターグリーン','ブリティッシュレーシンググリーン','ボトルグリーン','ダークオリーブ','オリーブドラブ','パイングリーン','エバーグリーン','ブランズウィックグリーン','マラカイト','ビリジアン','天鵞城','緑黒','新檜皮','ジュニパー','フォーンダーク','フォレストナイト','青','水','ミントブルー','空','トルマリン','スチールブルー','群青','セルリアンブルー','ティール','デニム','インディペンデンス','サファイア','コバルト','宇宙','闇夜','プルシアン','インペリアルブルー','アドミラルブルー','深夜','呉須','ブルーブラック','オックスフォードブルー','ネイビー','ダークネイビー','紫','ラベンダー','モーブ','梅','ヘリオトロープ','オーキッド','紫灰','アメジスト','バイオレット','グレープ','桃','コーラルピンク','サーモン','ローズ','チェリーピンク','マゼンタ','茶','タン','淡モカ','ブロンズ','茶褐色','暗モカ','セピア','モカ','黒','チャコール','アイボリーブラック','灰','プラチナ','シルバー','白','アイボリー','クリーム','シャンパン'];const colorHex={'赤':'#dc3545','朱':'#EB6101','林檎':'#d9333f','緋':'#D3381C','スカーレット':'#FF2400','ルビー':'#E0115F','ガーネット':'#733635','ワインレッド':'#722F37','バーガンディ':'#800020','黄':'#ffc107','檸檬':'#FFF44F','カーキー':'#F0E68C','ベージュ':'#eedcb3','バフ':'#F0DC82','マスタード':'#FFDB58','バナナ':'#FFE135','トパーズ':'#FFC87C','向日葵':'#FFDA03','ブロンド':'#f2d58a','ハニー':'#FFC30B','アンバー':'#FFBF00','ゴールド':'#FFD700','黄土':'#c39143','キャメル':'#C19A6B','緑':'#28a745','ミントブルー':'#AAF0D1','ミント':'#9CFCCF','オパール':'#A8C3BC','ペリドット':'#B4C424','エメラルド':'#50C878','青林檎':'#8DB600','若草':'#7BA23F','翡翠':'#3F9877','モスグリーン':'#8A9A5B','鶯':'#928c36','シーグリーン':'#2E8B57','ジェイド':'#00A86B','オリーブ':'#808000','深緑':'#0A2F23','ダークグリーン':'#006400','フォレストグリーン':'#228B22','ハンターグリーン':'#355E3B','ブリティッシュレーシンググリーン':'#004225','ボトルグリーン':'#006A4E','ダークオリーブ':'#556B2F','オリーブドラブ':'#6B8E23','パイングリーン':'#01796F','エバーグリーン':'#05472A','ブランズウィックグリーン':'#1B4D3E','マラカイト':'#046A38','ビリジアン':'#40826D','天鵞城':'#2F5D50','緑黒':'#032B2B','新檜皮':'#123B2B','ジュニパー':'#154734','フォーンダーク':'#20382E','フォレストナイト':'#062E23','青':'#007bff','水':'#17a2b8','空':'#87CEEB','トルマリン':'#7C9ED9','群青':'#4C6CB3','スチールブルー':'#4682B4','セルリアンブルー':'#007BA7','ティール':'#008080','デニム':'#1560BD','インディペンデンス':'#4C516D','サファイア':'#0F52BA','コバルト':'#0047AB','宇宙':'#1D2951','闇夜':'#003366','プルシアン':'#003153','インペリアルブルー':'#002395','アドミラルブルー':'#0D2B45','深夜':'#191970','呉須':'#0014A8','ブルーブラック':'#101F30','オックスフォードブルー':'#002147','ネイビー':'#000080','ダークネイビー':'#00053a','紫':'#6f42c1','ラベンダー':'#E6E6FA','モーブ':'#E0B0FF','梅':'#DDA0DD','ヘリオトロープ':'#DF73FF','オーキッド':'#DA70D6','紫灰':'#A593A5','アメジスト':'#9966CC','バイオレット':'#714f9d','グレープ':'#6F2DA8','桃':'#e83e8c','コーラルピンク':'#FF7F50','サーモン':'#FA8072','ローズ':'#e83f5f','チェリーピンク':'#DE3163','マゼンタ':'#e4007f','茶':'#8B4513','タン':'#D2B48C','淡モカ':'#E3D1C2','ブロンズ':'#CD7F32','茶褐色':'#664C28','暗モカ':'#835F58','セピア':'#704214','モカ':'#BEA493','黒':'#343a40','チャコール':'#36454F','アイボリーブラック':'#333132','灰':'#6c757d','プラチナ':'#E5E4E2','シルバー':'#C0C0C0','白':'#f8f9fa','アイボリー':'#FFFFF0','クリーム':'#FFFDD0','シャンパン':'#F7E7CE'};state.players=[];const modal=document.getElementById('color-selection-modal');const modalContent=modal.querySelector('.modal-content');const title=modal.querySelector('h2');const grid=modal.querySelector('#color-grid');const showColorSelection=(playerNum)=>{title.textContent=`プレイヤー${playerNum}、あなたの色は？`;modalContent.classList.toggle('rotated',playerNum===2);grid.innerHTML='';colors.forEach(color=>{const btn=document.createElement('button');btn.className='btn color-btn';btn.textContent=color;btn.style.backgroundColor=colorHex[color];btn.style.color=['黄','白','水','ベージュ','カーキー','ミント','ライラック','セージー','ブロンド','檸檬','バナナ','トパーズ','向日葵','ハニー','アンバー','バフ','アイボリー','クリーム','シャンパン','プラチナ'].includes(color)?'#000':'#fff';btn.disabled=state.players.some(p=>p.color===color);btn.addEventListener('click',()=>{state.players.push({color:color,score:0,lives:state.endlessMode?1:3});if(playerNum===1){showColorSelection(2);}else{hideModal(modal);startFriendBattle();}});grid.appendChild(btn);});showModal('color-selection-modal');};showColorSelection(1);};
        const startFriendBattle=()=>{state.currentPlayerIndex=0;state.turnCount=1;let availableElements=elementData.filter(el=>{const inRange=el.number>=state.min&&el.number<=state.max;if(!inRange)return false;if(state.selectedGenres.length===0)return true;return state.selectedGenres.some(genre=>el.categories.includes(genre));});if(availableElements.length<1){showInfoPopup("エラー",`選択された範囲・ジャンルに該当する原子がありません。`);return;}state.questions[state.currentQuestionIndex]=availableElements[Math.floor(Math.random()*availableElements.length)].number;const formatKey=state.selectedFormats[Math.floor(Math.random()*state.selectedFormats.length)];state.currentQuizFormat=quizFormats[formatKey];document.getElementById('title-screen').classList.remove('active');document.getElementById('quiz-screen').classList.add('active');updateQuizInfo();loadQuestion(true);};
        const initialize=()=>{document.getElementById('quiz-screen').innerHTML=`<div id="quiz-info"><div id="normal-stats" style="display: flex; flex-direction: column; align-items: flex-start; gap: 5px;"><div id="question-counter"></div><div id="score-display"></div><div id="lives-display"></div></div><div id="battle-stats" style="display: none; width: 100%;"><div id="player1-stats"></div><div id="turn-counter" style="position: absolute; top: 10px; left: 50%; transform: translateX(-50%);"></div><div id="player2-stats" style="margin-top: 8mm;"></div></div></div><div id="timer-display"></div><button id="pause-btn" class="icon-btn"><svg viewBox="0 0 36 36"><path d="M12,26 L16,26 L16,10 L12,10 L12,26 Z M20,10 L20,26 L24,26 L24,10 L20,10 Z"></path></svg></button><button id="interrupt-btn" class="btn icon-btn" style="display: none; font-size: 1rem; padding: 10px 15px;">中断</button><div id="turn-indicator"></div><div id="question-container"><p id="question-text"></p></div><div id="options-grid"></div><div id="input-container" style="display: none;"><input type="text" id="answer-input" placeholder="答えを入力..."><div id="input-helper"></div></div><div id="custom-keyboard"><div id="keyboard-mode-buttons"></div><div id="katakana-keyboard" class="keyboard-layout active"></div><div id="kanji-keyboard" class="keyboard-layout"></div><div id="alphanumeric-keyboard" class="keyboard-layout"></div></div>`;document.getElementById('pause-menu').innerHTML=`<div class="modal-content"><h2>ポーズ</h2><button id="retry-btn" class="btn modal-btn">リトライ</button><button id="title-btn" class="btn modal-btn">タイトルに戻る</button><button class="btn gray-close-btn" data-modal-close>閉じる</button></div>`;document.getElementById('confirmation-popup').innerHTML=`<div class="modal-content"><h2 id="confirmation-title">確認</h2><p></p><div class="confirmation-buttons"><button id="confirm-no-btn" class="btn modal-btn">いいえ</button><button id="confirm-yes-btn" class="btn modal-btn">はい</button></div></div>`;document.getElementById('settings-modal').innerHTML=`<div class="modal-content" style="overflow-y: auto;"><h2>設定</h2><div class="setting-item"><h3>---問題数---</h3><div id="quiz-length-display" class="setting-value">10</div><div class="setting-buttons" id="quiz-length-buttons"></div><button id="default-length-btn" class="btn gray-close-btn">デフォルトの問題数に戻す</button></div><div class="setting-item"><h3>---選択肢設定---</h3><div id="options-count-buttons"></div><button id="fictional-elements-btn" class="btn" style="margin-top: 10px; width: 100%;">架空元素</button></div><div class="setting-item"><h3>---制限時間---</h3><label class="switch"><input type="checkbox" id="time-limit-switch"><span class="slider"></span></label><div id="time-limit-display" class="setting-value">10s</div><div class="setting-buttons" id="time-limit-buttons"></div><button id="default-time-limit-btn" class="btn gray-close-btn">デフォルトの制限時間に戻す</button></div><div class="setting-item"><h3>---モード---</h3><div class="mode-btn-container"><button id="survival-mode-btn" class="btn mode-btn">サバイバル</button><button id="hardcore-mode-btn" class="btn mode-btn">ハードコア</button><button id="input-mode-btn" class="btn mode-btn">入力</button></div></div><div id="survival-section" class="setting-item"><h3>--- サバイバル ---</h3><div class="mode-btn-container"><button id="endless-mode-btn" class="btn mode-btn">エンドレス</button><button id="friend-battle-btn" class="btn mode-btn">フレンド対戦</button></div></div><div class="setting-item"><h3>---背景画面---</h3><div class="setting-buttons" id="theme-buttons"><button class="btn theme-btn" data-theme="light">ライト</button><button class="btn theme-btn active" data-theme="dark">ダーク</button></div></div><button id="save-settings-btn" class="btn gray-close-btn">保存して閉じる</button></div>`;document.getElementById('coin-info-modal').innerHTML=`<div class="modal-content"><h2>コイン</h2><p>正解数に応じてもらえる、範囲上限、ジャンル、形式の解放に使う仮想通貨。</p><button class="btn gray-close-btn" data-modal-close>閉じる</button></div>`;document.getElementById('results-modal').innerHTML=`<div class="modal-content"><h2>終了！</h2><p></p><button id="results-to-title-btn" class="btn">タイトルに戻る</button></div>`;document.getElementById('info-popup').innerHTML=`<div class="modal-content"><h2 id="info-title"></h2><p></p><button class="btn gray-close-btn" data-modal-close>閉じる</button></div>`;document.getElementById('genshicho-modal').innerHTML=`<div class="modal-content" id="genshicho-content"><div id="genshicho-header"><span id="genshicho-number"></span><span id="genshicho-category"></span><span id="genshicho-period-group"></span></div><div id="genshicho-main"><div id="genshicho-symbol"></div><div id="genshicho-name"></div></div><div id="genshicho-footer"><button id="genshicho-prev" class="btn range-btn">前へ</button><div id="genshicho-center-controls"><button id="genshicho-close" class="btn gray-close-btn">閉じる</button><button id="genshicho-details" class="btn range-btn">▲</button></div><button id="genshicho-next" class="btn range-btn">次へ</button></div></div>`;document.getElementById('genshicho-list-modal').innerHTML=`<div class="modal-content"><div id="genshicho-list-container"></div><button class="btn gray-close-btn" data-modal-close style="margin-top: 20px;">閉じる</button></div>`;document.getElementById('interrupt-overlay').innerHTML=`<div>長押しで中断</div><svg id="interrupt-circle"><circle id="interrupt-circle-path" r="45" cx="50" cy="50"></circle></svg>`;const formatGridHTML=Object.entries(quizFormats).map(([key,{text}])=>`<button class="btn format-btn" data-format-key="${key}">${text}</button>`).join('');document.getElementById('format-modal').innerHTML=`<div class="modal-content"><h2>どの形式で遊ぶ？</h2><div id="format-grid">${formatGridHTML}</div><button id="save-formats-btn" class="btn" style="margin-top: 20px; background-color: #616161; color: #fff;">保存して閉じる</button></div>`;
            document.getElementById('color-selection-modal').innerHTML=`<div class="modal-content"><h2 style="margin-bottom: 20px;"></h2><div id="color-grid" style="flex-grow: 1; overflow-y: auto;"></div><button class="btn gray-close-btn" data-color-close style="margin-top: 20px;">閉じる</button></div>`;
            document.getElementById('keyboard-mode-buttons').innerHTML=`<button class="btn keyboard-mode-btn active" data-mode="katakana">カタカナ</button><button class="btn keyboard-mode-btn" data-mode="kanji">漢字</button><button class="btn keyboard-mode-btn" data-mode="alphanumeric">英数字</button>`;
            const katakanaGrid=document.getElementById('katakana-keyboard');const katakanaLayout=[['ア','イ','ウ','エ','オ'],['カ','キ','ク','ケ','コ'],['サ','シ','ス','セ','ソ'],['タ','チ','ツ','テ','ト'],['ナ','ニ','ヌ','ネ','ノ'],['ハ','ヒ','フ','ヘ','ホ'],['マ','ミ','ム','メ','モ'],['ヤ',null,'ユ',null,'ヨ'],['ラ','リ','ル','レ','ロ'],['ワ','ヲ','ン','ー','小゛゜']].reverse();katakanaGrid.innerHTML='';for(let row=0;row<5;row++){for(let col=0;col<10;col++){const key=katakanaLayout[col][row];const btn=document.createElement('button');btn.className='btn keyboard-btn';if(key){btn.textContent=key;btn.dataset.key=key;}else{btn.style.visibility='hidden';}katakanaGrid.appendChild(btn);}}const k_backspace=document.createElement('button');k_backspace.className='btn keyboard-btn keyboard-btn-func';k_backspace.textContent='←';k_backspace.dataset.key='backspace';k_backspace.style.gridColumn='11';k_backspace.style.gridRow='1';const k_clear=document.createElement('button');k_clear.className='btn keyboard-btn keyboard-btn-func';k_clear.textContent='clear';k_clear.dataset.key='clear';k_clear.style.gridColumn='11';k_clear.style.gridRow='2';const k_enter=document.createElement('button');k_enter.className='btn keyboard-btn keyboard-btn-enter';k_enter.textContent='enter';k_enter.dataset.key='enter';k_enter.style.gridColumn='11';k_enter.style.gridRow='3 / span 2';katakanaGrid.append(k_backspace,k_clear,k_enter);
            const alphanumericGrid=document.getElementById('alphanumeric-keyboard');alphanumericGrid.innerHTML='';const alphaKeys=[['1','2','3','4','5','6','7','8','9','0'],['q','w','e','r','t','y','u','i','o','p','backspace'],['a','s','d','f','g','h','j','k','l','enter'],['z','x','c','v','b','n','m','shift','clear']];alphaKeys.forEach((row,i)=>{const rowDiv=document.createElement('div');rowDiv.className=`keyboard-row keyboard-row-${i+1}`;row.forEach(key=>{const btn=document.createElement('button');btn.className='btn keyboard-btn';btn.dataset.key=key;const keyActions={'backspace':'←','enter':'enter','clear':'clear','shift':'<svg width="24" height="24" viewBox="0 0 24 24"><path class="arrow" d="M7 14l5-5 5 5z"></path></svg>'};btn.innerHTML=keyActions[key]||key;if(keyActions[key]){if(key==='enter')btn.classList.add('keyboard-btn-enter');else if(key==='shift')btn.classList.add('keyboard-btn-shift');else btn.classList.add('keyboard-btn-func');}rowDiv.appendChild(btn);});alphanumericGrid.appendChild(rowDiv);});
            const rangeBtnValues=[-50,-25,-10,-5,-1,1,5,10,25,50];const lengthBtnValues=[-100,-50,-25,-10,-5,-1,1,10,25,50,100];const timeLimitBtnValues=[-10,-5,-1,1,5,10];const optionsCountValues=[4,8,12,16,20,24];const genres=['遷移元素','典型元素','アルカリ金属','アルカリ土類金属','ハロゲン','貴ガス','ランタノイド','アクチノイド'];const createButtons=(values,cls)=>values.map(v=>`<button class="btn ${cls}" data-val="${v}">${v>0?'+':''}${v}</button>`).join('');document.querySelectorAll('.range-buttons').forEach(div=>div.innerHTML=createButtons(rangeBtnValues,'range-btn'));document.getElementById('quiz-length-buttons').innerHTML=createButtons(lengthBtnValues,'range-btn');document.getElementById('time-limit-buttons').innerHTML=createButtons(timeLimitBtnValues,'range-btn');document.getElementById('options-count-buttons').innerHTML=optionsCountValues.map(v=>`<button class="btn option-count-btn" data-count="${v}">${v}択</button>`).join('');document.getElementById('genre-buttons').innerHTML=genres.map(g=>`<button class="btn genre-btn" data-genre="${g}">${g}</button>`).join('');updateCoinDisplay();updateRangeDisplay();updateExpansionButton();updateFormatButtonColor();const expansionBtn=document.getElementById('expansion-btn');const longPressDuration=1300;const stopLongPress=()=>{clearTimeout(state.longPressTimer);cancelAnimationFrame(state.pressAnimation);expansionBtn.style.setProperty('--fill-width','0%');};const startLongPress=()=>{state.isLongPress=false;const startTime=Date.now();const animateFill=()=>{const elapsedTime=Date.now()-startTime;const fillPercentage=Math.min(100,(elapsedTime/longPressDuration)*100);expansionBtn.style.setProperty('--fill-width',`${fillPercentage}%`);if(elapsedTime<longPressDuration){state.pressAnimation=requestAnimationFrame(animateFill);}};state.pressAnimation=requestAnimationFrame(animateFill);state.longPressTimer=setTimeout(()=>{state.isLongPress=true;setTimeout(()=>{handleExpansion(true);},200);},longPressDuration);};expansionBtn.addEventListener('mousedown',startLongPress);expansionBtn.addEventListener('mouseup',()=>{if(!state.isLongPress){handleExpansion(false);}stopLongPress();});expansionBtn.addEventListener('mouseleave',stopLongPress);expansionBtn.addEventListener('touchstart',(e)=>{e.preventDefault();startLongPress();});expansionBtn.addEventListener('touchend',(e)=>{e.preventDefault();if(!state.isLongPress){handleExpansion(false);}stopLongPress();});const interruptBtn=document.getElementById('interrupt-btn');const interruptCircle=document.getElementById('interrupt-circle-path');const circumference=2*Math.PI*45;interruptCircle.style.strokeDasharray=circumference;const stopInterrupt=()=>{clearTimeout(state.interruptTimer);interruptCircle.style.transition='stroke-dashoffset 0.2s ease-out';interruptCircle.style.strokeDashoffset=circumference;hideModal('interrupt-overlay');};interruptBtn.addEventListener('mousedown',(e)=>{showModal('interrupt-overlay');interruptCircle.style.transition='none';interruptCircle.style.strokeDashoffset=circumference;setTimeout(()=>{interruptCircle.style.transition='stroke-dashoffset 1s linear';interruptCircle.style.strokeDashoffset=0;},10);state.interruptTimer=setTimeout(()=>{setTimeout(()=>{showTitleScreen();},200);},1000);});interruptBtn.addEventListener('mouseup',stopInterrupt);interruptBtn.addEventListener('mouseleave',stopInterrupt);interruptBtn.addEventListener('touchstart',(e)=>{e.preventDefault();interruptBtn.dispatchEvent(new MouseEvent('mousedown'));});interruptBtn.addEventListener('touchend',(e)=>{e.preventDefault();stopInterrupt();});
            const charTransformMap={'ア':'ァ','イ':'ィ','ウ':'ゥ','ゥ':'ヴ','ヴ':'ウ','エ':'ェ','オ':'ォ','ァ':'ア','ィ':'イ','ェ':'エ','ォ':'オ','ヤ':'ャ','ユ':'ュ','ヨ':'ョ','ャ':'ヤ','ュ':'ユ','ョ':'ヨ','ツ':'ッ','ッ':'ヅ','ヅ':'ツ','ワ':'ヮ','ヮ':'ワ','カ':'ガ','キ':'ギ','ク':'グ','ケ':'ゲ','コ':'ゴ','ガ':'カ','ギ':'キ','グ':'ク','ゲ':'ケ','ゴ':'コ','サ':'ザ','シ':'ジ','ス':'ズ','セ':'ゼ','ソ':'ゾ','ザ':'サ','ジ':'シ','ズ':'ス','ゼ':'セ','ゾ':'ソ','タ':'ダ','チ':'ヂ','テ':'デ','ト':'ド','ダ':'タ','ヂ':'チ','ヅ':'ツ','デ':'テ','ド':'ト','ハ':'バ','ヒ':'ビ','フ':'ブ','ヘ':'ベ','ホ':'ボ','バ':'パ','ビ':'ピ','ブ':'プ','ベ':'ペ','ボ':'ポ','パ':'ハ','ピ':'ヒ','プ':'フ','ペ':'ヘ','ポ':'ホ'};
            const updateShiftKeyUI=()=>{const shiftBtn=document.querySelector('.keyboard-btn-shift');if(shiftBtn){shiftBtn.classList.toggle('active',state.isShiftOn);}document.querySelectorAll('#alphanumeric-keyboard .keyboard-btn').forEach(btn=>{const key=btn.dataset.key;if(key&&key.length===1&&key>='a'&&key<='z'){btn.textContent=state.isShiftOn?key.toUpperCase():key.toLowerCase();}});};
            document.getElementById('custom-keyboard').addEventListener('click',e=>{const target=e.target.closest('.keyboard-btn');if(!target||target.style.visibility==='hidden')return;const key=target.dataset.key;const answerInput=document.getElementById('answer-input');if(key==='backspace'){answerInput.value=answerInput.value.slice(0,-1);}else if(key==='enter'){checkAnswer();}else if(key==='clear'){answerInput.value='';}else if(key==='shift'){state.isShiftOn=!state.isShiftOn;updateShiftKeyUI();}else if(key==='小゛゜'){const lastChar=answerInput.value.slice(-1);if(charTransformMap[lastChar]){answerInput.value=answerInput.value.slice(0,-1)+charTransformMap[lastChar];}}else{let charToAppend=key;if(state.isShiftOn&&/[a-z]/.test(charToAppend)){charToAppend=charToAppend.toUpperCase();state.isShiftOn=false;updateShiftKeyUI();}if(answerInput.value.length<20){answerInput.value+=charToAppend;}}});
            document.getElementById('keyboard-mode-buttons').addEventListener('click',e=>{const target=e.target.closest('.keyboard-mode-btn');if(!target||target.classList.contains('active'))return;state.keyboardMode=target.dataset.mode;document.querySelectorAll('.keyboard-mode-btn').forEach(b=>b.classList.remove('active'));target.classList.add('active');document.querySelectorAll('.keyboard-layout').forEach(l=>l.classList.remove('active'));const activeKeyboard=document.getElementById(`${state.keyboardMode}-keyboard`);if(activeKeyboard){if(state.keyboardMode==='kanji'&&!activeKeyboard.hasChildNodes()){generateKanjiKeyboard();}activeKeyboard.classList.add('active');}});
            document.body.addEventListener('click',e=>{const target=e.target.closest('button');if(!target)return;if(['expansion-btn','interrupt-btn'].includes(target.id)||target.closest('#custom-keyboard'))return;if(target.matches('[data-modal-close]')){hideModal(target.closest('.modal-overlay'));return;}if(target.matches('[data-color-close]')){state.players=[];hideModal(target.closest('.modal-overlay'));return;}const idActions={'start-btn':startQuiz,'format-btn':handleFormatClick,'default-range-btn':()=>{state.min=state.defaultMin;state.max=state.defaultMax;updateRangeDisplay();},'coin-display':handleCoinClick,'settings-btn':handleSettingsClick,'results-to-title-btn':showTitleScreen,'pause-btn':()=>{if(state.friendBattleMode){document.getElementById('retry-btn').style.display='none';}else{document.getElementById('retry-btn').style.display='block';}showModal('pause-menu');},'retry-btn':()=>{hideModal('pause-menu');showConfirmation('リトライ','この範囲でリトライしますか？',startQuiz);},'title-btn':()=>{hideModal('pause-menu');showConfirmation('タイトル','タイトルに戻りますか？',showTitleScreen);},'confirm-yes-btn':()=>{if(state.confirmAction)state.confirmAction();state.confirmAction=null;hideModal('confirmation-popup');},'confirm-no-btn':()=>{hideModal('confirmation-popup');if(document.getElementById('quiz-screen').classList.contains('active'))showModal('pause-menu');},'save-settings-btn':()=>{const oldTheme=state.theme;Object.assign(state,tempSettings);const newTheme=state.theme;if(oldTheme!==newTheme){applyTheme(newTheme,false);}hideModal('settings-modal');document.getElementById('start-btn').classList.toggle('hardcore-active',state.hardcoreMode);},'default-length-btn':()=>{tempSettings.quizLength=10;document.getElementById('settings-modal').querySelector('#quiz-length-display').textContent=10;},'default-time-limit-btn':()=>{tempSettings.timeLimit=10;document.getElementById('time-limit-display').textContent='10s';},'genshicho-prev':()=>showGenshicho(state.genshichoCurrentIndex===0?118:state.genshichoCurrentIndex),'genshicho-next':()=>showGenshicho(state.genshichoCurrentIndex===117?1:state.genshichoCurrentIndex+2),'genshicho-close':()=>hideModal('genshicho-modal'),'genshicho-details':showGenshichoList,'save-formats-btn':()=>{state.selectedFormats=tempSettings.formats.length>0?[...tempSettings.formats]:['number_to_name'];hideModal('format-modal');updateFormatButtonColor();}};if(target.id&&idActions[target.id]){idActions[target.id]();return;}if(target.closest('.range-buttons')){const control=target.closest('.range-control');const label=control.querySelector('.range-label');if(label)adjustRange(label.textContent.trim(),parseInt(target.dataset.val));return;}if(target.closest('#quiz-length-buttons')){tempSettings.quizLength=Math.max(1,Math.min(500,tempSettings.quizLength+parseInt(target.dataset.val)));document.getElementById('settings-modal').querySelector('#quiz-length-display').textContent=tempSettings.quizLength;return;}if(target.closest('#time-limit-buttons')){tempSettings.timeLimit=Math.max(3,Math.min(45,tempSettings.timeLimit+parseInt(target.dataset.val)));document.getElementById('time-limit-display').textContent=`${tempSettings.timeLimit}s`;return;}if(target.matches('.theme-btn')){tempSettings.theme=target.dataset.theme;document.querySelectorAll('.theme-btn').forEach(b=>b.classList.remove('active'));target.classList.add('active');return;}if(target.matches('.option-count-btn')){tempSettings.numberOfOptions=parseInt(target.dataset.count);document.querySelectorAll('.option-count-btn').forEach(b=>b.classList.remove('active'));target.classList.add('active');return;}if(target.matches('.genre-btn')){const genre=target.dataset.genre;target.classList.toggle('selected');if(state.selectedGenres.includes(genre)){state.selectedGenres=state.selectedGenres.filter(g=>g!==genre);}else{state.selectedGenres.push(genre);}return;}if(target.matches('.format-btn')){const key=target.dataset.formatKey;const index=tempSettings.formats.indexOf(key);if(index>-1){tempSettings.formats.splice(index,1);}else{tempSettings.formats.push(key);}target.classList.toggle('selected');target.style.backgroundColor=target.classList.contains('selected')?quizFormats[key].color:'var(--light-gray-btn)';}});
            document.getElementById('time-limit-switch').addEventListener('change',(e)=>{tempSettings.timeLimitEnabled=e.target.checked;});document.getElementById('survival-mode-btn').addEventListener('click',(e)=>{tempSettings.survivalMode=!tempSettings.survivalMode;if(!tempSettings.survivalMode)tempSettings.friendBattleMode=false;if(tempSettings.survivalMode)tempSettings.hardcoreMode=false;updateModeButtons(true);});document.getElementById('hardcore-mode-btn').addEventListener('click',(e)=>{tempSettings.hardcoreMode=!tempSettings.hardcoreMode;if(tempSettings.hardcoreMode){tempSettings.survivalMode=false;tempSettings.endlessMode=false;tempSettings.friendBattleMode=false;}updateModeButtons(true);});document.getElementById('input-mode-btn').addEventListener('click',(e)=>{tempSettings.inputMode=!tempSettings.inputMode;updateModeButtons(true);});document.getElementById('endless-mode-btn').addEventListener('click',(e)=>{tempSettings.endlessMode=!tempSettings.endlessMode;updateModeButtons(true);});document.getElementById('friend-battle-btn').addEventListener('click', ()=>{tempSettings.friendBattleMode = !tempSettings.friendBattleMode;updateModeButtons(true);});
            document.getElementById('fictional-elements-btn').addEventListener('click', ()=>{tempSettings.fictionalElementsEnabled = !tempSettings.fictionalElementsEnabled; const btn = document.getElementById('fictional-elements-btn'); btn.classList.toggle('active', tempSettings.fictionalElementsEnabled); btn.style.backgroundColor = tempSettings.fictionalElementsEnabled ? 'var(--enter-key-color)' : 'var(--light-gray-btn)';});
        };
        document.addEventListener('DOMContentLoaded',initialize);
    </script>
</body>
</html>

