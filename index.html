<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÂéüÂ≠êÁï™Âè∑„ÇØ„Ç§„Ç∫</title>
    <style>
        :root {
            --primary-bg: #0a0d2e; /* ÈªíÂº∑„ÇÅ„ÅÆÁ¥∫Ëâ≤ */
            --secondary-bg: #191d47; /* Êöó„ÇÅ„ÅÆÁ¥∫Ëâ≤ */
            --accent-color: #4E5476;
            --text-color: #e8eaf6;
            --correct-color: #4caf50;
            --incorrect-color: #f44336;
            --coin-color: #ffd700;
            --lemon-color-dark: #FBC02D; /* ÊøÉ„ÅÑ„É¨„É¢„É≥Ëâ≤ */
            --dark-gray: #424242;
            --light-gray: #757575;
            --font-family: 'Helvetica Neue', 'Arial', 'Hiragino Kaku Gothic ProN', 'Hiragino Sans', 'Meiryo', sans-serif;
            --angle: 0deg;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        html, body { width: 100%; height: 100%; overflow: hidden; }
        body { background-color: var(--primary-bg); color: var(--text-color); font-family: var(--font-family); display: flex; justify-content: center; align-items: center; text-align: center; user-select: none; transition: background-color 0.5s; }
        .container { width: 100%; max-width: 800px; height: 100%; padding: 20px; display: flex; flex-direction: column; justify-content: center; position: relative; }
        .screen { width: 100%; height: 100%; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .hidden { display: none !important; }

        /* --- Title Screen --- */
        #title-screen h1 { font-size: 2.5rem; margin-bottom: 20px; }
        #top-right-controls { position: absolute; top: 20px; right: 20px; display: flex; flex-direction: column; align-items: flex-end; gap: 10px; z-index: 10; }
        #coin-display { background-color: var(--secondary-bg); padding: 8px 15px; border-radius: 20px; font-size: 1.2rem; font-weight: bold; color: var(--coin-color); cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.2); transition: transform 0.2s; }
        #coin-display:hover { transform: scale(1.05); }
        #settings-btn { background: var(--secondary-bg); border: none; color: var(--text-color); font-size: 1.5rem; width: 40px; height: 40px; border-radius: 50%; cursor: pointer; display: flex; justify-content: center; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.2); transition: transform 0.2s; }
        #settings-btn:hover { transform: scale(1.1); }


        .config-box { background-color: var(--secondary-bg); padding: 20px; border-radius: 15px; margin-bottom: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.3); width: 100%; max-width: 700px; display: flex; flex-direction: column; gap: 15px;}
        .range-controls-wrapper { display: flex; justify-content: center; align-items: center; flex-wrap: wrap; gap: 20px; }
        .range-control { display: flex; align-items: center; gap: 10px; }
        .range-label { font-size: 1.5rem; font-weight: bold; }
        .range-value { font-size: 2rem; font-weight: bold; width: 70px; }
        .btn-adjust-group { display: flex; }
        .btn-adjust { background-color: var(--accent-color); color: var(--text-color); border: none; border-radius: 8px; padding: 10px 12px; font-size: 1rem; cursor: pointer; margin: 0 4px; transition: transform 0.1s, background-color 0.2s; }
        .config-buttons { display: flex; justify-content: center; gap: 10px; flex-wrap: wrap; }
        #upgrade-range-btn, #element-ledger-btn { background-color: var(--lemon-color-dark); color: #333; border: none; padding: 10px 20px; font-size: 1rem; border-radius: 10px; cursor: pointer; transition: all 0.2s; font-weight: bold; }
        #element-ledger-btn { background-color: #90ee90; }
        #upgrade-range-btn:disabled { background-color: #ccc; color: #888; cursor: not-allowed; }
        #reset-range-btn { background-color: var(--dark-gray); color: var(--text-color); border: none; padding: 10px 20px; font-size: 1rem; border-radius: 10px; cursor: pointer; transition: all 0.2s; font-weight: bold; }
        
        .genre-label { font-size: 1rem; color: #bdbdbd; margin-bottom: -5px; }
        #genre-selector { display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; margin-top: 5px; }
        .genre-btn { padding: 8px 12px; border: none; border-radius: 8px; font-size: 0.9rem; cursor: pointer; font-weight: bold; transition: all 0.2s; position: relative; }
        .genre-btn.deselected { background-color: var(--light-gray) !important; color: #ccc !important; }
        .genre-btn.transition { background-color: #ff7043; color: white; } .genre-btn.typical { background-color: #29b6f6; color: white; } .genre-btn.alkali { background-color: #f44336; color: white; } .genre-btn.alkaline-earth { background-color: #ffeb3b; color: #333; } .genre-btn.halogen { background-color: #aeea00; color: #333; } .genre-btn.noble-gas { background-color: #00bcd4; color: white; } .genre-btn.lanthanoid { background-color: #ffca28; color: #333; } .genre-btn.actinoid { background-color: #90a4ae; color: white; }
        .locked-item::after { content: 'üîí'; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 1.5rem; opacity: 0.7; z-index: 3; }
        .genre-btn.locked { background-color: var(--dark-gray) !important; color: #9e9e9e !important; cursor: pointer; }

        .action-buttons-container { display: flex; justify-content: center; align-items: center; gap: 20px; margin-top: 10px; }
        .action-btn { border: none; padding: 15px 40px; font-size: 1.5rem; border-radius: 50px; cursor: pointer; transition: background-color 1s ease-in-out, color 1s ease-in-out, box-shadow 0.3s; font-weight: bold; letter-spacing: 2px; }
        #format-button { background-color: var(--light-gray); color: var(--text-color); }
        #start-button { background-color: var(--correct-color); color: white; text-transform: uppercase; }
        #start-button.endless-active { animation: endless-glow 2s infinite; }
        
        /* --- Quiz Screen --- */
        #quiz-header { width: 100%; display: flex; justify-content: space-between; align-items: center; padding: 0 10px; position: absolute; top: 20px; left: 0; }
        #quiz-header-side { display: flex; flex-direction: column; align-items: flex-start; }
        .info-text { font-size: 1.2rem; }
        #lives-display { color: #ff5252; font-weight: bold; }
        #timer-display { position: absolute; top: 20px; left: 50%; transform: translateX(-50%); font-size: 1.5rem; font-weight: bold; }
        #pause-button { background: none; border: none; cursor: pointer; padding: 10px; }
        #pause-icon { fill: var(--text-color); width: 32px; height: 32px; }
        #abort-button { background-color: var(--incorrect-color); color: white; padding: 10px 20px; border-radius: 8px; font-weight: bold; border: none; cursor: pointer; position: relative; overflow: hidden; }
        #abort-button::before { content: ''; position: absolute; top: 0; left: 0; width: 0; height: 100%; background-color: rgba(255,255,255,0.3); transition: width 1s linear; }
        #abort-button.holding::before { width: 100%; }
        #question-display { font-size: 7rem; font-weight: bold; line-height: 1; }
        .period-group-q { font-size: 4rem !important; }
        #options-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; width: 100%; }
        .option-btn { background-color: var(--accent-color); color: var(--text-color); border: 2px solid transparent; border-radius: 12px; padding: 15px; font-size: 1.2rem; cursor: pointer; transition: all 0.2s; word-break: keep-all; }
        .option-btn.correct { background-color: var(--correct-color); }
        .option-btn.incorrect { background-color: var(--incorrect-color); opacity: 0.7; }

        /* Input Mode */
        #input-area { width: 100%; max-width: 400px; display: flex; flex-direction: column; align-items: center; gap: 15px; }
        #answer-input { width: 100%; padding: 15px; font-size: 1.5rem; border-radius: 10px; border: 2px solid var(--accent-color); background-color: #fff; color: #000; text-align: center; }
        #answer-input.correct { border-color: var(--correct-color); background-color: #e8f5e9; }
        #answer-input.incorrect { border-color: var(--incorrect-color); background-color: #ffebee; }
        #submit-answer-btn { width: 100%; padding: 15px; font-size: 1.2rem; border-radius: 10px; border: none; background-color: var(--correct-color); color: white; cursor: pointer; font-weight: bold; }


        /* --- Modals --- */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.7); display: flex; justify-content: center; align-items: center; z-index: 1000; }
        .modal-content { background-color: var(--secondary-bg); padding: 30px; border-radius: 20px; width: 90%; max-width: 500px; box-shadow: 0 5px 20px rgba(0,0,0,0.4); display: flex; flex-direction: column; align-items: center; gap: 20px;}
        .modal-content h2 { margin-bottom: 0; font-size: 2rem; }
        .modal-content p { font-size: 1.1rem; margin-bottom: 0; line-height: 1.6; }
        .modal-btn { display: block; width: 100%; padding: 15px; margin-bottom: 15px; font-size: 1.2rem; border-radius: 12px; border: none; cursor: pointer; background-color: var(--accent-color); color: var(--text-color); transition: background-color 0.2s; }
        .modal-btn.close-btn { background-color: var(--light-gray); margin-bottom: 0; }
        .confirm-btn { padding: 10px 30px; font-size: 1rem; border: none; border-radius: 8px; cursor: pointer; min-width: 100px; }
        #confirm-buttons { display: flex; justify-content: space-around; width: 100%; }
        #unlock-key-btn { background-color: var(--coin-color); color: #333; font-weight: bold; }
        #unlock-pick-btn { background-color: #BDBDBD; color: #333; font-weight: bold; }
        #unlock-cancel-btn { background-color: var(--incorrect-color); color: white; font-weight: bold; }
        #pick-fail-retry-btn { background-color: var(--accent-color); }
        #pick-fail-back-btn { background-color: var(--accent-color); }

        /* Format Modal */
        #format-overlay .modal-content { max-width: 800px; }
        #format-selection-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; width: 100%;}
        .format-btn { padding: 18px; font-size: 1rem; border-radius: 10px; border: 2px solid transparent; cursor: pointer; font-weight: bold; transition: all 0.2s; position: relative; word-break: keep-all; white-space: nowrap;}
        .format-btn.selected { border-color: #fff; }
        .format-btn.deselected { background-image: none !important; background-color: var(--light-gray) !important; color: #ccc !important; }
        .format-btn.locked { background-image: none !important; background-color: var(--dark-gray) !important; color: #9e9e9e !important; cursor: pointer; }

        .format-btn-1 { background-color: red; color: white; }
        .format-btn-2 { background-color: #ff69b4; color: white; }
        .format-btn-3 { background-color: #c71585; color: white; }
        .format-btn-4 { background-color: blue; color: white; }
        .format-btn-5 { background-color: purple; color: white; }
        .format-btn-6 { background-color: #4b0082; color: white; }
        .format-btn-7 { background-color: #ffd700; color: #333; }
        .format-btn-8 { background-color: #90ee90; color: #333; }
        .format-btn-9 { background-color: #800000; color: white; }
        .format-btn-10 { background-color: green; color: white; }
        .format-btn-11 { background-color: orange; color: white; }
        .format-btn-12 { background-color: #b0c4de; color: #333; }
        
        /* Settings Modal Specific */
        #settings-overlay .modal-content { max-height: 80vh; overflow-y: auto; }
        #settings-overlay .modal-content { max-width: 700px; }
        .setting-divider { width: 80%; border-top: 1px solid var(--accent-color); margin: 15px 0; }
        .setting-item { display: flex; flex-direction: column; align-items: center; gap: 10px; width: 100%; }
        .setting-item-title { font-size: 1.2rem; font-weight: bold; margin-bottom: 5px; color: var(--coin-color); }
        .setting-item-title::before, .setting-item-title::after { content: '---'; margin: 0 10px; }
        #question-count-value, #timer-value { font-size: 1.5rem; font-weight: bold; width: 60px; text-align: center; }
        .setting-controls { display: flex; align-items: center; justify-content: center; flex-wrap: nowrap; gap: 5px; width: 100%; }
        .btn-adjust-qc { flex-shrink: 0; padding: 5px 8px; font-size: 0.8rem; }
        #reset-qc-btn, #reset-timer-btn { background-color: var(--dark-gray); color: var(--text-color); border: none; padding: 8px 15px; font-size: 0.9rem; border-radius: 8px; cursor: pointer; margin-top: 5px; }
        
        .mode-buttons { display: flex; gap: 15px; }
        .mode-btn { background-color: var(--light-gray); color: #ccc; border: none; padding: 10px 25px; font-size: 1rem; font-weight: bold; border-radius: 8px; cursor: pointer; transition: all 0.3s; }
        .mode-btn.active { background-color: #29b6f6; color: white; }
        #survival-mode-btn.active { background-color: orange; color: white;}
        #hardcore-mode-btn.active {
            background: purple;
            animation: hardcore-bg-glow 2s infinite ease-in-out;
        }
        #endless-mode-btn.active { animation: endless-glow 2s infinite; }
        
        #choice-count-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
        .choice-count-btn { background-color: var(--accent-color); }
        .choice-count-btn.selected { border: 2px solid var(--coin-color); }

        body.hardcore {
            --primary-bg: #2c0b2c;
            --secondary-bg: #4c114c;
        }
        #start-button.hardcore-active {
            animation: hardcore-bg-glow 2s infinite ease-in-out;
            background-color: purple;
        }
        
        @keyframes hardcore-bg-glow {
            0%, 100% { background-color: #3b0f3b; box-shadow: 0 0 10px #ff00ff, 0 0 20px #ff00ff; }
            50% { background-color: #000; box-shadow: 0 0 20px #8a2be2, 0 0 30px #8a2be2; }
        }
        @keyframes endless-glow {
            0%, 100% { background-color: #c62828; color: white; box-shadow: 0 0 8px #ff5252, 0 0 12px #ff1744; }
            50% { background-color: #a02020; color: #e0e0e0; box-shadow: 0 0 12px #c62828, 0 0 18px #a02020, 0 0 24px #000; }
        }
        
        @media (max-width: 850px) {
             #format-selection-grid { grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));}
        }
        @media (max-width: 600px) { #title-screen h1 { font-size: 2rem; } #question-display { font-size: 5rem; } #options-grid { grid-template-columns: repeat(2, 1fr); } }
    </style>
</head>
<body>

    <div class="container">
        <!-- Title Screen -->
        <div id="title-screen" class="screen">
            <div id="top-right-controls">
                <div id="coin-display">ü™ô√ó0</div>
                <button id="settings-btn">‚öôÔ∏è</button>
            </div>
            <h1>ÂéüÂ≠êÁï™Âè∑„ÇØ„Ç§„Ç∫</h1>
            <div class="config-box">
                <div class="range-controls-wrapper">
                    <div class="range-control">
                        <span class="range-label">Min:</span><span id="min-value" class="range-value">1</span>
                        <div class="btn-adjust-group">
                            <button class="btn-adjust" data-target="min" data-amount="-50">-50</button><button class="btn-adjust" data-target="min" data-amount="-10">-10</button><button class="btn-adjust" data-target="min" data-amount="-5">-5</button><button class="btn-adjust" data-target="min" data-amount="-1">-1</button>
                            <button class="btn-adjust" data-target="min" data-amount="1">+1</button><button class="btn-adjust" data-target="min" data-amount="5">+5</button><button class="btn-adjust" data-target="min" data-amount="10">+10</button><button class="btn-adjust" data-target="min" data-amount="50">+50</button>
                        </div>
                    </div>
                    <div class="range-control">
                        <span class="range-label">Max:</span><span id="max-value" class="range-value">20</span>
                         <div class="btn-adjust-group">
                            <button class="btn-adjust" data-target="max" data-amount="-50">-50</button><button class="btn-adjust" data-target="max" data-amount="-10">-10</button><button class="btn-adjust" data-target="max" data-amount="-5">-5</button><button class="btn-adjust" data-target="max" data-amount="-1">-1</button>
                            <button class="btn-adjust" data-target="max" data-amount="1">+1</button><button class="btn-adjust" data-target="max" data-amount="5">+5</button><button class="btn-adjust" data-target="max" data-amount="10">+10</button><button class="btn-adjust" data-target="max" data-amount="50">+50</button>
                        </div>
                    </div>
                </div>
                <div class="config-buttons">
                    <button id="upgrade-range-btn">ÁØÑÂõ≤‰∏äÈôêup</button>
                    <button id="reset-range-btn">„Éá„Éï„Ç©„É´„Éà„ÅÆÁØÑÂõ≤„Å´Êàª„Åô</button>
                </div>
                <p class="genre-label">„Ç∏„É£„É≥„É´Ôºà‰ªªÊÑèÔºâÔºàË§áÊï∞ÈÅ∏ÊäûÂèØËÉΩÔºâ</p>
                <div id="genre-selector"></div>
            </div>
            <div class="action-buttons-container">
                <button id="format-button" class="action-btn">ÂΩ¢Âºè</button>
                <button id="start-button" class="action-btn">„Çπ„Çø„Éº„Éà</button>
            </div>
        </div>

        <!-- Quiz Screen -->
        <div id="quiz-screen" class="screen hidden">
            <div id="quiz-header">
                <div id="quiz-header-side">
                    <span id="progress-text" class="info-text"></span>
                    <span id="score-text" class="info-text"></span>
                     <span id="lives-display" class="info-text"></span>
                </div>
                <span id="timer-display"></span>
                <div id="quiz-top-right">
                     <button id="pause-button" class="hidden"><svg id="pause-icon" viewBox="0 0 24 24"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"></path></svg></button>
                     <button id="abort-button" class="hidden">‰∏≠Êñ≠</button>
                </div>
            </div>
            <div id="question-area"><p id="question-text">ÂéüÂ≠êÁï™Âè∑</p><p id="question-display">?</p></div>
            <div id="options-grid"></div>
            <div id="input-area" class="hidden">
                <input type="text" id="answer-input" placeholder="Á≠î„Åà„ÇíÂÖ•Âäõ">
                <button id="submit-answer-btn">Ê±∫ÂÆö</button>
            </div>
        </div>
    </div>
    
    <!-- Modals -->
    <div id="pause-overlay" class="modal-overlay hidden"><div class="modal-content"><h2>‰∏ÄÊôÇÂÅúÊ≠¢</h2><button id="retry-btn" class="modal-btn">„É™„Éà„É©„Ç§</button><button id="back-to-title-btn" class="modal-btn">„Çø„Ç§„Éà„É´„Å´Êàª„Çã</button><button id="close-pause-btn" class="modal-btn close-btn">Èñâ„Åò„Çã</button></div></div>
    <div id="confirm-overlay" class="modal-overlay hidden"><div class="modal-content"><h2 id="confirm-title">Á¢∫Ë™ç</h2><p id="confirm-message"></p><div id="confirm-buttons"><button id="confirm-no" class="confirm-btn">„ÅÑ„ÅÑ„Åà</button><button id="confirm-yes" class="confirm-btn">„ÅØ„ÅÑ</button></div></div></div>
    <div id="coin-info-overlay" class="modal-overlay hidden"><div class="modal-content"><h2>„Ç≥„Ç§„É≥</h2><p>Ê≠£Ëß£Êï∞„Å´Âøú„Åò„Å¶„ÇÇ„Çâ„Åà„Çã„ÄÅÁØÑÂõ≤‰∏äÈôê„ÄÅ„Ç∏„É£„É≥„É´„ÄÅÂΩ¢Âºè„ÅÆËß£Êîæ„Å´‰Ωø„ÅÜ‰ªÆÊÉ≥ÈÄöË≤®„ÄÇ</p><button id="close-coin-info-btn" class="modal-btn close-btn">Èñâ„Åò„Çã</button></div></div>
    <div id="result-overlay" class="modal-overlay hidden"><div class="modal-content"><h2 id="result-title">ÁµÇ‰∫ÜÔºÅ</h2><p id="result-message"></p><button id="close-result-btn" class="modal-btn close-btn">„Çø„Ç§„Éà„É´„Å∏</button></div></div>
    <div id="info-overlay" class="modal-overlay hidden"><div class="modal-content"><h2 id="info-title"></h2><p id="info-message"></p><button id="close-info-btn" class="modal-btn close-btn">Èñâ„Åò„Çã</button></div></div>
    <!-- Unlock Modals -->
    <div id="unlock-step1-overlay" class="modal-overlay hidden"><div class="modal-content"><h2>„É≠„ÉÉ„ÇØ‰∏≠</h2><p id="unlock-item-name">„Åì„ÅÆÈ†ÖÁõÆ„ÅØ„É≠„ÉÉ„ÇØ„Åï„Çå„Å¶„ÅÑ„Çã‚Ä¶</p><button id="unlock-next-btn" class="modal-btn">Ê¨°„Å∏</button></div></div>
    <div id="unlock-choice-overlay" class="modal-overlay hidden"><div class="modal-content"><h2 id="unlock-choice-title">„Ç¢„É≥„É≠„ÉÉ„ÇØÊñπÊ≥ï</h2><div id="unlock-choice-buttons"><button id="unlock-key-btn" class="modal-btn">Èçµüîë„ÅßËß£Êîæ (ü™ô√ó7)</button><button id="unlock-pick-btn" class="modal-btn">„Éî„ÉÉ„ÇØüß∑„ÅßËß£Êîæ (ü™ô√ó1)</button><button id="unlock-cancel-btn" class="modal-btn">„ÇÑ„Å£„Å±„ÇäËß£Êîæ„Åó„Å™„ÅÑ</button></div></div></div>
    <div id="pick-fail-overlay" class="modal-overlay hidden"><div class="modal-content"><h2>Â§±Êïó‚Ä¶</h2><p>„Éî„ÉÉ„ÇØ„ÅåÂ£ä„Çå„Å¶„Åó„Åæ„Å£„Åü‚Ä¶</p><div id="pick-fail-buttons"><button id="pick-fail-back-btn" class="modal-btn">ÊñπÊ≥ï„ÇíÂ§â„Åà„Çã</button><button id="pick-fail-retry-btn" class="modal-btn">üß∑„É™„Éà„É©„Ç§(ü™ô√ó1)</button><button id="pick-fail-close-btn" class="modal-btn close-btn">Èñâ„Åò„Çã</button></div></div></div>
    
    <!-- Format Modal -->
    <div id="format-overlay" class="modal-overlay hidden">
        <div class="modal-content">
            <h2>„Å©„ÅÆÂΩ¢Âºè„ÅßÈÅä„Å∂Ôºü</h2>
            <div id="format-selection-grid">
                <!-- Buttons are generated by JS to ensure correct order -->
            </div>
            <button id="close-format-btn" class="modal-btn close-btn">‰øùÂ≠ò„Åó„Å¶Èñâ„Åò„Çã</button>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settings-overlay" class="modal-overlay hidden">
        <div class="modal-content">
            <h2>Ë®≠ÂÆö</h2>
            <div class="setting-item">
                <div class="setting-item-title">ÂïèÈ°åÊï∞</div>
                 <div class="setting-controls">
                    <button class="btn-adjust btn-adjust-qc" data-amount="-100">-100</button><button class="btn-adjust btn-adjust-qc" data-amount="-50">-50</button><button class="btn-adjust btn-adjust-qc" data-amount="-25">-25</button><button class="btn-adjust btn-adjust-qc" data-amount="-10">-10</button><button class="btn-adjust btn-adjust-qc" data-amount="-5">-5</button><button class="btn-adjust btn-adjust-qc" data-amount="-1">-1</button>
                    <span id="question-count-value">10</span>
                    <button class="btn-adjust btn-adjust-qc" data-amount="1">+1</button><button class="btn-adjust btn-adjust-qc" data-amount="5">+5</button><button class="btn-adjust btn-adjust-qc" data-amount="10">+10</button><button class="btn-adjust btn-adjust-qc" data-amount="25">+25</button><button class="btn-adjust btn-adjust-qc" data-amount="50">+50</button><button class="btn-adjust btn-adjust-qc" data-amount="100">+100</button>
                </div>
                <button id="reset-qc-btn">„Éá„Éï„Ç©„É´„Éà„ÅÆÂïèÈ°åÊï∞„Å´Êàª„Åô</button>
            </div>

            <div class="setting-divider"></div>

            <div class="setting-item">
                 <div class="setting-item-title">Âà∂ÈôêÊôÇÈñì</div>
                 <div class="mode-buttons">
                    <button id="timer-mode-btn" class="mode-btn">„Ç™„Éï</button>
                 </div>
                 <div id="timer-controls" class="hidden">
                    <div class="setting-controls">
                        <button class="btn-adjust" data-target="timer" data-amount="-10">-10</button><button class="btn-adjust" data-target="timer" data-amount="-5">-5</button><button class="btn-adjust" data-target="timer" data-amount="-1">-1</button>
                        <span id="timer-value">10</span>
                        <button class="btn-adjust" data-target="timer" data-amount="1">+1</button><button class="btn-adjust" data-target="timer" data-amount="5">+5</button><button class="btn-adjust" data-target="timer" data-amount="10">+10</button>
                    </div>
                    <button id="reset-timer-btn">„Éá„Éï„Ç©„É´„Éà„ÅÆÂà∂ÈôêÊôÇÈñì„Å´Êàª„Åô</button>
                 </div>
            </div>

            <div class="setting-divider"></div>

            <div class="setting-item">
                <div class="setting-item-title">ÈÅ∏ÊäûËÇ¢Êï∞</div>
                <div id="choice-count-grid">
                    <button class="modal-btn choice-count-btn" data-count="4">4Êäû</button>
                    <button class="modal-btn choice-count-btn" data-count="8">8Êäû</button>
                    <button class="modal-btn choice-count-btn" data-count="12">12Êäû</button>
                    <button class="modal-btn choice-count-btn" data-count="16">16Êäû</button>
                    <button class="modal-btn choice-count-btn" data-count="20">20Êäû</button>
                    <button class="modal-btn choice-count-btn" data-count="24">24Êäû</button>
                </div>
            </div>
            
            <div class="setting-divider"></div>

            <div class="setting-item">
                <div class="setting-item-title">„É¢„Éº„Éâ</div>
                <div class="mode-buttons">
                    <button id="survival-mode-btn" class="mode-btn">„Çµ„Éê„Ç§„Éê„É´</button>
                    <button id="hardcore-mode-btn" class="mode-btn">„Éè„Éº„Éâ„Ç≥„Ç¢</button>
                    <button id="input-mode-btn" class="mode-btn">ÂÖ•Âäõ</button>
                </div>
            </div>

            <div id="survival-section" class="setting-item hidden">
                <div class="setting-item-title">--- „Çµ„Éê„Ç§„Éê„É´ ---</div>
                <div class="mode-buttons">
                     <button id="endless-mode-btn" class="mode-btn">„Ç®„É≥„Éâ„É¨„Çπ</button>
                </div>
            </div>

            <button id="close-settings-btn" class="modal-btn close-btn">‰øùÂ≠ò„Åó„Å¶Èñâ„Åò„Çã</button>
        </div>
    </div>


    <script>
        // Data with symbol, period, group
        const elements = [ {n:1,s:'H',name:"Ê∞¥Á¥†",p:1,gr:1,g:["typical"]},{n:2,s:'He',name:"„Éò„É™„Ç¶„É†",p:1,gr:18,g:["noble-gas","typical"]},{n:3,s:'Li',name:"„É™„ÉÅ„Ç¶„É†",p:2,gr:1,g:["alkali","typical"]},{n:4,s:'Be',name:"„Éô„É™„É™„Ç¶„É†",p:2,gr:2,g:["alkaline-earth","typical"]},{n:5,s:'B',name:"„Éõ„Ç¶Á¥†",p:2,gr:13,g:["typical"]},{n:6,s:'C',name:"ÁÇ≠Á¥†",p:2,gr:14,g:["typical"]},{n:7,s:'N',name:"Á™íÁ¥†",p:2,gr:15,g:["typical"]},{n:8,s:'O',name:"ÈÖ∏Á¥†",p:2,gr:16,g:["typical"]},{n:9,s:'F',name:"„Éï„ÉÉÁ¥†",p:2,gr:17,g:["halogen","typical"]},{n:10,s:'Ne',name:"„Éç„Ç™„É≥",p:2,gr:18,g:["noble-gas","typical"]},{n:11,s:'Na',name:"„Éä„Éà„É™„Ç¶„É†",p:3,gr:1,g:["alkali","typical"]},{n:12,s:'Mg',name:"„Éû„Ç∞„Éç„Ç∑„Ç¶„É†",p:3,gr:2,g:["alkaline-earth","typical"]},{n:13,s:'Al',name:"„Ç¢„É´„Éü„Éã„Ç¶„É†",p:3,gr:13,g:["typical"]},{n:14,s:'Si',name:"„Ç±„Ç§Á¥†",p:3,gr:14,g:["typical"]},{n:15,s:'P',name:"„É™„É≥",p:3,gr:15,g:["typical"]},{n:16,s:'S',name:"Á°´ÈªÑ",p:3,gr:16,g:["typical"]},{n:17,s:'Cl',name:"Â°©Á¥†",p:3,gr:17,g:["halogen","typical"]},{n:18,s:'Ar',name:"„Ç¢„É´„Ç¥„É≥",p:3,gr:18,g:["noble-gas","typical"]},{n:19,s:'K',name:"„Ç´„É™„Ç¶„É†",p:4,gr:1,g:["alkali","typical"]},{n:20,s:'Ca',name:"„Ç´„É´„Ç∑„Ç¶„É†",p:4,gr:2,g:["alkaline-earth","typical"]},{n:21,s:'Sc',name:"„Çπ„Ç´„É≥„Ç∏„Ç¶„É†",p:4,gr:3,g:["transition"]},{n:22,s:'Ti',name:"„ÉÅ„Çø„É≥",p:4,gr:4,g:["transition"]},{n:23,s:'V',name:"„Éê„Éä„Ç∏„Ç¶„É†",p:4,gr:5,g:["transition"]},{n:24,s:'Cr',name:"„ÇØ„É≠„É†",p:4,gr:6,g:["transition"]},{n:25,s:'Mn',name:"„Éû„É≥„Ç¨„É≥",p:4,gr:7,g:["transition"]},{n:26,s:'Fe',name:"ÈâÑ",p:4,gr:8,g:["transition"]},{n:27,s:'Co',name:"„Ç≥„Éê„É´„Éà",p:4,gr:9,g:["transition"]},{n:28,s:'Ni',name:"„Éã„ÉÉ„Ç±„É´",p:4,gr:10,g:["transition"]},{n:29,s:'Cu',name:"ÈäÖ",p:4,gr:11,g:["transition"]},{n:30,s:'Zn',name:"‰∫úÈâõ",p:4,gr:12,g:["transition"]},{n:31,s:'Ga',name:"„Ç¨„É™„Ç¶„É†",p:4,gr:13,g:["typical"]},{n:32,s:'Ge',name:"„Ç≤„É´„Éû„Éã„Ç¶„É†",p:4,gr:14,g:["typical"]},{n:33,s:'As',name:"„ÉíÁ¥†",p:4,gr:15,g:["typical"]},{n:34,s:'Se',name:"„Çª„É¨„É≥",p:4,gr:16,g:["typical"]},{n:35,s:'Br',name:"Ëá≠Á¥†",p:4,gr:17,g:["halogen","typical"]},{n:36,s:'Kr',name:"„ÇØ„É™„Éó„Éà„É≥",p:4,gr:18,g:["noble-gas","typical"]},{n:37,s:'Rb',name:"„É´„Éì„Ç∏„Ç¶„É†",p:5,gr:1,g:["alkali","typical"]},{n:38,s:'Sr',name:"„Çπ„Éà„É≠„É≥„ÉÅ„Ç¶„É†",p:5,gr:2,g:["alkaline-earth","typical"]},{n:39,s:'Y',name:"„Ç§„ÉÉ„Éà„É™„Ç¶„É†",p:5,gr:3,g:["transition"]},{n:40,s:'Zr',name:"„Ç∏„É´„Ç≥„Éã„Ç¶„É†",p:5,gr:4,g:["transition"]},{n:41,s:'Nb',name:"„Éã„Ç™„Éñ",p:5,gr:5,g:["transition"]},{n:42,s:'Mo',name:"„É¢„É™„Éñ„Éá„É≥",p:5,gr:6,g:["transition"]},{n:43,s:'Tc',name:"„ÉÜ„ÇØ„Éç„ÉÅ„Ç¶„É†",p:5,gr:7,g:["transition"]},{n:44,s:'Ru',name:"„É´„ÉÜ„Éã„Ç¶„É†",p:5,gr:8,g:["transition"]},{n:45,s:'Rh',name:"„É≠„Ç∏„Ç¶„É†",p:5,gr:9,g:["transition"]},{n:46,s:'Pd',name:"„Éë„É©„Ç∏„Ç¶„É†",p:5,gr:10,g:["transition"]},{n:47,s:'Ag',name:"ÈäÄ",p:5,gr:11,g:["transition"]},{n:48,s:'Cd',name:"„Ç´„Éâ„Éü„Ç¶„É†",p:5,gr:12,g:["transition"]},{n:49,s:'In',name:"„Ç§„É≥„Ç∏„Ç¶„É†",p:5,gr:13,g:["typical"]},{n:50,s:'Sn',name:"„Çπ„Ç∫",p:5,gr:14,g:["typical"]},{n:51,s:'Sb',name:"„Ç¢„É≥„ÉÅ„É¢„É≥",p:5,gr:15,g:["typical"]},{n:52,s:'Te',name:"„ÉÜ„É´„É´",p:5,gr:16,g:["typical"]},{n:53,s:'I',name:"„É®„Ç¶Á¥†",p:5,gr:17,g:["halogen","typical"]},{n:54,s:'Xe',name:"„Ç≠„Çª„Éé„É≥",p:5,gr:18,g:["noble-gas","typical"]},{n:55,s:'Cs',name:"„Çª„Ç∑„Ç¶„É†",p:6,gr:1,g:["alkali","typical"]},{n:56,s:'Ba',name:"„Éê„É™„Ç¶„É†",p:6,gr:2,g:["alkaline-earth","typical"]},{n:57,s:'La',name:"„É©„É≥„Çø„É≥",p:6,gr:null,g:["lanthanoid","transition"]},{n:58,s:'Ce',name:"„Çª„É™„Ç¶„É†",p:6,gr:null,g:["lanthanoid","transition"]},{n:59,s:'Pr',name:"„Éó„É©„Çª„Ç™„Ç∏„É†",p:6,gr:null,g:["lanthanoid","transition"]},{n:60,s:'Nd',name:"„Éç„Ç™„Ç∏„É†",p:6,gr:null,g:["lanthanoid","transition"]},{n:61,s:'Pm',name:"„Éó„É≠„É°„ÉÅ„Ç¶„É†",p:6,gr:null,g:["lanthanoid","transition"]},{n:62,s:'Sm',name:"„Çµ„Éû„É™„Ç¶„É†",p:6,gr:null,g:["lanthanoid","transition"]},{n:63,s:'Eu',name:"„É¶„Ç¶„É≠„Éî„Ç¶„É†",p:6,gr:null,g:["lanthanoid","transition"]},{n:64,s:'Gd',name:"„Ç¨„Éâ„É™„Éã„Ç¶„É†",p:6,gr:null,g:["lanthanoid","transition"]},{n:65,s:'Tb',name:"„ÉÜ„É´„Éì„Ç¶„É†",p:6,gr:null,g:["lanthanoid","transition"]},{n:66,s:'Dy',name:"„Ç∏„Çπ„Éó„É≠„Ç∑„Ç¶„É†",p:6,gr:null,g:["lanthanoid","transition"]},{n:67,s:'Ho',name:"„Éõ„É´„Éü„Ç¶„É†",p:6,gr:null,g:["lanthanoid","transition"]},{n:68,s:'Er',name:"„Ç®„É´„Éì„Ç¶„É†",p:6,gr:null,g:["lanthanoid","transition"]},{n:69,s:'Tm',name:"„ÉÑ„É™„Ç¶„É†",p:6,gr:null,g:["lanthanoid","transition"]},{n:70,s:'Yb',name:"„Ç§„ÉÉ„ÉÜ„É´„Éì„Ç¶„É†",p:6,gr:null,g:["lanthanoid","transition"]},{n:71,s:'Lu',name:"„É´„ÉÜ„ÉÅ„Ç¶„É†",p:6,gr:null,g:["lanthanoid","transition"]},{n:72,s:'Hf',name:"„Éè„Éï„Éã„Ç¶„É†",p:6,gr:4,g:["transition"]},{n:73,s:'Ta',name:"„Çø„É≥„Çø„É´",p:6,gr:5,g:["transition"]},{n:74,s:'W',name:"„Çø„É≥„Ç∞„Çπ„ÉÜ„É≥",p:6,gr:6,g:["transition"]},{n:75,s:'Re',name:"„É¨„Éã„Ç¶„É†",p:6,gr:7,g:["transition"]},{n:76,s:'Os',name:"„Ç™„Çπ„Éü„Ç¶„É†",p:6,gr:8,g:["transition"]},{n:77,s:'Ir',name:"„Ç§„É™„Ç∏„Ç¶„É†",p:6,gr:9,g:["transition"]},{n:78,s:'Pt',name:"ÁôΩÈáë",p:6,gr:10,g:["transition"]},{n:79,s:'Au',name:"Èáë",p:6,gr:11,g:["transition"]},{n:80,s:'Hg',name:"Ê∞¥ÈäÄ",p:6,gr:12,g:["transition"]},{n:81,s:'Tl',name:"„Çø„É™„Ç¶„É†",p:6,gr:13,g:["typical"]},{n:82,s:'Pb',name:"Èâõ",p:6,gr:14,g:["typical"]},{n:83,s:'Bi',name:"„Éì„Çπ„Éû„Çπ",p:6,gr:15,g:["typical"]},{n:84,s:'Po',name:"„Éù„É≠„Éã„Ç¶„É†",p:6,gr:16,g:["typical"]},{n:85,s:'At',name:"„Ç¢„Çπ„Çø„ÉÅ„É≥",p:6,gr:17,g:["halogen","typical"]},{n:86,s:'Rn',name:"„É©„Éâ„É≥",p:6,gr:18,g:["noble-gas","typical"]},{n:87,s:'Fr',name:"„Éï„É©„É≥„Ç∑„Ç¶„É†",p:7,gr:1,g:["alkali","typical"]},{n:88,s:'Ra',name:"„É©„Ç∏„Ç¶„É†",p:7,gr:2,g:["alkaline-earth","typical"]},{n:89,s:'Ac',name:"„Ç¢„ÇØ„ÉÅ„Éã„Ç¶„É†",p:7,gr:null,g:["actinoid","transition"]},{n:90,s:'Th',name:"„Éà„É™„Ç¶„É†",p:7,gr:null,g:["actinoid","transition"]},{n:91,s:'Pa',name:"„Éó„É≠„Éà„Ç¢„ÇØ„ÉÅ„Éã„Ç¶„É†",p:7,gr:null,g:["actinoid","transition"]},{n:92,s:'U',name:"„Ç¶„É©„É≥",p:7,gr:null,g:["actinoid","transition"]},{n:93,s:'Np',name:"„Éç„Éó„ÉÑ„Éã„Ç¶„É†",p:7,gr:null,g:["actinoid","transition"]},{n:94,s:'Pu',name:"„Éó„É´„Éà„Éã„Ç¶„É†",p:7,gr:null,g:["actinoid","transition"]},{n:95,s:'Am',name:"„Ç¢„É°„É™„Ç∑„Ç¶„É†",p:7,gr:null,g:["actinoid","transition"]},{n:96,s:'Cm',name:"„Ç≠„É•„É™„Ç¶„É†",p:7,gr:null,g:["actinoid","transition"]},{n:97,s:'Bk',name:"„Éê„Éº„ÇØ„É™„Ç¶„É†",p:7,gr:null,g:["actinoid","transition"]},{n:98,s:'Cf',name:"„Ç´„É™„Éõ„É´„Éã„Ç¶„É†",p:7,gr:null,g:["actinoid","transition"]},{n:99,s:'Es',name:"„Ç¢„Ç§„É≥„Çπ„Çø„Ç§„Éã„Ç¶„É†",p:7,gr:null,g:["actinoid","transition"]},{n:100,s:'Fm',name:"„Éï„Çß„É´„Éü„Ç¶„É†",p:7,gr:null,g:["actinoid","transition"]},{n:101,s:'Md',name:"„É°„É≥„Éá„É¨„Éì„Ç¶„É†",p:7,gr:null,g:["actinoid","transition"]},{n:102,s:'No',name:"„Éé„Éº„Éô„É™„Ç¶„É†",p:7,gr:null,g:["actinoid","transition"]},{n:103,s:'Lr',name:"„É≠„Éº„É¨„É≥„Ç∑„Ç¶„É†",p:7,gr:null,g:["actinoid","transition"]},{n:104,s:'Rf',name:"„É©„Ç∂„Éõ„Éº„Ç∏„Ç¶„É†",p:7,gr:4,g:["transition"]},{n:105,s:'Db',name:"„Éâ„Éñ„Éã„Ç¶„É†",p:7,gr:5,g:["transition"]},{n:106,s:'Sg',name:"„Ç∑„Éº„Éú„Éº„ÇÆ„Ç¶„É†",p:7,gr:6,g:["transition"]},{n:107,s:'Bh',name:"„Éú„Éº„É™„Ç¶„É†",p:7,gr:7,g:["transition"]},{n:108,s:'Hs',name:"„Éè„ÉÉ„Ç∑„Ç¶„É†",p:7,gr:8,g:["transition"]},{n:109,s:'Mt',name:"„Éû„Ç§„Éà„Éç„É™„Ç¶„É†",p:7,gr:9,g:["transition"]},{n:110,s:'Ds',name:"„ÉÄ„Éº„É†„Çπ„Çø„ÉÅ„Ç¶„É†",p:7,gr:10,g:["transition"]},{n:111,s:'Rg',name:"„É¨„É≥„Éà„Ç≤„Éã„Ç¶„É†",p:7,gr:11,g:["transition"]},{n:112,s:'Cn',name:"„Ç≥„Éö„É´„Éã„Ç∑„Ç¶„É†",p:7,gr:12,g:["transition"]},{n:113,s:'Nh',name:"„Éã„Éõ„Éã„Ç¶„É†",p:7,gr:13,g:["typical"]},{n:114,s:'Fl',name:"„Éï„É¨„É≠„Éì„Ç¶„É†",p:7,gr:14,g:["typical"]},{n:115,s:'Mc',name:"„É¢„Çπ„Ç≥„Éì„Ç¶„É†",p:7,gr:15,g:["typical"]},{n:116,s:'Lv',name:"„É™„Éê„É¢„É™„Ç¶„É†",p:7,gr:16,g:["typical"]},{n:117,s:'Ts',name:"„ÉÜ„Éç„Ç∑„É≥",p:7,gr:17,g:["halogen","typical"]},{n:118,s:'Og',name:"„Ç™„Ç¨„Éç„ÇΩ„É≥",p:7,gr:18,g:["noble-gas","typical"]} ].map(e => ({number: e.n, symbol: e.s, name: e.name, period: e.p, group: e.gr, genres: e.g}));
        
        const genreData = { "transition": "ÈÅ∑ÁßªÂÖÉÁ¥†", "typical": "ÂÖ∏ÂûãÂÖÉÁ¥†", "alkali": "„Ç¢„É´„Ç´„É™ÈáëÂ±û", "alkaline-earth": "„Ç¢„É´„Ç´„É™ÂúüÈ°ûÈáëÂ±û", "halogen": "„Éè„É≠„Ç≤„É≥", "noble-gas": "Ë≤¥„Ç¨„Çπ", "lanthanoid": "„É©„É≥„Çø„Éé„Ç§„Éâ", "actinoid": "„Ç¢„ÇØ„ÉÅ„Éé„Ç§„Éâ" };
        const genreKeys = Object.keys(genreData);

        const formatData = {
            'number-to-name': { text: 'ÂéüÂ≠êÁï™Âè∑‚ÜíÂÖÉÁ¥†Âêç', classNum: 1, color: 'red' },
            'number-to-symbol': { text: 'ÂéüÂ≠êÁï™Âè∑‚ÜíÂÖÉÁ¥†Ë®òÂè∑', classNum: 2, color: '#ff69b4' },
            'number-to-period-group': { text: 'ÂéüÂ≠êÁï™Âè∑‚ÜíÂë®Êúü„ÉªÊóè', classNum: 3, color: '#c71585' },
            'symbol-to-number': { text: 'ÂÖÉÁ¥†Ë®òÂè∑‚ÜíÂéüÂ≠êÁï™Âè∑', classNum: 4, color: 'blue' },
            'symbol-to-name': { text: 'ÂÖÉÁ¥†Ë®òÂè∑‚ÜíÂÖÉÁ¥†Âêç', classNum: 5, color: 'purple' },
            'symbol-to-period-group': { text: 'ÂÖÉÁ¥†Ë®òÂè∑‚ÜíÂë®Êúü„ÉªÊóè', classNum: 6, color: '#4b0082' },
            'name-to-number': { text: 'ÂÖÉÁ¥†Âêç‚ÜíÂéüÂ≠êÁï™Âè∑', classNum: 7, color: '#ffd700' },
            'name-to-symbol': { text: 'ÂÖÉÁ¥†Âêç‚ÜíÂÖÉÁ¥†Ë®òÂè∑', classNum: 8, color: '#90ee90' },
            'name-to-period-group': { text: 'ÂÖÉÁ¥†Âêç‚ÜíÂë®Êúü„ÉªÊóè', classNum: 9, color: '#800000' },
            'period-group-to-number': { text: 'Âë®Êúü„ÉªÊóè‚ÜíÂéüÂ≠êÁï™Âè∑', classNum: 10, color: 'green' },
            'period-group-to-symbol': { text: 'Âë®Êúü„ÉªÊóè‚ÜíÂÖÉÁ¥†Ë®òÂè∑', classNum: 11, color: 'orange' },
            'period-group-to-name': { text: 'Âë®Êúü„ÉªÊóè‚ÜíÂÖÉÁ¥†Âêç', classNum: 12, color: '#b0c4de' },
        };
        const formatOrder = [
            'number-to-name', 'number-to-symbol', 'number-to-period-group',
            'symbol-to-number', 'symbol-to-name', 'symbol-to-period-group',
            'name-to-number', 'name-to-symbol', 'name-to-period-group',
            'period-group-to-number', 'period-group-to-symbol', 'period-group-to-name'
        ];

        // DOM Elements
        const get = (selector) => document.querySelector(selector);
        const getAll = (selector) => document.querySelectorAll(selector);
        const titleScreen=get('#title-screen'),quizScreen=get('#quiz-screen'),coinDisplay=get('#coin-display'),minValueEl=get('#min-value'),maxValueEl=get('#max-value'),startButton=get('#start-button'),formatButton=get('#format-button'),upgradeRangeBtn=get('#upgrade-range-btn'),optionsGrid=get('#options-grid'),questionDisplayEl=get('#question-display'),questionTextEl=get('#question-text'),progressTextEl=get('#progress-text'),scoreTextEl=get('#score-text'),genreSelector=get('#genre-selector'),pauseButton=get('#pause-button'),abortButton=get('#abort-button'),timerDisplay=get('#timer-display'),settingsBtn=get('#settings-btn'),pauseOverlay=get('#pause-overlay'),closePauseButton=get('#close-pause-btn'),retryButton=get('#retry-btn'),backToTitleButton=get('#back-to-title-btn'),confirmOverlay=get('#confirm-overlay'),confirmTitleEl=get('#confirm-title'),confirmMessageEl=get('#confirm-message'),confirmYesBtn=get('#confirm-yes'),confirmNoBtn=get('#confirm-no'),coinInfoOverlay=get('#coin-info-overlay'),closeCoinInfoBtn=get('#close-coin-info-btn'),resultOverlay=get('#result-overlay'),resultMessageEl=get('#result-message'),closeResultBtn=get('#close-result-btn'),infoOverlay=get('#info-overlay'),infoTitleEl=get('#info-title'),infoMessageEl=get('#info-message'),closeInfoBtn=get('#close-info-btn'),unlockStep1Overlay=get('#unlock-step1-overlay'),unlockItemNameEl=get('#unlock-item-name'),unlockNextBtn=get('#unlock-next-btn'),unlockChoiceOverlay=get('#unlock-choice-overlay'),unlockKeyBtn=get('#unlock-key-btn'),unlockPickBtn=get('#unlock-pick-btn'),unlockCancelBtn=get('#unlock-cancel-btn'),settingsOverlay=get('#settings-overlay'),closeSettingsBtn=get('#close-settings-btn'),questionCountValueEl=get('#question-count-value'),resetRangeBtn=get('#reset-range-btn'),resetQcBtn=get('#reset-qc-btn'),endlessModeBtn=get('#endless-mode-btn'),inputModeBtn=get('#input-mode-btn'),pickFailOverlay=get('#pick-fail-overlay'),pickFailBackBtn=get('#pick-fail-back-btn'),pickFailRetryBtn=get('#pick-fail-retry-btn'),pickFailCloseBtn=get('#pick-fail-close-btn'),formatOverlay=get('#format-overlay'),closeFormatBtn=get('#close-format-btn'),formatSelectionGrid=get('#format-selection-grid'),inputArea=get('#input-area'),answerInput=get('#answer-input'),submitAnswerBtn=get('#submit-answer-btn'),timerModeBtn=get('#timer-mode-btn'),timerControls=get('#timer-controls'),timerValueEl=get('#timer-value'),resetTimerBtn=get('#reset-timer-btn'),choiceCountGrid=get('#choice-count-grid'),livesDisplay=get('#lives-display'),survivalModeBtn=get('#survival-mode-btn'),hardcoreModeBtn=get('#hardcore-mode-btn'),survivalSection=get('#survival-section');

        // Game State
        let min = 1, max = 20, totalCoins = 0, questionCount = 10, isEndlessMode = false, isInputMode = false, currentQuestions = [], questionIndex = 0, score = 0, isAnswered = false, confirmAction = null, confirmNoAction = null, currentUpgradeLevel = 0, unlockedMaxRange = 20, unlockedGenres = {}, selectedGenres = new Set(), selectedFormats = new Set(), unlockedFormats = {}, timerEnabled = false, timerDuration = 10, choiceCount = 12, quizTimer = null, abortTimer = null, isSurvivalMode = false, isHardcoreMode = false, lives = 0;
        let infoCloseCallback = null;
        let formatButtonInterval = null;
        
        // Local Storage Keys
        const COIN_KEY='a_coins',FIB_BONUS_KEY='a_fib',N2_BONUS_KEY='a_n2',RANGE_UPGRADE_KEY='a_range',GENRE_UNLOCK_KEY='a_genres',QC_KEY='a_qc',ENDLESS_KEY='a_endless',FORMAT_KEY='a_formats',FORMAT_UNLOCK_KEY='a_format_unlocks', INPUT_KEY='a_input', TIMER_ENABLED_KEY='a_timer_enabled', TIMER_DURATION_KEY='a_timer_duration', CHOICE_COUNT_KEY='a_choice_count', SURVIVAL_KEY='a_survival', HARDCORE_KEY='a_hardcore';
        const upgradeTiers = [ { max: 20, cost: 0 }, { max: 36, cost: 5 }, { max: 54, cost: 5 }, { max: 71, cost: 7 }, { max: 103, cost: 10 }, { max: 118, cost: 15 } ];
        
        // --- Functions ---
        const save = (key, value) => localStorage.setItem(key, JSON.stringify(value instanceof Set ? Array.from(value) : value));
        const load = (key, defaultValue) => {
            const val = localStorage.getItem(key);
            if(val === null) return defaultValue;
            const parsed = JSON.parse(val);
            if(Array.isArray(parsed) && (key === FORMAT_KEY || key === 'a_genres_selected')) return new Set(parsed); 
            if(key === FORMAT_KEY && typeof parsed === 'string') return new Set([parsed]); // Handle legacy single format
            return parsed;
        };
        
        function loadGameData() {
            totalCoins = load(COIN_KEY, 5);
            currentUpgradeLevel = load(RANGE_UPGRADE_KEY, 0);
            unlockedGenres = load(GENRE_UNLOCK_KEY, {});
            unlockedFormats = load(FORMAT_UNLOCK_KEY, {});
            unlockedFormats['number-to-name'] = true;
            unlockedFormats['symbol-to-name'] = true;
            questionCount = load(QC_KEY, 10);
            isEndlessMode = load(ENDLESS_KEY, false);
            isInputMode = load(INPUT_KEY, false);
            selectedFormats = load(FORMAT_KEY, new Set(['number-to-name']));
            if(selectedFormats.size === 0) selectedFormats.add('number-to-name');
            timerEnabled = load(TIMER_ENABLED_KEY, false);
            timerDuration = load(TIMER_DURATION_KEY, 10);
            choiceCount = load(CHOICE_COUNT_KEY, 12);
            isSurvivalMode = load(SURVIVAL_KEY, false);
            isHardcoreMode = load(HARDCORE_KEY, false);
            unlockedMaxRange = upgradeTiers[currentUpgradeLevel].max;
            buildFormatButtons();
            updateAllDisplays();
        }
        const updateAllDisplays = () => { updateCoinDisplay(); updateUpgradeButton(); updateRangeDisplay(); renderGenreButtons(); updateQuestionCountDisplay(); updateSurvivalModeUI(); updateHardcoreModeUI(); updateInputModeDisplay(); updateMainFormatButton(); updateTimerSettingsUI(); updateChoiceCountUI(); };
        function updateCoinDisplay() { coinDisplay.textContent = `ü™ô√ó${totalCoins}`; save(COIN_KEY, totalCoins); }
        function updateUpgradeButton() { if (currentUpgradeLevel >= upgradeTiers.length - 1) { upgradeRangeBtn.textContent = 'ÁØÑÂõ≤„ÅØÊúÄÂ§ß„Åß„Åô'; upgradeRangeBtn.disabled = true; } else { upgradeRangeBtn.textContent = `ÁØÑÂõ≤‰∏äÈôêUP (ü™ô√ó${upgradeTiers[currentUpgradeLevel + 1].cost})`; upgradeRangeBtn.disabled = false; } }
        function updateRangeDisplay() { minValueEl.textContent = min; maxValueEl.textContent = max; }
        function updateQuestionCountDisplay() { questionCountValueEl.textContent = questionCount; }
        
        function updateSurvivalModeUI() {
            survivalModeBtn.classList.toggle('active', isSurvivalMode);
            survivalSection.classList.toggle('hidden', !isSurvivalMode);
            updateEndlessModeDisplay();
        }
        
        function updateHardcoreModeUI() {
            hardcoreModeBtn.classList.toggle('active', isHardcoreMode);
            document.body.classList.toggle('hardcore', isHardcoreMode);
            startButton.classList.toggle('hardcore-active', isHardcoreMode);
        }

        function updateEndlessModeDisplay() {
            endlessModeBtn.classList.toggle('active', isEndlessMode && isSurvivalMode);
            startButton.classList.toggle('endless-active', isEndlessMode && isSurvivalMode);
        }
        function updateInputModeDisplay() { inputModeBtn.classList.toggle('active', isInputMode); }
        
        function adjustRange(target, amount) {
            if (target === 'min') {
                let newMin = min + amount;
                min = Math.max(1, Math.min(newMin, max - 1));
            } else { // target === 'max'
                let newMax = max + amount;
                max = Math.max(min + 1, Math.min(newMax, unlockedMaxRange));
            }
            updateRangeDisplay();
        }

        function adjustQuestionCount(amount) {
            questionCount = Math.max(1, Math.min(200, questionCount + amount));
            updateQuestionCountDisplay();
        }

        const shuffleArray = (array) => { for (let i = array.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [array[i], array[j]] = [array[j], array[i]]; } return array; };
        
        function startGame() {
            questionIndex = 0; score = 0; isAnswered = false;
            let availableElements = elements.filter(el => el.number >= min && el.number <= max);
            
            const hasPeriodGroupFormat = Array.from(selectedFormats).some(f => f.includes('period-group'));
            if (hasPeriodGroupFormat) {
                availableElements = availableElements.filter(el => el.group !== null);
            }

            if (selectedGenres.size > 0) {
                const filteredByGenre = availableElements.filter(el => el.genres.some(g => selectedGenres.has(g)));
                if (filteredByGenre.length === 0) {
                    const selectedGenreNames = Array.from(selectedGenres).map(g => genreData[g]).join(', ');
                    showInfoPopup('„Ç®„É©„Éº', `ÊåáÂÆö„Åó„ÅüÁØÑÂõ≤„Å´„Äå${selectedGenreNames}„Äç„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì„Åß„Åó„Åü„ÄÇ`);
                    return;
                }
                availableElements = filteredByGenre;
            }

            if (availableElements.length === 0) {
                showInfoPopup('„Ç®„É©„Éº', '„Åì„ÅÆÁØÑÂõ≤„Éª„Ç∏„É£„É≥„É´„ÉªÂΩ¢Âºè„Å´Ë©≤ÂΩì„Åô„ÇãÂÖÉÁ¥†„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ'); return;
            }
            
            if (isEndlessMode && isSurvivalMode) {
                currentQuestions = shuffleArray(availableElements);
                lives = 1;
            } else if (isSurvivalMode) {
                lives = 3;
            }

            if (!isEndlessMode) {
                if (availableElements.length >= questionCount) {
                    currentQuestions = shuffleArray(availableElements).slice(0, questionCount);
                } else {
                    let questions = [...availableElements];
                    while (questions.length < questionCount) {
                        questions.push(availableElements[Math.floor(Math.random() * availableElements.length)]);
                    }
                    currentQuestions = shuffleArray(questions);
                }
            }
            
            pauseButton.classList.toggle('hidden', timerEnabled);
            abortButton.classList.toggle('hidden', !timerEnabled);

            titleScreen.classList.add('hidden'); quizScreen.classList.remove('hidden'); displayQuestion();
        }
        
        let getCorrectAnswerString;
        let activeQuizFormat;

        function displayQuestion() {
            isAnswered = false; 
            if ((!isEndlessMode || isHardcoreMode) && questionIndex >= currentQuestions.length) { 
                showResult(); 
                return; 
            }
            
            let currentQ = currentQuestions[questionIndex % currentQuestions.length]; 
            
            const availableFormats = Array.from(selectedFormats);
            do {
                activeQuizFormat = availableFormats[Math.floor(Math.random() * availableFormats.length)];
            } while(activeQuizFormat.includes('period-group') && currentQ.group === null);

            
            questionDisplayEl.classList.remove('period-group-q');
            
            const formatMappings = {
                'number-to-name': { qText: 'ÂéüÂ≠êÁï™Âè∑', qDisplay: 'number', aText: 'ÂÖÉÁ¥†Âêç„ÅßÁ≠î„Åà„Çà„ÄÇ', getAnswer: el => el.name, getOption: el => el.name },
                'number-to-symbol': { qText: 'ÂéüÂ≠êÁï™Âè∑', qDisplay: 'number', aText: 'ÂÖÉÁ¥†Ë®òÂè∑„ÅßÁ≠î„Åà„Çà„ÄÇ', getAnswer: el => el.symbol, getOption: el => el.symbol },
                'number-to-period-group': { qText: 'ÂéüÂ≠êÁï™Âè∑', qDisplay: 'number', aText: 'Âë®Êúü„ÉªÊóè„ÅßÁ≠î„Åà„Çà„ÄÇ\n(‰æã: Á¨¨1Âë®Êúü„Éª1Êóè)', getAnswer: el => `Á¨¨${el.period}Âë®Êúü„Éª${el.group}Êóè`, getOption: el => `Á¨¨${el.period}Âë®Êúü„Éª${el.group}Êóè` },
                'symbol-to-name': { qText: 'ÂÖÉÁ¥†Ë®òÂè∑', qDisplay: 'symbol', aText: 'ÂÖÉÁ¥†Âêç„ÅßÁ≠î„Åà„Çà„ÄÇ', getAnswer: el => el.name, getOption: el => el.name },
                'symbol-to-number': { qText: 'ÂÖÉÁ¥†Ë®òÂè∑', qDisplay: 'symbol', aText: 'ÂéüÂ≠êÁï™Âè∑„ÅßÁ≠î„Åà„Çà„ÄÇ', getAnswer: el => String(el.number), getOption: el => el.number },
                'symbol-to-period-group': { qText: 'ÂÖÉÁ¥†Ë®òÂè∑', qDisplay: 'symbol', aText: 'Âë®Êúü„ÉªÊóè„ÅßÁ≠î„Åà„Çà„ÄÇ\n(‰æã: Á¨¨1Âë®Êúü„Éª1Êóè)', getAnswer: el => `Á¨¨${el.period}Âë®Êúü„Éª${el.group}Êóè`, getOption: el => `Á¨¨${el.period}Âë®Êúü„Éª${el.group}Êóè` },
                'name-to-number': { qText: 'ÂÖÉÁ¥†Âêç', qDisplay: 'name', aText: 'ÂéüÂ≠êÁï™Âè∑„ÅßÁ≠î„Åà„Çà„ÄÇ', getAnswer: el => String(el.number), getOption: el => el.number },
                'name-to-symbol': { qText: 'ÂÖÉÁ¥†Âêç', qDisplay: 'name', aText: 'ÂÖÉÁ¥†Ë®òÂè∑„ÅßÁ≠î„Åà„Çà„ÄÇ', getAnswer: el => el.symbol, getOption: el => el.symbol },
                'name-to-period-group': { qText: 'ÂÖÉÁ¥†Âêç', qDisplay: 'name', aText: 'Âë®Êúü„ÉªÊóè„ÅßÁ≠î„Åà„Çà„ÄÇ\n(‰æã: Á¨¨1Âë®Êúü„Éª1Êóè)', getAnswer: el => `Á¨¨${el.period}Âë®Êúü„Éª${el.group}Êóè`, getOption: el => `Á¨¨${el.period}Âë®Êúü„Éª${el.group}Êóè` },
                'period-group-to-name': { qText: 'Âë®Êúü„ÉªÊóè', qDisplay: el => `Á¨¨${el.period}Âë®Êúü„Éª${el.group}Êóè`, aText: 'ÂÖÉÁ¥†Âêç„ÅßÁ≠î„Åà„Çà„ÄÇ', getAnswer: el => el.name, getOption: el => el.name, isPg: true },
                'period-group-to-symbol': { qText: 'Âë®Êúü„ÉªÊóè', qDisplay: el => `Á¨¨${el.period}Âë®Êúü„Éª${el.group}Êóè`, aText: 'ÂÖÉÁ¥†Ë®òÂè∑„ÅßÁ≠î„Åà„Çà„ÄÇ', getAnswer: el => el.symbol, getOption: el => el.symbol, isPg: true },
                'period-group-to-number': { qText: 'Âë®Êúü„ÉªÊóè', qDisplay: el => `Á¨¨${el.period}Âë®Êúü„Éª${el.group}Êóè`, aText: 'ÂéüÂ≠êÁï™Âè∑„ÅßÁ≠î„Åà„Çà„ÄÇ', getAnswer: el => String(el.number), getOption: el => el.number, isPg: true },
            };
            
            const currentFormat = formatMappings[activeQuizFormat];
            const questionDisplay = typeof currentFormat.qDisplay === 'function' ? currentFormat.qDisplay(currentQ) : currentQ[currentFormat.qDisplay];
            getCorrectAnswerString = () => currentFormat.getAnswer(currentQ);
            
            if (currentFormat.isPg) questionDisplayEl.classList.add('period-group-q');
            
            questionTextEl.textContent = isInputMode ? currentFormat.aText.replace('\n', ' ') : currentFormat.qText;
            questionDisplayEl.textContent = questionDisplay;
            
            optionsGrid.classList.toggle('hidden', isInputMode);
            inputArea.classList.toggle('hidden', !isInputMode);

            if (!isInputMode) {
                let options = [currentQ];
                let potentialOptions = elements.filter(el => el.number !== currentQ.number);
                if (activeQuizFormat.includes('period-group')) {
                    potentialOptions = potentialOptions.filter(el => el.group !== null);
                }
                const otherElements = shuffleArray(potentialOptions);

                for (let i = 0; options.length < choiceCount && i < otherElements.length; i++) { options.push(otherElements[i]); }
                
                optionsGrid.innerHTML = ''; 
                shuffleArray(options).forEach(option => { 
                    const button = document.createElement('button'); 
                    button.textContent = currentFormat.getOption(option);
                    button.className = 'option-btn'; 
                    button.dataset.number = option.number; 
                    button.addEventListener('click', checkAnswer); 
                    optionsGrid.appendChild(button); 
                });
            } else {
                answerInput.placeholder = currentFormat.aText.split('\n')[1] || "Á≠î„Åà„ÇíÂÖ•Âäõ";
                answerInput.value = '';
                answerInput.classList.remove('correct', 'incorrect');
                answerInput.focus();
            }
            updateInfo();
            startTimer();
        }

        function updateInfo() {
            if(isEndlessMode) { progressTextEl.textContent = `Q.${score + 1}`; } else { progressTextEl.textContent = `Q.${questionIndex + 1} / ${currentQuestions.length}`; }
            scoreTextEl.textContent = `Score: ${score}`;

            if(isSurvivalMode) {
                 livesDisplay.textContent = `‚ù§Ô∏è √ó ${lives}`;
            } else {
                 livesDisplay.textContent = '';
            }
        }
        
        function handleAnswer(isCorrect) {
            clearInterval(quizTimer);
            if (isCorrect) {
                score++;
            } else {
                if(isHardcoreMode) {
                    setTimeout(showResult, 1500);
                    return;
                }
                if(isSurvivalMode) {
                    lives--;
                    if(lives <= 0) {
                        setTimeout(showResult, 1500);
                        return;
                    }
                }
            }

            if (!isCorrect && isEndlessMode && isSurvivalMode) {
                setTimeout(showResult, 1500);
                return;
            }

             setTimeout(() => {
                questionIndex++;
                displayQuestion();
            }, 1500);
        }

        function checkAnswer(e) {
            if (isAnswered) return; isAnswered = true;
            const selectedButton = e.target;
            const correctNumber = currentQuestions[questionIndex % currentQuestions.length].number;
            const isCorrect = parseInt(selectedButton.dataset.number) === correctNumber;
            selectedButton.classList.add(isCorrect ? 'correct' : 'incorrect');
            if (!isCorrect) get(`[data-number="${correctNumber}"]`)?.classList.add('correct');
            handleAnswer(isCorrect);
        }

        function checkInputAction() {
            if (isAnswered) return; isAnswered = true;
            const userAnswer = answerInput.value.trim();
            const correctAnswer = getCorrectAnswerString();
            const isCorrect = userAnswer.toLowerCase() === correctAnswer.toLowerCase();
            answerInput.classList.add(isCorrect ? 'correct' : 'incorrect');
            if(!isCorrect) answerInput.value = correctAnswer;
            handleAnswer(isCorrect);
        }
        
        function showResult() {
            let earnedCoins = 0;
            if (isHardcoreMode) {
                const allCorrect = score === currentQuestions.length;
                earnedCoins = allCorrect ? Math.floor(score / 2) : 0;
            } else if (isSurvivalMode && isEndlessMode) {
                earnedCoins = Math.floor((score / 2) * (score/3));
            } else if (isSurvivalMode) {
                earnedCoins = Math.floor(score / 2) + lives;
            } else {
                earnedCoins = Math.floor(score / 2);
            }
            totalCoins += earnedCoins; 
            updateCoinDisplay(); 
            resultMessageEl.textContent = `Ê≠£Ëß£Êï∞: ${score}Âïè\n„Ç≥„Ç§„É≥„Çí ${earnedCoins} ÊûöÁç≤Âæó„Åó„Åæ„Åó„ÅüÔºÅ`; 
            resultOverlay.classList.remove('hidden'); 
        }
        function showTitleScreen() { quizScreen.classList.add('hidden'); titleScreen.classList.remove('hidden'); getAll('.modal-overlay').forEach(el => el.classList.add('hidden')); }
        
        function showInfoPopup(title, message, buttonText = 'Èñâ„Åò„Çã', callback = null) {
            infoTitleEl.textContent = title;
            infoMessageEl.textContent = message;
            closeInfoBtn.textContent = buttonText;
            infoCloseCallback = callback;
            infoOverlay.classList.remove('hidden');
        }

        function showConfirmPopup(message, action, title = "Á¢∫Ë™ç", noAction = null) {
            confirmTitleEl.textContent = title;
            confirmMessageEl.textContent = message;
            confirmAction = action;
            confirmNoAction = noAction;
            confirmOverlay.classList.remove('hidden');
        }
        
        function handleUpgrade() {
            if (currentUpgradeLevel >= upgradeTiers.length - 1) return; const nextTier = upgradeTiers[currentUpgradeLevel + 1];
            showConfirmPopup(`ü™ô√ó${nextTier.cost}„ÅßÁØÑÂõ≤Êã°Âºµ„Çí„Åó„Åæ„Åô„ÅãÔºü`, () => {
                if (totalCoins >= nextTier.cost) {
                    totalCoins -= nextTier.cost;
                    currentUpgradeLevel++;
                    unlockedMaxRange = upgradeTiers[currentUpgradeLevel].max;
                    save(RANGE_UPGRADE_KEY, currentUpgradeLevel);
                    updateCoinDisplay();
                    updateUpgradeButton();
                    showInfoPopup("ÁØÑÂõ≤Êã°Âºµ", `ÊúÄÂ§ß${unlockedMaxRange}„Åæ„ÅßË®≠ÂÆöÂèØËÉΩ„Å´„Å™„Çä„Åæ„Åó„ÅüÔºÅ`);
                } else { showInfoPopup("„Ç≥„Ç§„É≥‰∏çË∂≥", "„Ç≥„Ç§„É≥„ÅåË∂≥„Çä„Åæ„Åõ„Çì„ÄÇ"); }
            }, "ÁØÑÂõ≤Êã°Âºµ");
        }
        
        function renderGenreButtons() {
            genreSelector.innerHTML = '';
            genreKeys.forEach(key => {
                const btn = document.createElement('button');
                btn.dataset.genre = key;
                btn.textContent = genreData[key];
                btn.className = `genre-btn ${key}`;
                if (!unlockedGenres[key]) {
                    btn.classList.add('locked', 'locked-item');
                } else if (!selectedGenres.has(key)) {
                    btn.classList.add('deselected');
                }
                genreSelector.appendChild(btn);
            });
        }
        
        let unlockTarget = { type: null, key: null, name: '' };

        function handleGenreClick(e) {
            const btn = e.target.closest('.genre-btn'); if (!btn) return;
            const genre = btn.dataset.genre;
            if (btn.classList.contains('locked')) {
                unlockTarget = { type: 'genre', key: genre, name: genreData[genre] };
                unlockItemNameEl.textContent = `„Ç∏„É£„É≥„É´„Äå${unlockTarget.name}„Äç„ÅØ„É≠„ÉÉ„ÇØ„Åï„Çå„Å¶„ÅÑ„Åæ„Åô‚Ä¶`;
                unlockStep1Overlay.classList.remove('hidden');
            } else {
                if (selectedGenres.has(genre)) {
                    selectedGenres.delete(genre);
                    btn.classList.add('deselected');
                } else {
                    selectedGenres.add(genre);
                    btn.classList.remove('deselected');
                }
            }
        }
        
        function showUnlockChoicePopup() { unlockChoiceOverlay.classList.remove('hidden'); }

        function attemptUnlock(method) {
            if (!unlockTarget.type) return;
            const cost = method === 'key' ? 7 : 1;
            if (totalCoins < cost) { showInfoPopup("„Ç≥„Ç§„É≥‰∏çË∂≥", "„Ç≥„Ç§„É≥„ÅåË∂≥„Çä„Åæ„Åõ„Çì„ÄÇ"); return; }
            totalCoins -= cost;
            updateCoinDisplay();
            const success = method === 'key' ? true : Math.random() <= 0.18;
            
            if (success) {
                if(unlockTarget.type === 'genre') {
                    unlockedGenres[unlockTarget.key] = true;
                    save(GENRE_UNLOCK_KEY, unlockedGenres);
                    renderGenreButtons();
                    showInfoPopup("ÊàêÂäüÔºÅ", `„Ç∏„É£„É≥„É´„Äå${unlockTarget.name}„Äç„ÅÆ„Ç¢„É≥„É≠„ÉÉ„ÇØ„Å´ÊàêÂäü„Åó„Åæ„Åó„ÅüÔºÅ`);
                } else if (unlockTarget.type === 'format') {
                    unlockedFormats[unlockTarget.key] = true;
                    save(FORMAT_UNLOCK_KEY, unlockedFormats);
                    showInfoPopup("ÊàêÂäüÔºÅ", `ÂΩ¢Âºè„Äå${unlockTarget.name}„Äç„ÅÆ„Ç¢„É≥„É≠„ÉÉ„ÇØ„Å´ÊàêÂäü„Åó„Åæ„Åó„ÅüÔºÅ`, 'ÂΩ¢Âºè‰∏ÄË¶ß„Å´Êàª„Çã', () => {
                        updateFormatButtons();
                        formatOverlay.classList.remove('hidden');
                    });
                }
            } else {
                pickFailOverlay.classList.remove('hidden');
            }
        }
        
        function handleCoinClick() {
            if (min === 11 && max === 23 && !load(FIB_BONUS_KEY)) { totalCoins += 112; save(FIB_BONUS_KEY, true); showInfoPopup('Èö†„Åó„Éú„Éº„Éä„ÇπÔºÅ', '„Éï„Ç£„Éú„Éä„ÉÉ„ÉÅ„Éú„Éº„Éä„Çπ„Åß 112 „Ç≥„Ç§„É≥Áç≤ÂæóÔºÅ'); updateCoinDisplay(); return; }
            if (min === 12 && max === 48 && !load(N2_BONUS_KEY)) { totalCoins += 128; save(N2_BONUS_KEY, true); showInfoPopup('Èö†„Åó„Éú„Éº„Éä„ÇπÔºÅ', '2‚Åø‚Åª¬π„Éú„Éº„Éä„Çπ„Åß 128 „Ç≥„Ç§„É≥Áç≤ÂæóÔºÅ'); updateCoinDisplay(); return; }
            coinInfoOverlay.classList.remove('hidden');
        }
        
        function setDefaultRange() { min = 1; max = unlockedMaxRange >= 36 ? 36 : 20; updateRangeDisplay(); }
        
        function buildFormatButtons() {
            formatSelectionGrid.innerHTML = '';
            formatOrder.forEach(key => {
                const format = formatData[key];
                const btn = document.createElement('button');
                btn.className = `format-btn format-btn-${format.classNum}`;
                btn.dataset.format = key;
                btn.textContent = format.text;
                formatSelectionGrid.appendChild(btn);
            });
        }
        
        function updateFormatButtons() {
            getAll('#format-selection-grid .format-btn').forEach(btn => {
                const format = btn.dataset.format;
                btn.classList.remove('locked', 'selected', 'deselected', 'locked-item');
                if (!unlockedFormats[format]) {
                    btn.classList.add('locked', 'locked-item');
                } else {
                    if (selectedFormats.has(format)) {
                        btn.classList.add('selected');
                    } else {
                        btn.classList.add('deselected');
                    }
                }
            });
            updateMainFormatButton();
        }

        function updateMainFormatButton() {
            clearInterval(formatButtonInterval);
            const selectedArray = Array.from(selectedFormats);
            const colors = selectedArray.map(key => formatData[key]?.color).filter(Boolean);
            const lightColorTexts = ['#ffd700', '#90ee90', '#b0c4de'];
            
            if (colors.length === 0) {
                 formatButton.style.background = 'var(--light-gray)';
                 formatButton.style.color = 'var(--text-color)';
            } else if (colors.length === 1) {
                formatButton.style.background = colors[0];
                formatButton.style.color = lightColorTexts.includes(colors[0]) ? 'black' : 'white';
            } else {
                let colorIndex = 0;
                const updateColor = () => {
                    const currentColor = colors[colorIndex];
                    formatButton.style.background = currentColor;
                    formatButton.style.color = lightColorTexts.includes(currentColor) ? 'black' : 'white';
                    colorIndex = (colorIndex + 1) % colors.length;
                };
                updateColor();
                formatButtonInterval = setInterval(updateColor, 1000);
            }
        }
        
        function updateTimerSettingsUI() {
            timerModeBtn.textContent = timerEnabled ? '„Ç™„É≥' : '„Ç™„Éï';
            timerModeBtn.classList.toggle('active', timerEnabled);
            timerControls.classList.toggle('hidden', !timerEnabled);
            timerValueEl.textContent = timerDuration;
        }

        function adjustTimer(amount) {
            timerDuration = Math.max(3, Math.min(45, timerDuration + amount));
            updateTimerSettingsUI();
        }
        
        function updateChoiceCountUI() {
            getAll('.choice-count-btn').forEach(btn => {
                btn.classList.toggle('selected', parseInt(btn.dataset.count) === choiceCount);
            });
            optionsGrid.style.gridTemplateColumns = `repeat(${Math.min(choiceCount/2, 4)}, 1fr)`;
        }

        function startTimer() {
            clearInterval(quizTimer);
            if (!timerEnabled) {
                timerDisplay.textContent = '';
                return;
            }
            let timeLeft = timerDuration;
            timerDisplay.textContent = `${timeLeft}s`;
            quizTimer = setInterval(() => {
                timeLeft--;
                timerDisplay.textContent = `${timeLeft}s`;
                if (timeLeft <= 0) {
                    clearInterval(quizTimer);
                    if (!isAnswered) {
                        isAnswered = true;
                        if(isInputMode) {
                            answerInput.classList.add('incorrect');
                            answerInput.value = getCorrectAnswerString();
                        } else {
                             const correctNumber = currentQuestions[questionIndex % currentQuestions.length].number;
                             get(`[data-number="${correctNumber}"]`)?.classList.add('correct');
                        }
                        handleAnswer(false);
                    }
                }
            }, 1000);
        }

        // --- Event Listeners ---
        getAll('.btn-adjust').forEach(button => button.addEventListener('click', (e) => {
            const target = e.target.dataset.target;
            const amount = parseInt(e.target.dataset.amount);
            if(target === 'timer') adjustTimer(amount);
            else adjustRange(target, amount);
        }));
        getAll('.btn-adjust-qc').forEach(button => button.addEventListener('click', (e) => adjustQuestionCount(parseInt(e.target.dataset.amount))));
        startButton.addEventListener('click', startGame);
        upgradeRangeBtn.addEventListener('click', handleUpgrade);
        genreSelector.addEventListener('click', handleGenreClick);
        pauseButton.addEventListener('click', () => pauseOverlay.classList.remove('hidden'));
        retryButton.addEventListener('click', () => showConfirmPopup('„É™„Éà„É©„Ç§„Åó„Åæ„Åô„ÅãÔºü', () => { pauseOverlay.classList.add('hidden'); startGame(); }));
        backToTitleButton.addEventListener('click', () => showConfirmPopup('„Çø„Ç§„Éà„É´„Å´Êàª„Çä„Åæ„Åô„ÅãÔºü', showTitleScreen));
        
        confirmYesBtn.addEventListener('click', () => { if (confirmAction) confirmAction(); confirmAction = null; confirmNoAction = null; confirmOverlay.classList.add('hidden'); });
        confirmNoBtn.addEventListener('click', () => { if (confirmNoAction) confirmNoAction(); confirmAction = null; confirmNoAction = null; confirmOverlay.classList.add('hidden'); });

        coinDisplay.addEventListener('click', handleCoinClick);
        
        closePauseButton.addEventListener('click', () => pauseOverlay.classList.add('hidden'));
        closeCoinInfoBtn.addEventListener('click', () => coinInfoOverlay.classList.add('hidden'));
        closeResultBtn.addEventListener('click', showTitleScreen);
        closeInfoBtn.addEventListener('click', () => {
            infoOverlay.classList.add('hidden');
            if (infoCloseCallback) {
                infoCloseCallback();
                infoCloseCallback = null;
            }
        });
        
        // Unlock Flow
        unlockNextBtn.addEventListener('click', () => {
            unlockStep1Overlay.classList.add('hidden'); 
            const noAction = unlockTarget.type === 'format' ? () => {updateFormatButtons(); formatOverlay.classList.remove('hidden');} : null;
            showConfirmPopup("üîë„Åãüß∑„Åß„É≠„ÉÉ„ÇØËß£Èô§„Åó„Å¶„Åø„Åæ„Åô„ÅãÔºü", showUnlockChoicePopup, "Á¢∫Ë™ç", noAction);
        });
        
        const backToUnlockChoice = () => {
            showUnlockChoicePopup();
        };

        unlockKeyBtn.addEventListener('click', () => { unlockChoiceOverlay.classList.add('hidden'); showConfirmPopup(`Èçµüîë„ÅßÊú¨ÂΩì„Å´Ëß£Êîæ„Åó„Åæ„Åô„ÅãÔºü (ü™ô√ó7)`, () => attemptUnlock('key'), "Á¢∫Ë™ç", backToUnlockChoice); });
        unlockPickBtn.addEventListener('click', () => { unlockChoiceOverlay.classList.add('hidden'); showConfirmPopup(`„Éî„ÉÉ„ÇØüß∑„ÅßÊú¨ÂΩì„Å´Ëß£Êîæ„Åó„Åæ„Åô„ÅãÔºü (ü™ô√ó1)`, () => attemptUnlock('pick'), "Á¢∫Ë™ç", backToUnlockChoice); });
        unlockCancelBtn.addEventListener('click', () => { 
            unlockChoiceOverlay.classList.add('hidden');
            if(unlockTarget.type === 'format') {
                updateFormatButtons();
                formatOverlay.classList.remove('hidden');
            }
        });
        
        // Settings
        settingsBtn.addEventListener('click', () => settingsOverlay.classList.remove('hidden'));
        closeSettingsBtn.addEventListener('click', () => { save(QC_KEY, questionCount); save(INPUT_KEY, isInputMode); save(TIMER_ENABLED_KEY, timerEnabled); save(TIMER_DURATION_KEY, timerDuration); save(CHOICE_COUNT_KEY, choiceCount); save(SURVIVAL_KEY, isSurvivalMode); save(HARDCORE_KEY, isHardcoreMode); save(ENDLESS_KEY, isEndlessMode); settingsOverlay.classList.add('hidden'); });
        resetRangeBtn.addEventListener('click', setDefaultRange);
        resetQcBtn.addEventListener('click', () => adjustQuestionCount(10 - questionCount));
        
        survivalModeBtn.addEventListener('click', () => { 
            isSurvivalMode = !isSurvivalMode; 
            if(isSurvivalMode) isHardcoreMode = false;
            updateSurvivalModeUI();
            updateHardcoreModeUI();
        });
         hardcoreModeBtn.addEventListener('click', () => { 
            isHardcoreMode = !isHardcoreMode; 
            if(isHardcoreMode) {
                isSurvivalMode = false;
                isEndlessMode = false;
            }
            updateHardcoreModeUI();
            updateSurvivalModeUI();
        });

        endlessModeBtn.addEventListener('click', () => { 
            isEndlessMode = !isEndlessMode; 
            updateEndlessModeDisplay(); 
        });

        inputModeBtn.addEventListener('click', () => { isInputMode = !isInputMode; updateInputModeDisplay(); });
        timerModeBtn.addEventListener('click', () => { timerEnabled = !timerEnabled; updateTimerSettingsUI(); });
        resetTimerBtn.addEventListener('click', () => { timerDuration = 10; updateTimerSettingsUI(); });
        choiceCountGrid.addEventListener('click', (e) => {
            if(e.target.classList.contains('choice-count-btn')) {
                choiceCount = parseInt(e.target.dataset.count);
                updateChoiceCountUI();
            }
        });
        
        // Pick Fail
        pickFailBackBtn.addEventListener('click', () => { pickFailOverlay.classList.add('hidden'); showUnlockChoicePopup(); });
        pickFailRetryBtn.addEventListener('click', () => { pickFailOverlay.classList.add('hidden'); showConfirmPopup(`Êú¨ÂΩì„Å´„É™„Éà„É©„Ç§„Åó„Åæ„Åô„ÅãÔºü (ü™ô√ó1)`, () => attemptUnlock('pick')); });
        pickFailCloseBtn.addEventListener('click', () => pickFailOverlay.classList.add('hidden'));

        // Format
        formatButton.addEventListener('click', () => { updateFormatButtons(); formatOverlay.classList.remove('hidden'); });
        closeFormatBtn.addEventListener('click', () => { save(FORMAT_KEY, selectedFormats); save(FORMAT_UNLOCK_KEY, unlockedFormats); formatOverlay.classList.add('hidden'); });
        formatSelectionGrid.addEventListener('click', (e) => {
            const btn = e.target.closest('.format-btn');
            if(!btn) return;
            const formatKey = btn.dataset.format;

            if (btn.classList.contains('locked')) {
                formatOverlay.classList.add('hidden');
                unlockTarget = { type: 'format', key: formatKey, name: btn.textContent.trim() };
                unlockItemNameEl.textContent = `ÂΩ¢Âºè„Äå${unlockTarget.name}„Äç„ÅØ„É≠„ÉÉ„ÇØ„Åï„Çå„Å¶„ÅÑ„Åæ„Åô‚Ä¶`;
                unlockStep1Overlay.classList.remove('hidden');
            } else {
                 if (selectedFormats.has(formatKey)) {
                    if (selectedFormats.size > 1) {
                        selectedFormats.delete(formatKey);
                    } else {
                        formatOverlay.classList.add('hidden');
                        showInfoPopup('Ê≥®ÊÑè', 'ÂΩ¢Âºè„ÅØÂ∞ë„Å™„Åè„Å®„ÇÇ‰∏Ä„Å§‰ª•‰∏äË®≠ÂÆö„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ','ÂΩ¢Âºè‰∏ÄË¶ß„Å´Êàª„Çã', () => {
                            updateFormatButtons();
                            formatOverlay.classList.remove('hidden');
                        });
                    }
                } else {
                    selectedFormats.add(formatKey);
                }
                 updateFormatButtons(); 
            }
        });
        
        // Input Mode Listeners
        submitAnswerBtn.addEventListener('click', checkInputAction);
        answerInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                checkInputAction();
            }
        });

        // Abort button
        abortButton.addEventListener('mousedown', () => {
            abortTimer = setTimeout(showTitleScreen, 1000);
            abortButton.classList.add('holding');
        });
         abortButton.addEventListener('touchstart', (e) => {
            e.preventDefault();
            abortTimer = setTimeout(showTitleScreen, 1000);
            abortButton.classList.add('holding');
        });
        abortButton.addEventListener('mouseup', () => {
            clearTimeout(abortTimer);
            abortButton.classList.remove('holding');
        });
        abortButton.addEventListener('mouseleave', () => {
            clearTimeout(abortTimer);
            abortButton.classList.remove('holding');
        });
        abortButton.addEventListener('touchend', () => {
            clearTimeout(abortTimer);
            abortButton.classList.remove('holding');
        });


        // --- Initial setup ---
        document.addEventListener('DOMContentLoaded', loadGameData);

    </script>
</body>
</html>

