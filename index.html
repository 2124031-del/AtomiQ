<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åŸå­ç•ªå·ã‚¯ã‚¤ã‚º</title>
    <style>
        :root {
            --primary-bg: #0a0d2e; /* é»’å¼·ã‚ã®ç´ºè‰² */
            --secondary-bg: #191d47; /* æš—ã‚ã®ç´ºè‰² */
            --accent-color: #4E5476;
            --text-color: #e8eaf6;
            --correct-color: #4caf50;
            --incorrect-color: #f44336;
            --coin-color: #ffd700;
            --lemon-color-dark: #FBC02D; /* æ¿ƒã„ãƒ¬ãƒ¢ãƒ³è‰² */
            --dark-gray: #424242;
            --light-gray: #757575;
            --font-family: 'Helvetica Neue', 'Arial', 'Hiragino Kaku Gothic ProN', 'Hiragino Sans', 'Meiryo', sans-serif;
            --angle: 0deg;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        html, body { width: 100%; height: 100%; overflow: hidden; }
        body { background-color: var(--primary-bg); color: var(--text-color); font-family: var(--font-family); display: flex; justify-content: center; align-items: center; text-align: center; user-select: none; transition: background-color 0.5s; }
        .container { width: 100%; max-width: 800px; height: 100%; padding: 20px; display: flex; flex-direction: column; justify-content: center; position: relative; }
        .screen { width: 100%; height: 100%; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .hidden { display: none !important; }

        /* --- Title Screen --- */
        #title-screen h1 { font-size: 2.5rem; margin-bottom: 20px; }
        #top-right-controls { position: absolute; top: 20px; right: 20px; display: flex; flex-direction: column; align-items: flex-end; gap: 10px; z-index: 10; }
        #coin-display { background-color: var(--secondary-bg); padding: 8px 15px; border-radius: 20px; font-size: 1.2rem; font-weight: bold; color: var(--coin-color); cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.2); transition: transform 0.2s; }
        #coin-display:hover { transform: scale(1.05); }
        #settings-btn { background: var(--secondary-bg); border: none; color: var(--text-color); font-size: 1.5rem; width: 40px; height: 40px; border-radius: 50%; cursor: pointer; display: flex; justify-content: center; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.2); transition: transform 0.2s; }
        #settings-btn:hover { transform: scale(1.1); }


        .config-box { background-color: var(--secondary-bg); padding: 20px; border-radius: 15px; margin-bottom: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.3); width: 100%; max-width: 700px; display: flex; flex-direction: column; gap: 15px;}
        .range-controls-wrapper { display: flex; justify-content: center; align-items: center; flex-wrap: wrap; gap: 20px; }
        .range-control { display: flex; align-items: center; gap: 10px; }
        .range-label { font-size: 1.5rem; font-weight: bold; }
        .range-value { font-size: 2rem; font-weight: bold; width: 70px; }
        .btn-adjust-group { display: flex; }
        .btn-adjust { background-color: var(--accent-color); color: var(--text-color); border: none; border-radius: 8px; padding: 10px 12px; font-size: 1rem; cursor: pointer; margin: 0 4px; transition: transform 0.1s, background-color 0.2s; }
        .config-buttons { display: flex; justify-content: center; gap: 10px; flex-wrap: wrap; }
        #upgrade-range-btn, #element-ledger-btn { background-color: var(--lemon-color-dark); color: #333; border: none; padding: 10px 20px; font-size: 1rem; border-radius: 10px; cursor: pointer; transition: all 0.2s; font-weight: bold; }
        #element-ledger-btn { background-color: #90ee90; }
        #upgrade-range-btn:disabled { background-color: #ccc; color: #888; cursor: not-allowed; }
        #reset-range-btn { background-color: var(--dark-gray); color: var(--text-color); border: none; padding: 10px 20px; font-size: 1rem; border-radius: 10px; cursor: pointer; transition: all 0.2s; font-weight: bold; }
        
        .genre-label { font-size: 1rem; color: #bdbdbd; margin-bottom: -5px; }
        #genre-selector { display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; margin-top: 5px; }
        .genre-btn { padding: 8px 12px; border: none; border-radius: 8px; font-size: 0.9rem; cursor: pointer; font-weight: bold; transition: all 0.2s; position: relative; }
        .genre-btn.deselected { background-color: var(--light-gray) !important; color: #ccc !important; }
        .genre-btn.transition { background-color: #ff7043; color: white; } .genre-btn.typical { background-color: #29b6f6; color: white; } .genre-btn.alkali { background-color: #f44336; color: white; } .genre-btn.alkaline-earth { background-color: #ffeb3b; color: #333; } .genre-btn.halogen { background-color: #aeea00; color: #333; } .genre-btn.noble-gas { background-color: #00bcd4; color: white; } .genre-btn.lanthanoid { background-color: #ffca28; color: #333; } .genre-btn.actinoid { background-color: #90a4ae; color: white; }
        .locked-item::after { content: 'ğŸ”’'; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 1.5rem; opacity: 0.7; z-index: 3; }
        .genre-btn.locked { background-color: var(--dark-gray) !important; color: #9e9e9e !important; cursor: pointer; }

        .action-buttons-container { display: flex; justify-content: center; align-items: center; gap: 20px; margin-top: 10px; }
        .action-btn { border: none; padding: 15px 40px; font-size: 1.5rem; border-radius: 50px; cursor: pointer; transition: background-color 1s ease-in-out, color 1s ease-in-out, box-shadow 0.3s; font-weight: bold; letter-spacing: 2px; }
        #format-button { background-color: var(--light-gray); color: var(--text-color); }
        #start-button { background-color: var(--correct-color); color: white; text-transform: uppercase; }
        #start-button.endless-active { animation: endless-glow 2s infinite; }
        
        /* --- Quiz Screen --- */
        #quiz-header { width: 100%; display: flex; justify-content: space-between; align-items: center; padding: 0 10px; position: absolute; top: 20px; left: 0; }
        #quiz-header-side { display: flex; flex-direction: column; align-items: flex-start; }
        .info-text { font-size: 1.2rem; }
        #lives-display { color: #ff5252; font-weight: bold; }
        #timer-display { position: absolute; top: 20px; left: 50%; transform: translateX(-50%); font-size: 1.5rem; font-weight: bold; }
        #pause-button { background: none; border: none; cursor: pointer; padding: 10px; }
        #pause-icon { fill: var(--text-color); width: 32px; height: 32px; }
        #abort-button { background-color: var(--incorrect-color); color: white; padding: 10px 20px; border-radius: 8px; font-weight: bold; border: none; cursor: pointer; position: relative; overflow: hidden; }
        #abort-button::before { content: ''; position: absolute; top: 0; left: 0; width: 0; height: 100%; background-color: rgba(255,255,255,0.3); transition: width 1s linear; }
        #abort-button.holding::before { width: 100%; }
        #question-display { font-size: 7rem; font-weight: bold; line-height: 1; }
        .period-group-q { font-size: 4rem !important; }
        #options-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; width: 100%; }
        .option-btn { background-color: var(--accent-color); color: var(--text-color); border: 2px solid transparent; border-radius: 12px; padding: 15px; font-size: 1.2rem; cursor: pointer; transition: all 0.2s; word-break: keep-all; }
        .option-btn.correct { background-color: var(--correct-color); }
        .option-btn.incorrect { background-color: var(--incorrect-color); opacity: 0.7; }

        /* Input Mode */
        #input-area { width: 100%; max-width: 400px; display: flex; flex-direction: column; align-items: center; gap: 15px; }
        #answer-input { width: 100%; padding: 15px; font-size: 1.5rem; border-radius: 10px; border: 2px solid var(--accent-color); background-color: #fff; color: #000; text-align: center; }
        #answer-input.correct { border-color: var(--correct-color); background-color: #e8f5e9; }
        #answer-input.incorrect { border-color: var(--incorrect-color); background-color: #ffebee; }
        #submit-answer-btn { width: 100%; padding: 15px; font-size: 1.2rem; border-radius: 10px; border: none; background-color: var(--correct-color); color: white; cursor: pointer; font-weight: bold; }


        /* --- Modals --- */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.7); display: flex; justify-content: center; align-items: center; z-index: 1000; }
        .modal-content { background-color: var(--secondary-bg); padding: 30px; border-radius: 20px; width: 90%; max-width: 500px; box-shadow: 0 5px 20px rgba(0,0,0,0.4); display: flex; flex-direction: column; align-items: center; gap: 20px;}
        .modal-content h2 { margin-bottom: 0; font-size: 2rem; }
        .modal-content p { font-size: 1.1rem; margin-bottom: 0; line-height: 1.6; }
        .modal-btn { display: block; width: 100%; padding: 15px; margin-bottom: 15px; font-size: 1.2rem; border-radius: 12px; border: none; cursor: pointer; background-color: var(--accent-color); color: var(--text-color); transition: background-color 0.2s; }
        .modal-btn.close-btn { background-color: var(--light-gray); margin-bottom: 0; }
        .confirm-btn { padding: 10px 30px; font-size: 1rem; border: none; border-radius: 8px; cursor: pointer; min-width: 100px; }
        #confirm-buttons { display: flex; justify-content: space-around; width: 100%; }
        #unlock-key-btn { background-color: var(--coin-color); color: #333; font-weight: bold; }
        #unlock-pick-btn { background-color: #BDBDBD; color: #333; font-weight: bold; }
        #unlock-cancel-btn { background-color: var(--incorrect-color); color: white; font-weight: bold; }
        #pick-fail-retry-btn { background-color: var(--accent-color); }
        #pick-fail-back-btn { background-color: var(--accent-color); }

        /* Format Modal */
        #format-overlay .modal-content { max-width: 800px; }
        #format-selection-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; width: 100%;}
        .format-btn { padding: 18px; font-size: 1rem; border-radius: 10px; border: 2px solid transparent; cursor: pointer; font-weight: bold; transition: all 0.2s; position: relative; word-break: keep-all; white-space: nowrap;}
        .format-btn.selected { border-color: #fff; }
        .format-btn.deselected { background-image: none !important; background-color: var(--light-gray) !important; color: #ccc !important; }
        .format-btn.locked { background-image: none !important; background-color: var(--dark-gray) !important; color: #9e9e9e !important; cursor: pointer; }

        .format-btn-1 { background-color: red; color: white; }
        .format-btn-2 { background-color: #ff69b4; color: white; }
        .format-btn-3 { background-color: #c71585; color: white; }
        .format-btn-4 { background-color: blue; color: white; }
        .format-btn-5 { background-color: purple; color: white; }
        .format-btn-6 { background-color: #4b0082; color: white; }
        .format-btn-7 { background-color: #ffd700; color: #333; }
        .format-btn-8 { background-color: #90ee90; color: #333; }
        .format-btn-9 { background-color: #800000; color: white; }
        .format-btn-10 { background-color: green; color: white; }
        .format-btn-11 { background-color: orange; color: white; }
        .format-btn-12 { background-color: #b0c4de; color: #333; }
        
        /* Settings Modal Specific */
        #settings-overlay .modal-content { max-height: 80vh; overflow-y: auto; }
        #settings-overlay .modal-content { max-width: 700px; }
        .setting-divider { width: 80%; border-top: 1px solid var(--accent-color); margin: 15px 0; }
        .setting-item { display: flex; flex-direction: column; align-items: center; gap: 10px; width: 100%; }
        .setting-item-title { font-size: 1.2rem; font-weight: bold; margin-bottom: 5px; color: var(--coin-color); }
        .setting-item-title::before, .setting-item-title::after { content: '---'; margin: 0 10px; }
        #question-count-value, #timer-value { font-size: 1.5rem; font-weight: bold; width: 60px; text-align: center; }
        .setting-controls { display: flex; align-items: center; justify-content: center; flex-wrap: nowrap; gap: 5px; width: 100%; }
        .btn-adjust-qc { flex-shrink: 0; padding: 5px 8px; font-size: 0.8rem; }
        #reset-qc-btn, #reset-timer-btn { background-color: var(--dark-gray); color: var(--text-color); border: none; padding: 8px 15px; font-size: 0.9rem; border-radius: 8px; cursor: pointer; margin-top: 5px; }
        
        .mode-buttons { display: flex; gap: 15px; }
        .mode-btn { background-color: var(--light-gray); color: #ccc; border: none; padding: 10px 25px; font-size: 1rem; font-weight: bold; border-radius: 8px; cursor: pointer; transition: all 0.3s; }
        .mode-btn.active { background-color: #29b6f6; color: white; }
        #survival-mode-btn.active { background-color: orange; color: white;}
        #hardcore-mode-btn.active {
            background: purple;
            animation: hardcore-bg-glow 2s infinite ease-in-out;
        }
        #endless-mode-btn.active { animation: endless-glow 2s infinite; }
        
        #choice-count-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
        .choice-count-btn { background-color: var(--accent-color); }
        .choice-count-btn.selected { border: 2px solid var(--coin-color); }

        body.hardcore {
            --primary-bg: #2c0b2c;
            --secondary-bg: #4c114c;
        }
        #start-button.hardcore-active {
            animation: hardcore-bg-glow 2s infinite ease-in-out;
            background-color: purple;
        }
        
        @keyframes hardcore-bg-glow {
            0%, 100% { background-color: #3b0f3b; box-shadow: 0 0 10px #ff00ff, 0 0 20px #ff00ff; }
            50% { background-color: #000; box-shadow: 0 0 20px #8a2be2, 0 0 30px #8a2be2; }
        }
        @keyframes endless-glow {
            0%, 100% { background-color: #c62828; color: white; box-shadow: 0 0 8px #ff5252, 0 0 12px #ff1744; }
            50% { background-color: #a02020; color: #e0e0e0; box-shadow: 0 0 12px #c62828, 0 0 18px #a02020, 0 0 24px #000; }
        }
        
        @media (max-width: 850px) {
             #format-selection-grid { grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));}
        }
        @media (max-width: 600px) { #title-screen h1 { font-size: 2rem; } #question-display { font-size: 5rem; } #options-grid { grid-template-columns: repeat(2, 1fr); } }
    </style>
</head>
<body>

    <div class="container">
        <!-- Title Screen -->
        <div id="title-screen" class="screen">
            <div id="top-right-controls">
                <div id="coin-display">ğŸª™Ã—0</div>
                <button id="settings-btn">âš™ï¸</button>
            </div>
            <h1>åŸå­ç•ªå·ã‚¯ã‚¤ã‚º</h1>
            <div class="config-box">
                <div class="range-controls-wrapper">
                    <div class="range-control">
                        <span class="range-label">Min:</span><span id="min-value" class="range-value">1</span>
                        <div class="btn-adjust-group">
                            <button class="btn-adjust" data-target="min" data-amount="-50">-50</button><button class="btn-adjust" data-target="min" data-amount="-10">-10</button><button class="btn-adjust" data-target="min" data-amount="-5">-5</button><button class="btn-adjust" data-target="min" data-amount="-1">-1</button>
                            <button class="btn-adjust" data-target="min" data-amount="1">+1</button><button class="btn-adjust" data-target="min" data-amount="5">+5</button><button class="btn-adjust" data-target="min" data-amount="10">+10</button><button class="btn-adjust" data-target="min" data-amount="50">+50</button>
                        </div>
                    </div>
                    <div class="range-control">
                        <span class="range-label">Max:</span><span id="max-value" class="range-value">20</span>
                         <div class="btn-adjust-group">
                            <button class="btn-adjust" data-target="max" data-amount="-50">-50</button><button class="btn-adjust" data-target="max" data-amount="-10">-10</button><button class="btn-adjust" data-target="max" data-amount="-5">-5</button><button class="btn-adjust" data-target="max" data-amount="-1">-1</button>
                            <button class="btn-adjust" data-target="max" data-amount="1">+1</button><button class="btn-adjust" data-target="max" data-amount="5">+5</button><button class="btn-adjust" data-target="max" data-amount="10">+10</button><button class="btn-adjust" data-target="max" data-amount="50">+50</button>
                        </div>
                    </div>
                </div>
                <div class="config-buttons">
                    <button id="upgrade-range-btn">ç¯„å›²ä¸Šé™up</button>
                    <button id="reset-range-btn">ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ç¯„å›²ã«æˆ»ã™</button>
                </div>
                <p class="genre-label">ã‚¸ãƒ£ãƒ³ãƒ«ï¼ˆä»»æ„ï¼‰ï¼ˆè¤‡æ•°é¸æŠå¯èƒ½ï¼‰</p>
                <div id="genre-selector"></div>
            </div>
            <div class="action-buttons-container">
                <button id="format-button" class="action-btn">å½¢å¼</button>
                <button id="start-button" class="action-btn">ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
            </div>
        </div>

        <!-- Quiz Screen -->
        <div id="quiz-screen" class="screen hidden">
            <div id="quiz-header">
                <div id="quiz-header-side">
                    <span id="progress-text" class="info-text"></span>
                    <span id="score-text" class="info-text"></span>
                     <span id="lives-display" class="info-text"></span>
                </div>
                <span id="timer-display"></span>
                <div id="quiz-top-right">
                     <button id="pause-button" class="hidden"><svg id="pause-icon" viewBox="0 0 24 24"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"></path></svg></button>
                     <button id="abort-button" class="hidden">ä¸­æ–­</button>
                </div>
            </div>
            <div id="question-area"><p id="question-text">åŸå­ç•ªå·</p><p id="question-display">?</p></div>
            <div id="options-grid"></div>
            <div id="input-area" class="hidden">
                <input type="text" id="answer-input" placeholder="ç­”ãˆã‚’å…¥åŠ›">
                <button id="submit-answer-btn">æ±ºå®š</button>
            </div>
        </div>
    </div>
    
    <!-- Modals -->
    <div id="pause-overlay" class="modal-overlay hidden"><div class="modal-content"><h2>ä¸€æ™‚åœæ­¢</h2><button id="retry-btn" class="modal-btn">ãƒªãƒˆãƒ©ã‚¤</button><button id="back-to-title-btn" class="modal-btn">ã‚¿ã‚¤ãƒˆãƒ«ã«æˆ»ã‚‹</button><button id="close-pause-btn" class="modal-btn close-btn">é–‰ã˜ã‚‹</button></div></div>
    <div id="confirm-overlay" class="modal-overlay hidden"><div class="modal-content"><h2 id="confirm-title">ç¢ºèª</h2><p id="confirm-message"></p><div id="confirm-buttons"><button id="confirm-no" class="confirm-btn">ã„ã„ãˆ</button><button id="confirm-yes" class="confirm-btn">ã¯ã„</button></div></div></div>
    <div id="coin-info-overlay" class="modal-overlay hidden"><div class="modal-content"><h2>ã‚³ã‚¤ãƒ³</h2><p>æ­£è§£æ•°ã«å¿œã˜ã¦ã‚‚ã‚‰ãˆã‚‹ã€ç¯„å›²ä¸Šé™ã€ã‚¸ãƒ£ãƒ³ãƒ«ã€å½¢å¼ã®è§£æ”¾ã«ä½¿ã†ä»®æƒ³é€šè²¨ã€‚</p><button id="close-coin-info-btn" class="modal-btn close-btn">é–‰ã˜ã‚‹</button></div></div>
    <div id="result-overlay" class="modal-overlay hidden"><div class="modal-content"><h2 id="result-title">çµ‚äº†ï¼</h2><p id="result-message"></p><button id="close-result-btn" class="modal-btn close-btn">ã‚¿ã‚¤ãƒˆãƒ«ã¸</button></div></div>
    <div id="info-overlay" class="modal-overlay hidden"><div class="modal-content"><h2 id="info-title"></h2><p id="info-message"></p><button id="close-info-btn" class="modal-btn close-btn">é–‰ã˜ã‚‹</button></div></div>
    <!-- Unlock Modals -->
    <div id="unlock-step1-overlay" class="modal-overlay hidden"><div class="modal-content"><h2>ãƒ­ãƒƒã‚¯ä¸­</h2><p id="unlock-item-name">ã“ã®é …ç›®ã¯ãƒ­ãƒƒã‚¯ã•ã‚Œã¦ã„ã‚‹â€¦</p><button id="unlock-next-btn" class="modal-btn">æ¬¡ã¸</button></div></div>
    <div id="unlock-choice-overlay" class="modal-overlay hidden"><div class="modal-content"><h2 id="unlock-choice-title">ã‚¢ãƒ³ãƒ­ãƒƒã‚¯æ–¹æ³•</h2><div id="unlock-choice-buttons"><button id="unlock-key-btn" class="modal-btn">éµğŸ”‘ã§è§£æ”¾ (ğŸª™Ã—7)</button><button id="unlock-pick-btn" class="modal-btn">ãƒ”ãƒƒã‚¯ğŸ§·ã§è§£æ”¾ (ğŸª™Ã—1)</button><button id="unlock-cancel-btn" class="modal-btn">ã‚„ã£ã±ã‚Šè§£æ”¾ã—ãªã„</button></div></div></div>
    <div id="pick-fail-overlay" class="modal-overlay hidden"><div class="modal-content"><h2>å¤±æ•—â€¦</h2><p>ãƒ”ãƒƒã‚¯ãŒå£Šã‚Œã¦ã—ã¾ã£ãŸâ€¦</p><div id="pick-fail-buttons"><button id="pick-fail-back-btn" class="modal-btn">æ–¹æ³•ã‚’å¤‰ãˆã‚‹</button><button id="pick-fail-retry-btn" class="modal-btn">ğŸ§·ãƒªãƒˆãƒ©ã‚¤(ğŸª™Ã—1)</button><button id="pick-fail-close-btn" class="modal-btn close-btn">é–‰ã˜ã‚‹</button></div></div></div>
    
    <!-- Format Modal -->
    <div id="format-overlay" class="modal-overlay hidden">
        <div class="modal-content">
            <h2>ã©ã®å½¢å¼ã§éŠã¶ï¼Ÿ</h2>
            <div id="format-selection-grid">
                <!-- Buttons are generated by JS to ensure correct order -->
            </div>
            <button id="close-format-btn" class="modal-btn close-btn">ä¿å­˜ã—ã¦é–‰ã˜ã‚‹</button>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settings-overlay" class="modal-overlay hidden">
        <div class="modal-content">
            <h2>è¨­å®š</h2>
            <div class="setting-item">
                <div class="setting-item-title">å•é¡Œæ•°</div>
                 <div class="setting-controls">
                    <button class="btn-adjust btn-adjust-qc" data-amount="-100">-100</button><button class="btn-adjust btn-adjust-qc" data-amount="-50">-50</button><button class="btn-adjust btn-adjust-qc" data-amount="-25">-25</button><button class="btn-adjust btn-adjust-qc" data-amount="-10">-10</button><button class="btn-adjust btn-adjust-qc" data-amount="-5">-5</button><button class="btn-adjust btn-adjust-qc" data-amount="-1">-1</button>
                    <span id="question-count-value">10</span>
                    <button class="btn-adjust btn-adjust-qc" data-amount="1">+1</button><button class="btn-adjust btn-adjust-qc" data-amount="5">+5</button><button class="btn-adjust btn-adjust-qc" data-amount="10">+10</button><button class="btn-adjust btn-adjust-qc" data-amount="25">+25</button><button class="btn-adjust btn-adjust-qc" data-amount="50">+50</button><button class="btn-adjust btn-adjust-qc" data-amount="100">+100</button>
                </div>
                <button id="reset-qc-btn">ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®å•é¡Œæ•°ã«æˆ»ã™</button>
            </div>

            <div class="setting-divider"></div>

            <div class="setting-item">
                 <div class="setting-item-title">åˆ¶é™æ™‚é–“</div>
                 <div class="mode-buttons">
                    <button id="timer-mode-btn" class="mode-btn">ã‚ªãƒ•</button>
                 </div>
                 <div id="timer-controls" class="hidden">
                    <div class="setting-controls">
                        <button class="btn-adjust" data-target="timer" data-amount="-10">-10</button><button class="btn-adjust" data-target="timer" data-amount="-5">-5</button><button class="btn-adjust" data-target="timer" data-amount="-1">-1</button>
                        <span id="timer-value">10</span>
                        <button class="btn-adjust" data-target="timer" data-amount="1">+1</button><button class="btn-adjust" data-target="timer" data-amount="5">+5</button><button class="btn-adjust" data-target="timer" data-amount="10">+10</button>
                    </div>
                    <button id="reset-timer-btn">ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®åˆ¶é™æ™‚é–“ã«æˆ»ã™</button>
                 </div>
            </div>

            <div class="setting-divider"></div>

            <div class="setting-item">
                <div class="setting-item-title">é¸æŠè‚¢æ•°</div>
                <div id="choice-count-grid">
                    <button class="modal-btn choice-count-btn" data-count="4">4æŠ</button>
                    <button class="modal-btn choice-count-btn" data-count="8">8æŠ</button>
                    <button class="modal-btn choice-count-btn" data-count="12">12æŠ</button>
                    <button class="modal-btn choice-count-btn" data-count="16">16æŠ</button>
                    <button class="modal-btn choice-count-btn" data-count="20">20æŠ</button>
                    <button class="modal-btn choice-count-btn" data-count="24">24æŠ</button>
                </div>
            </div>
            
            <div class="setting-divider"></div>

            <div class="setting-item">
                <div class="setting-item-title">ãƒ¢ãƒ¼ãƒ‰</div>
                <div class="mode-buttons">
                    <button id="survival-mode-btn" class="mode-btn">ã‚µãƒã‚¤ãƒãƒ«</button>
                    <button id="hardcore-mode-btn" class="mode-btn">ãƒãƒ¼ãƒ‰ã‚³ã‚¢</button>
                    <button id="input-mode-btn" class="mode-btn">å…¥åŠ›</button>
                </div>
            </div>

            <div id="survival-section" class="setting-item hidden">
                <div class="setting-item-title">--- ã‚µãƒã‚¤ãƒãƒ« ---</div>
                <div class="mode-buttons">
                     <button id="endless-mode-btn" class="mode-btn">ã‚¨ãƒ³ãƒ‰ãƒ¬ã‚¹</button>
                </div>
            </div>

            <button id="close-settings-btn" class="modal-btn close-btn">ä¿å­˜ã—ã¦é–‰ã˜ã‚‹</button>
        </div>
    </div>


    <script>
        // Data with symbol, period, group
        const elements = [ {n:1,s:'H',name:"æ°´ç´ ",p:1,gr:1,g:["typical"]},{n:2,s:'He',name:"ãƒ˜ãƒªã‚¦ãƒ ",p:1,gr:18,g:["noble-gas","typical"]},{n:3,s:'Li',name:"ãƒªãƒã‚¦ãƒ ",p:2,gr:1,g:["alkali","typical"]},{n:4,s:'Be',name:"ãƒ™ãƒªãƒªã‚¦ãƒ ",p:2,gr:2,g:["alkaline-earth","typical"]},{n:5,s:'B',name:"ãƒ›ã‚¦ç´ ",p:2,gr:13,g:["typical"]},{n:6,s:'C',name:"ç‚­ç´ ",p:2,gr:14,g:["typical"]},{n:7,s:'N',name:"çª’ç´ ",p:2,gr:15,g:["typical"]},{n:8,s:'O',name:"é…¸ç´ ",p:2,gr:16,g:["typical"]},{n:9,s:'F',name:"ãƒ•ãƒƒç´ ",p:2,gr:17,g:["halogen","typical"]},{n:10,s:'Ne',name:"ãƒã‚ªãƒ³",p:2,gr:18,g:["noble-gas","typical"]},{n:11,s:'Na',name:"ãƒŠãƒˆãƒªã‚¦ãƒ ",p:3,gr:1,g:["alkali","typical"]},{n:12,s:'Mg',name:"ãƒã‚°ãƒã‚·ã‚¦ãƒ ",p:3,gr:2,g:["alkaline-earth","typical"]},{n:13,s:'Al',name:"ã‚¢ãƒ«ãƒŸãƒ‹ã‚¦ãƒ ",p:3,gr:13,g:["typical"]},{n:14,s:'Si',name:"ã‚±ã‚¤ç´ ",p:3,gr:14,g:["typical"]},{n:15,s:'P',name:"ãƒªãƒ³",p:3,gr:15,g:["typical"]},{n:16,s:'S',name:"ç¡«é»„",p:3,gr:16,g:["typical"]},{n:17,s:'Cl',name:"å¡©ç´ ",p:3,gr:17,g:["halogen","typical"]},{n:18,s:'Ar',name:"ã‚¢ãƒ«ã‚´ãƒ³",p:3,gr:18,g:["noble-gas","typical"]},{n:19,s:'K',name:"ã‚«ãƒªã‚¦ãƒ ",p:4,gr:1,g:["alkali","typical"]},{n:20,s:'Ca',name:"ã‚«ãƒ«ã‚·ã‚¦ãƒ ",p:4,gr:2,g:["alkaline-earth","typical"]},{n:21,s:'Sc',name:"ã‚¹ã‚«ãƒ³ã‚¸ã‚¦ãƒ ",p:4,gr:3,g:["transition"]},{n:22,s:'Ti',name:"ãƒã‚¿ãƒ³",p:4,gr:4,g:["transition"]},{n:23,s:'V',name:"ãƒãƒŠã‚¸ã‚¦ãƒ ",p:4,gr:5,g:["transition"]},{n:24,s:'Cr',name:"ã‚¯ãƒ­ãƒ ",p:4,gr:6,g:["transition"]},{n:25,s:'Mn',name:"ãƒãƒ³ã‚¬ãƒ³",p:4,gr:7,g:["transition"]},{n:26,s:'Fe',name:"é‰„",p:4,gr:8,g:["transition"]},{n:27,s:'Co',name:"ã‚³ãƒãƒ«ãƒˆ",p:4,gr:9,g:["transition"]},{n:28,s:'Ni',name:"ãƒ‹ãƒƒã‚±ãƒ«",p:4,gr:10,g:["transition"]},{n:29,s:'Cu',name:"éŠ…",p:4,gr:11,g:["transition"]},{n:30,s:'Zn',name:"äºœé‰›",p:4,gr:12,g:["transition"]},{n:31,s:'Ga',name:"ã‚¬ãƒªã‚¦ãƒ ",p:4,gr:13,g:["typical"]},{n:32,s:'Ge',name:"ã‚²ãƒ«ãƒãƒ‹ã‚¦ãƒ ",p:4,gr:14,g:["typical"]},{n:33,s:'As',name:"ãƒ’ç´ ",p:4,gr:15,g:["typical"]},{n:34,s:'Se',name:"ã‚»ãƒ¬ãƒ³",p:4,gr:16,g:["typical"]},{n:35,s:'Br',name:"è‡­ç´ ",p:4,gr:17,g:["halogen","typical"]},{n:36,s:'Kr',name:"ã‚¯ãƒªãƒ—ãƒˆãƒ³",p:4,gr:18,g:["noble-gas","typical"]},{n:37,s:'Rb',name:"ãƒ«ãƒ“ã‚¸ã‚¦ãƒ ",p:5,gr:1,g:["alkali","typical"]},{n:38,s:'Sr',name:"ã‚¹ãƒˆãƒ­ãƒ³ãƒã‚¦ãƒ ",p:5,gr:2,g:["alkaline-earth","typical"]},{n:39,s:'Y',name:"ã‚¤ãƒƒãƒˆãƒªã‚¦ãƒ ",p:5,gr:3,g:["transition"]},{n:40,s:'Zr',name:"ã‚¸ãƒ«ã‚³ãƒ‹ã‚¦ãƒ ",p:5,gr:4,g:["transition"]},{n:41,s:'Nb',name:"ãƒ‹ã‚ªãƒ–",p:5,gr:5,g:["transition"]},{n:42,s:'Mo',name:"ãƒ¢ãƒªãƒ–ãƒ‡ãƒ³",p:5,gr:6,g:["transition"]},{n:43,s:'Tc',name:"ãƒ†ã‚¯ãƒãƒã‚¦ãƒ ",p:5,gr:7,g:["transition"]},{n:44,s:'Ru',name:"ãƒ«ãƒ†ãƒ‹ã‚¦ãƒ ",p:5,gr:8,g:["transition"]},{n:45,s:'Rh',name:"ãƒ­ã‚¸ã‚¦ãƒ ",p:5,gr:9,g:["transition"]},{n:46,s:'Pd',name:"ãƒ‘ãƒ©ã‚¸ã‚¦ãƒ ",p:5,gr:10,g:["transition"]},{n:47,s:'Ag',name:"éŠ€",p:5,gr:11,g:["transition"]},{n:48,s:'Cd',name:"ã‚«ãƒ‰ãƒŸã‚¦ãƒ ",p:5,gr:12,g:["transition"]},{n:49,s:'In',name:"ã‚¤ãƒ³ã‚¸ã‚¦ãƒ ",p:5,gr:13,g:["typical"]},{n:50,s:'Sn',name:"ã‚¹ã‚º",p:5,gr:14,g:["typical"]},{n:51,s:'Sb',name:"ã‚¢ãƒ³ãƒãƒ¢ãƒ³",p:5,gr:15,g:["typical"]},{n:52,s:'Te',name:"ãƒ†ãƒ«ãƒ«",p:5,gr:16,g:["typical"]},{n:53,s:'I',name:"ãƒ¨ã‚¦ç´ ",p:5,gr:17,g:["halogen","typical"]},{n:54,s:'Xe',name:"ã‚­ã‚»ãƒãƒ³",p:5,gr:18,g:["noble-gas","typical"]},{n:55,s:'Cs',name:"ã‚»ã‚·ã‚¦ãƒ ",p:6,gr:1,g:["alkali","typical"]},{n:56,s:'Ba',name:"ãƒãƒªã‚¦ãƒ ",p:6,gr:2,g:["alkaline-earth","typical"]},{n:57,s:'La',name:"ãƒ©ãƒ³ã‚¿ãƒ³",p:6,gr:null,g:["lanthanoid","transition"]},{n:58,s:'Ce',name:"ã‚»ãƒªã‚¦ãƒ ",p:6,gr:null,g:["lanthanoid","transition"]},{n:59,s:'Pr',name:"ãƒ—ãƒ©ã‚»ã‚ªã‚¸ãƒ ",p:6,gr:null,g:["lanthanoid","transition"]},{n:60,s:'Nd',name:"ãƒã‚ªã‚¸ãƒ ",p:6,gr:null,g:["lanthanoid","transition"]},{n:61,s:'Pm',name:"ãƒ—ãƒ­ãƒ¡ãƒã‚¦ãƒ ",p:6,gr:null,g:["lanthanoid","transition"]},{n:62,s:'Sm',name:"ã‚µãƒãƒªã‚¦ãƒ ",p:6,gr:null,g:["lanthanoid","transition"]},{n:63,s:'Eu',name:"ãƒ¦ã‚¦ãƒ­ãƒ”ã‚¦ãƒ ",p:6,gr:null,g:["lanthanoid","transition"]},{n:64,s:'Gd',name:"ã‚¬ãƒ‰ãƒªãƒ‹ã‚¦ãƒ ",p:6,gr:null,g:["lanthanoid","transition"]},{n:65,s:'Tb',name:"ãƒ†ãƒ«ãƒ“ã‚¦ãƒ ",p:6,gr:null,g:["lanthanoid","transition"]},{n:66,s:'Dy',name:"ã‚¸ã‚¹ãƒ—ãƒ­ã‚·ã‚¦ãƒ ",p:6,gr:null,g:["lanthanoid","transition"]},{n:67,s:'Ho',name:"ãƒ›ãƒ«ãƒŸã‚¦ãƒ ",p:6,gr:null,g:["lanthanoid","transition"]},{n:68,s:'Er',name:"ã‚¨ãƒ«ãƒ“ã‚¦ãƒ ",p:6,gr:null,g:["lanthanoid","transition"]},{n:69,s:'Tm',name:"ãƒ„ãƒªã‚¦ãƒ ",p:6,gr:null,g:["lanthanoid","transition"]},{n:70,s:'Yb',name:"ã‚¤ãƒƒãƒ†ãƒ«ãƒ“ã‚¦ãƒ ",p:6,gr:null,g:["lanthanoid","transition"]},{n:71,s:'Lu',name:"ãƒ«ãƒ†ãƒã‚¦ãƒ ",p:6,gr:null,g:["lanthanoid","transition"]},{n:72,s:'Hf',name:"ãƒãƒ•ãƒ‹ã‚¦ãƒ ",p:6,gr:4,g:["transition"]},{n:73,s:'Ta',name:"ã‚¿ãƒ³ã‚¿ãƒ«",p:6,gr:5,g:["transition"]},{n:74,s:'W',name:"ã‚¿ãƒ³ã‚°ã‚¹ãƒ†ãƒ³",p:6,gr:6,g:["transition"]},{n:75,s:'Re',name:"ãƒ¬ãƒ‹ã‚¦ãƒ ",p:6,gr:7,g:["transition"]},{n:76,s:'Os',name:"ã‚ªã‚¹ãƒŸã‚¦ãƒ ",p:6,gr:8,g:["transition"]},{n:77,s:'Ir',name:"ã‚¤ãƒªã‚¸ã‚¦ãƒ ",p:6,gr:9,g:["transition"]},{n:78,s:'Pt',name:"ç™½é‡‘",p:6,gr:10,g:["transition"]},{n:79,s:'Au',name:"é‡‘",p:6,gr:11,g:["transition"]},{n:80,s:'Hg',name:"æ°´éŠ€",p:6,gr:12,g:["transition"]},{n:81,s:'Tl',name:"ã‚¿ãƒªã‚¦ãƒ ",p:6,gr:13,g:["typical"]},{n:82,s:'Pb',name:"é‰›",p:6,gr:14,g:["typical"]},{n:83,s:'Bi',name:"ãƒ“ã‚¹ãƒã‚¹",p:6,gr:15,g:["typical"]},{n:84,s:'Po',name:"ãƒãƒ­ãƒ‹ã‚¦ãƒ ",p:6,gr:16,g:["typical"]},{n:85,s:'At',name:"ã‚¢ã‚¹ã‚¿ãƒãƒ³",p:6,gr:17,g:["halogen","typical"]},{n:86,s:'Rn',name:"ãƒ©ãƒ‰ãƒ³",p:6,gr:18,g:["noble-gas","typical"]},{n:87,s:'Fr',name:"ãƒ•ãƒ©ãƒ³ã‚·ã‚¦ãƒ ",p:7,gr:1,g:["alkali","typical"]},{n:88,s:'Ra',name:"ãƒ©ã‚¸ã‚¦ãƒ ",p:7,gr:2,g:["alkaline-earth","typical"]},{n:89,s:'Ac',name:"ã‚¢ã‚¯ãƒãƒ‹ã‚¦ãƒ ",p:7,gr:null,g:["actinoid","transition"]},{n:90,s:'Th',name:"ãƒˆãƒªã‚¦ãƒ ",p:7,gr:null,g:["actinoid","transition"]},{n:91,s:'Pa',name:"ãƒ—ãƒ­ãƒˆã‚¢ã‚¯ãƒãƒ‹ã‚¦ãƒ ",p:7,gr:null,g:["actinoid","transition"]},{n:92,s:'U',name:"ã‚¦ãƒ©ãƒ³",p:7,gr:null,g:["actinoid","transition"]},{n:93,s:'Np',name:"ãƒãƒ—ãƒ„ãƒ‹ã‚¦ãƒ ",p:7,gr:null,g:["actinoid","transition"]},{n:94,s:'Pu',name:"ãƒ—ãƒ«ãƒˆãƒ‹ã‚¦ãƒ ",p:7,gr:null,g:["actinoid","transition"]},{n:95,s:'Am',name:"ã‚¢ãƒ¡ãƒªã‚·ã‚¦ãƒ ",p:7,gr:null,g:["actinoid","transition"]},{n:96,s:'Cm',name:"ã‚­ãƒ¥ãƒªã‚¦ãƒ ",p:7,gr:null,g:["actinoid","transition"]},{n:97,s:'Bk',name:"ãƒãƒ¼ã‚¯ãƒªã‚¦ãƒ ",p:7,gr:null,g:["actinoid","transition"]},{n:98,s:'Cf',name:"ã‚«ãƒªãƒ›ãƒ«ãƒ‹ã‚¦ãƒ ",p:7,gr:null,g:["actinoid","transition"]},{n:99,s:'Es',name:"ã‚¢ã‚¤ãƒ³ã‚¹ã‚¿ã‚¤ãƒ‹ã‚¦ãƒ ",p:7,gr:null,g:["actinoid","transition"]},{n:100,s:'Fm',name:"ãƒ•ã‚§ãƒ«ãƒŸã‚¦ãƒ ",p:7,gr:null,g:["actinoid","transition"]},{n:101,s:'Md',name:"ãƒ¡ãƒ³ãƒ‡ãƒ¬ãƒ“ã‚¦ãƒ ",p:7,gr:null,g:["actinoid","transition"]},{n:102,s:'No',name:"ãƒãƒ¼ãƒ™ãƒªã‚¦ãƒ ",p:7,gr:null,g:["actinoid","transition"]},{n:103,s:'Lr',name:"ãƒ­ãƒ¼ãƒ¬ãƒ³ã‚·ã‚¦ãƒ ",p:7,gr:null,g:["actinoid","transition"]},{n:104,s:'Rf',name:"ãƒ©ã‚¶ãƒ›ãƒ¼ã‚¸ã‚¦ãƒ ",p:7,gr:4,g:["transition"]},{n:105,s:'Db',name:"ãƒ‰ãƒ–ãƒ‹ã‚¦ãƒ ",p:7,gr:5,g:["transition"]},{n:106,s:'Sg',name:"ã‚·ãƒ¼ãƒœãƒ¼ã‚®ã‚¦ãƒ ",p:7,gr:6,g:["transition"]},{n:107,s:'Bh',name:"ãƒœãƒ¼ãƒªã‚¦ãƒ ",p:7,gr:7,g:["transition"]},{n:108,s:'Hs',name:"ãƒãƒƒã‚·ã‚¦ãƒ ",p:7,gr:8,g:["transition"]},{n:109,s:'Mt',name:"ãƒã‚¤ãƒˆãƒãƒªã‚¦ãƒ ",p:7,gr:9,g:["transition"]},{n:110,s:'Ds',name:"ãƒ€ãƒ¼ãƒ ã‚¹ã‚¿ãƒã‚¦ãƒ ",p:7,gr:10,g:["transition"]},{n:111,s:'Rg',name:"ãƒ¬ãƒ³ãƒˆã‚²ãƒ‹ã‚¦ãƒ ",p:7,gr:11,g:["transition"]},{n:112,s:'Cn',name:"ã‚³ãƒšãƒ«ãƒ‹ã‚·ã‚¦ãƒ ",p:7,gr:12,g:["transition"]},{n:113,s:'Nh',name:"ãƒ‹ãƒ›ãƒ‹ã‚¦ãƒ ",p:7,gr:13,g:["typical"]},{n:114,s:'Fl',name:"ãƒ•ãƒ¬ãƒ­ãƒ“ã‚¦ãƒ ",p:7,gr:14,g:["typical"]},{n:115,s:'Mc',name:"ãƒ¢ã‚¹ã‚³ãƒ“ã‚¦ãƒ ",p:7,gr:15,g:["typical"]},{n:116,s:'Lv',name:"ãƒªãƒãƒ¢ãƒªã‚¦ãƒ ",p:7,gr:16,g:["typical"]},{n:117,s:'Ts',name:"ãƒ†ãƒã‚·ãƒ³",p:7,gr:17,g:["halogen","typical"]},{n:118,s:'Og',name:"ã‚ªã‚¬ãƒã‚½ãƒ³",p:7,gr:18,g:["noble-gas","typical"]} ].map(e => ({number: e.n, symbol: e.s, name: e.name, period: e.p, group: e.gr, genres: e.g}));
        
        const genreData = { "transition": "é·ç§»å…ƒç´ ", "typical": "å…¸å‹å…ƒç´ ", "alkali": "ã‚¢ãƒ«ã‚«ãƒªé‡‘å±", "alkaline-earth": "ã‚¢ãƒ«ã‚«ãƒªåœŸé¡é‡‘å±", "halogen": "ãƒãƒ­ã‚²ãƒ³", "noble-gas": "è²´ã‚¬ã‚¹", "lanthanoid": "ãƒ©ãƒ³ã‚¿ãƒã‚¤ãƒ‰", "actinoid": "ã‚¢ã‚¯ãƒãƒã‚¤ãƒ‰" };
        const genreKeys = Object.keys(genreData);

        const formatData = {
            'number-to-name': { text: 'åŸå­ç•ªå·â†’å…ƒç´ å', classNum: 1, color: 'red' },
            'number-to-symbol': { text: 'åŸå­ç•ªå·â†’å…ƒç´ è¨˜å·', classNum: 2, color: '#ff69b4' },
            'number-to-period-group': { text: 'åŸå­ç•ªå·â†’å‘¨æœŸãƒ»æ—', classNum: 3, color: '#c71585' },
            'symbol-to-number': { text: 'å…ƒç´ è¨˜å·â†’åŸå­ç•ªå·', classNum: 4, color: 'blue' },
            'symbol-to-name': { text: 'å…ƒç´ è¨˜å·â†’å…ƒç´ å', classNum: 5, color: 'purple' },
            'symbol-to-period-group': { text: 'å…ƒç´ è¨˜å·â†’å‘¨æœŸãƒ»æ—', classNum: 6, color: '#4b0082' },
            'name-to-number': { text: 'å…ƒç´ åâ†’åŸå­ç•ªå·', classNum: 7, color: '#ffd700' },
            'name-to-symbol': { text: 'å…ƒç´ åâ†’å…ƒç´ è¨˜å·', classNum: 8, color: '#90ee90' },
            'name-to-period-group': { text: 'å…ƒç´ åâ†’å‘¨æœŸãƒ»æ—', classNum: 9, color: '#800000' },
            'period-group-to-number': { text: 'å‘¨æœŸãƒ»æ—â†’åŸå­ç•ªå·', classNum: 10, color: 'green' },
            'period-group-to-symbol': { text: 'å‘¨æœŸãƒ»æ—â†’å…ƒç´ è¨˜å·', classNum: 11, color: 'orange' },
            'period-group-to-name': { text: 'å‘¨æœŸãƒ»æ—â†’å…ƒç´ å', classNum: 12, color: '#b0c4de' },
        };
        const formatOrder = [
            'number-to-name', 'number-to-symbol', 'number-to-period-group',
            'symbol-to-number', 'symbol-to-name', 'symbol-to-period-group',
            'name-to-number', 'name-to-symbol', 'name-to-period-group',
            'period-group-to-number', 'period-group-to-symbol', 'period-group-to-name'
        ];

        // DOM Elements
        const get = (selector) => document.querySelector(selector);
        const getAll = (selector) => document.querySelectorAll(selector);
        const titleScreen=get('#title-screen'),quizScreen=get('#quiz-screen'),coinDisplay=get('#coin-display'),minValueEl=get('#min-value'),maxValueEl=get('#max-value'),startButton=get('#start-button'),formatButton=get('#format-button'),upgradeRangeBtn=get('#upgrade-range-btn'),optionsGrid=get('#options-grid'),questionDisplayEl=get('#question-display'),questionTextEl=get('#question-text'),progressTextEl=get('#progress-text'),scoreTextEl=get('#score-text'),genreSelector=get('#genre-selector'),pauseButton=get('#pause-button'),abortButton=get('#abort-button'),timerDisplay=get('#timer-display'),settingsBtn=get('#settings-btn'),pauseOverlay=get('#pause-overlay'),closePauseButton=get('#close-pause-btn'),retryButton=get('#retry-btn'),backToTitleButton=get('#back-to-title-btn'),confirmOverlay=get('#confirm-overlay'),confirmTitleEl=get('#confirm-title'),confirmMessageEl=get('#confirm-message'),confirmYesBtn=get('#confirm-yes'),confirmNoBtn=get('#confirm-no'),coinInfoOverlay=get('#coin-info-overlay'),closeCoinInfoBtn=get('#close-coin-info-btn'),resultOverlay=get('#result-overlay'),resultMessageEl=get('#result-message'),closeResultBtn=get('#close-result-btn'),infoOverlay=get('#info-overlay'),infoTitleEl=get('#info-title'),infoMessageEl=get('#info-message'),closeInfoBtn=get('#close-info-btn'),unlockStep1Overlay=get('#unlock-step1-overlay'),unlockItemNameEl=get('#unlock-item-name'),unlockNextBtn=get('#unlock-next-btn'),unlockChoiceOverlay=get('#unlock-choice-overlay'),unlockKeyBtn=get('#unlock-key-btn'),unlockPickBtn=get('#unlock-pick-btn'),unlockCancelBtn=get('#unlock-cancel-btn'),settingsOverlay=get('#settings-overlay'),closeSettingsBtn=get('#close-settings-btn'),questionCountValueEl=get('#question-count-value'),resetRangeBtn=get('#reset-range-btn'),resetQcBtn=get('#reset-qc-btn'),endlessModeBtn=get('#endless-mode-btn'),inputModeBtn=get('#input-mode-btn'),pickFailOverlay=get('#pick-fail-overlay'),pickFailBackBtn=get('#pick-fail-back-btn'),pickFailRetryBtn=get('#pick-fail-retry-btn'),pickFailCloseBtn=get('#pick-fail-close-btn'),formatOverlay=get('#format-overlay'),closeFormatBtn=get('#close-format-btn'),formatSelectionGrid=get('#format-selection-grid'),inputArea=get('#input-area'),answerInput=get('#answer-input'),submitAnswerBtn=get('#submit-answer-btn'),timerModeBtn=get('#timer-mode-btn'),timerControls=get('#timer-controls'),timerValueEl=get('#timer-value'),resetTimerBtn=get('#reset-timer-btn'),choiceCountGrid=get('#choice-count-grid'),livesDisplay=get('#lives-display'),survivalModeBtn=get('#survival-mode-btn'),hardcoreModeBtn=get('#hardcore-mode-btn'),survivalSection=get('#survival-section');

        // Game State
        let min = 1, max = 20, totalCoins = 0, questionCount = 10, isEndlessMode = false, isInputMode = false, currentQuestions = [], questionIndex = 0, score = 0, isAnswered = false, confirmAction = null, confirmNoAction = null, currentUpgradeLevel = 0, unlockedMaxRange = 20, unlockedGenres = {}, selectedGenres = new Set(), selectedFormats = new Set(), unlockedFormats = {}, timerEnabled = false, timerDuration = 10, choiceCount = 12, quizTimer = null, abortTimer = null, isSurvivalMode = false, isHardcoreMode = false, lives = 0;
        let infoCloseCallback = null;
        let formatButtonInterval = null;
        
        // Local Storage Keys
        const COIN_KEY='a_coins',FIB_BONUS_KEY='a_fib',N2_BONUS_KEY='a_n2',RANGE_UPGRADE_KEY='a_range',GENRE_UNLOCK_KEY='a_genres',QC_KEY='a_qc',ENDLESS_KEY='a_endless',FORMAT_KEY='a_formats',FORMAT_UNLOCK_KEY='a_format_unlocks', INPUT_KEY='a_input', TIMER_ENABLED_KEY='a_timer_enabled', TIMER_DURATION_KEY='a_timer_duration', CHOICE_COUNT_KEY='a_choice_count', SURVIVAL_KEY='a_survival', HARDCORE_KEY='a_hardcore';
        const upgradeTiers = [ { max: 20, cost: 0 }, { max: 36, cost: 5 }, { max: 54, cost: 5 }, { max: 71, cost: 7 }, { max: 103, cost: 10 }, { max: 118, cost: 15 } ];
        
        // --- Functions ---
        const save = (key, value) => localStorage.setItem(key, JSON.stringify(value instanceof Set ? Array.from(value) : value));
        const load = (key, defaultValue) => {
            const val = localStorage.getItem(key);
            if(val === null) return defaultValue;
            const parsed = JSON.parse(val);
            if(Array.isArray(parsed) && (key === FORMAT_KEY || key === 'a_genres_selected')) return new Set(parsed); 
            if(key === FORMAT_KEY && typeof parsed === 'string') return new Set([parsed]); // Handle legacy single format
            return parsed;
        };
        
        function loadGameData() {
            totalCoins = load(COIN_KEY, 5);
            currentUpgradeLevel = load(RANGE_UPGRADE_KEY, 0);
            unlockedGenres = load(GENRE_UNLOCK_KEY, {});
            unlockedFormats = load(FORMAT_UNLOCK_KEY, {});
            unlockedFormats['number-to-name'] = true;
            unlockedFormats['symbol-to-name'] = true;
            questionCount = load(QC_KEY, 10);
            isEndlessMode = load(ENDLESS_KEY, false);
            isInputMode = load(INPUT_KEY, false);
            selectedFormats = load(FORMAT_KEY, new Set(['number-to-name']));
            if(selectedFormats.size === 0) selectedFormats.add('number-to-name');
            timerEnabled = load(TIMER_ENABLED_KEY, false);
            timerDuration = load(TIMER_DURATION_KEY, 10);
            choiceCount = load(CHOICE_COUNT_KEY, 12);
            isSurvivalMode = load(SURVIVAL_KEY, false);
            isHardcoreMode = load(HARDCORE_KEY, false);
            unlockedMaxRange = upgradeTiers[currentUpgradeLevel].max;
            buildFormatButtons();
            updateAllDisplays();
        }
        const updateAllDisplays = () => { updateCoinDisplay(); updateUpgradeButton(); updateRangeDisplay(); renderGenreButtons(); updateQuestionCountDisplay(); updateSurvivalModeUI(); updateHardcoreModeUI(); updateInputModeDisplay(); updateMainFormatButton(); updateTimerSettingsUI(); updateChoiceCountUI(); };
        function updateCoinDisplay() { coinDisplay.textContent = `ğŸª™Ã—${totalCoins}`; save(COIN_KEY, totalCoins); }
        function updateUpgradeButton() { if (currentUpgradeLevel >= upgradeTiers.length - 1) { upgradeRangeBtn.textContent = 'ç¯„å›²ã¯æœ€å¤§ã§ã™'; upgradeRangeBtn.disabled = true; } else { upgradeRangeBtn.textContent = `ç¯„å›²ä¸Šé™UP (ğŸª™Ã—${upgradeTiers[currentUpgradeLevel + 1].cost})`; upgradeRangeBtn.disabled = false; } }
        function updateRangeDisplay() { minValueEl.textContent = min; maxValueEl.textContent = max; }
        function updateQuestionCountDisplay() { questionCountValueEl.textContent = questionCount; }
        
        function updateSurvivalModeUI() {
            survivalModeBtn.classList.toggle('active', isSurvivalMode);
            survivalSection.classList.toggle('hidden', !isSurvivalMode);
            updateEndlessModeDisplay();
        }
        
        function updateHardcoreModeUI() {
            hardcoreModeBtn.classList.toggle('active', isHardcoreMode);
            document.body.classList.toggle('hardcore', isHardcoreMode);
            startButton.classList.toggle('hardcore-active', isHardcoreMode);
        }

        function updateEndlessModeDisplay() {
            endlessModeBtn.classList.toggle('active', isEndlessMode && isSurvivalMode);
            startButton.classList.toggle('endless-active', isEndlessMode && isSurvivalMode);
        }
        function updateInputModeDisplay() { inputModeBtn.classList.toggle('active', isInputMode); }
        
        function adjustRange(target, amount) {
            if (target === 'min') {
                let newMin = min + amount;
                min = Math.max(1, Math.min(newMin, max - 1));
            } else { // target === 'max'
                let newMax = max + amount;
                max = Math.max(min + 1, Math.min(newMax, unlockedMaxRange));
            }
            updateRangeDisplay();
        }

        function adjustQuestionCount(amount) {
            questionCount = Math.max(1, Math.min(200, questionCount + amount));
            updateQuestionCountDisplay();
        }

        const shuffleArray = (array) => { for (let i = array.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [array[i], array[j]] = [array[j], array[i]]; } return array; };
        
        function startGame() {
            questionIndex = 0; score = 0; isAnswered = false;
            let availableElements = elements.filter(el => el.number >= min && el.number <= max);
            
            const hasPeriodGroupFormat = Array.from(selectedFormats).some(f => f.includes('period-group'));
            if (hasPeriodGroupFormat) {
                availableElements = availableElements.filter(el => el.group !== null);
            }

            if (selectedGenres.size > 0) {
                const filteredByGenre = availableElements.filter(el => el.genres.some(g => selectedGenres.has(g)));
                if (filteredByGenre.length === 0) {
                    const selectedGenreNames = Array.from(selectedGenres).map(g => genreData[g]).join(', ');
                    showInfoPopup('ã‚¨ãƒ©ãƒ¼', `æŒ‡å®šã—ãŸç¯„å›²ã«ã€Œ${selectedGenreNames}ã€ã¯ã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚`);
                    return;
                }
                availableElements = filteredByGenre;
            }

            if (availableElements.length === 0) {
                showInfoPopup('ã‚¨ãƒ©ãƒ¼', 'ã“ã®ç¯„å›²ãƒ»ã‚¸ãƒ£ãƒ³ãƒ«ãƒ»å½¢å¼ã«è©²å½“ã™ã‚‹å…ƒç´ ãŒã‚ã‚Šã¾ã›ã‚“ã€‚'); return;
            }
            
            if (isEndlessMode && isSurvivalMode) {
                currentQuestions = shuffleArray(availableElements);
                lives = 1;
            } else if (isSurvivalMode) {
                lives = 3;
            }

            if (!isEndlessMode) {
                if (availableElements.length >= questionCount) {
                    currentQuestions = shuffleArray(availableElements).slice(0, questionCount);
                } else {
                    let questions = [...availableElements];
                    while (questions.length < questionCount) {
                        questions.push(availableElements[Math.floor(Math.random() * availableElements.length)]);
                    }
                    currentQuestions = shuffleArray(questions);
                }
            }
            
            pauseButton.classList.toggle('hidden', timerEnabled);
            abortButton.classList.toggle('hidden', !timerEnabled);

            titleScreen.classList.add('hidden'); quizScreen.classList.remove('hidden'); displayQuestion();
        }
        
        let getCorrectAnswerString;
        let activeQuizFormat;

        function displayQuestion() {
            isAnswered = false; 
            if ((!isEndlessMode || isHardcoreMode) && questionIndex >= currentQuestions.length) { 
                showResult(); 
                return; 
            }
            
            let currentQ = currentQuestions[questionIndex % currentQuestions.length]; 
            
            const availableFormats = Array.from(selectedFormats);
            do {
                activeQuizFormat = availableFormats[Math.floor(Math.random() * availableFormats.length)];
            } while(activeQuizFormat.includes('period-group') && currentQ.group === null);

            
            questionDisplayEl.classList.remove('period-group-q');
            
            const formatMappings = {
                'number-to-name': { qText: 'åŸå­ç•ªå·', qDisplay: 'number', aText: 'å…ƒç´ åã§ç­”ãˆã‚ˆã€‚', getAnswer: el => el.name, getOption: el => el.name },
                'number-to-symbol': { qText: 'åŸå­ç•ªå·', qDisplay: 'number', aText: 'å…ƒç´ è¨˜å·ã§ç­”ãˆã‚ˆã€‚', getAnswer: el => el.symbol, getOption: el => el.symbol },
                'number-to-period-group': { qText: 'åŸå­ç•ªå·', qDisplay: 'number', aText: 'å‘¨æœŸãƒ»æ—ã§ç­”ãˆã‚ˆã€‚\n(ä¾‹: ç¬¬1å‘¨æœŸãƒ»1æ—)', getAnswer: el => `ç¬¬${el.period}å‘¨æœŸãƒ»${el.group}æ—`, getOption: el => `ç¬¬${el.period}å‘¨æœŸãƒ»${el.group}æ—` },
                'symbol-to-name': { qText: 'å…ƒç´ è¨˜å·', qDisplay: 'symbol', aText: 'å…ƒç´ åã§ç­”ãˆã‚ˆã€‚', getAnswer: el => el.name, getOption: el => el.name },
                'symbol-to-number': { qText: 'å…ƒç´ è¨˜å·', qDisplay: 'symbol', aText: 'åŸå­ç•ªå·ã§ç­”ãˆã‚ˆã€‚', getAnswer: el => String(el.number), getOption: el => el.number },
                'symbol-to-period-group': { qText: 'å…ƒç´ è¨˜å·', qDisplay: 'symbol', aText: 'å‘¨æœŸãƒ»æ—ã§ç­”ãˆã‚ˆã€‚\n(ä¾‹: ç¬¬1å‘¨æœŸãƒ»1æ—)', getAnswer: el => `ç¬¬${el.period}å‘¨æœŸãƒ»${el.group}æ—`, getOption: el => `ç¬¬${el.period}å‘¨æœŸãƒ»${el.group}æ—` },
                'name-to-number': { qText: 'å…ƒç´ å', qDisplay: 'name', aText: 'åŸå­ç•ªå·ã§ç­”ãˆã‚ˆã€‚', getAnswer: el => String(el.number), getOption: el => el.number },
                'name-to-symbol': { qText: 'å…ƒç´ å', qDisplay: 'name', aText: 'å…ƒç´ è¨˜å·ã§ç­”ãˆã‚ˆã€‚', getAnswer: el => el.symbol, getOption: el => el.symbol },
                'name-to-period-group': { qText: 'å…ƒç´ å', qDisplay: 'name', aText: 'å‘¨æœŸãƒ»æ—ã§ç­”ãˆã‚ˆã€‚\n(ä¾‹: ç¬¬1å‘¨æœŸãƒ»1æ—)', getAnswer: el => `ç¬¬${el.period}å‘¨æœŸãƒ»${el.group}æ—`, getOption: el => `ç¬¬${el.period}å‘¨æœŸãƒ»${el.group}æ—` },
                'period-group-to-name': { qText: 'å‘¨æœŸãƒ»æ—', qDisplay: el => `ç¬¬${el.period}å‘¨æœŸãƒ»${el.group}æ—`, aText: 'å…ƒç´ åã§ç­”ãˆã‚ˆã€‚', getAnswer: el => el.name, getOption: el => el.name, isPg: true },
                'period-group-to-symbol': { qText: 'å‘¨æœŸãƒ»æ—', qDisplay: el => `ç¬¬${el.period}å‘¨æœŸãƒ»${el.group}æ—`, aText: 'å…ƒç´ è¨˜å·ã§ç­”ãˆã‚ˆã€‚', getAnswer: el => el.symbol, getOption: el => el.symbol, isPg: true },
                'period-group-to-number': { qText: 'å‘¨æœŸãƒ»æ—', qDisplay: el => `ç¬¬${el.period}å‘¨æœŸãƒ»${el.group}æ—`, aText: 'åŸå­ç•ªå·ã§ç­”ãˆã‚ˆã€‚', getAnswer: el => String(el.number), getOption: el => el.number, isPg: true },
            };
            
            const currentFormat = formatMappings[activeQuizFormat];
            const questionDisplay = typeof currentFormat.qDisplay === 'function' ? currentFormat.qDisplay(currentQ) : currentQ[currentFormat.qDisplay];
            getCorrectAnswerString = () => currentFormat.getAnswer(currentQ);
            
            if (currentFormat.isPg) questionDisplayEl.classList.add('period-group-q');
            
            questionTextEl.textContent = isInputMode ? currentFormat.aText.replace('\n', ' ') : currentFormat.qText;
            questionDisplayEl.textContent = questionDisplay;
            
            optionsGrid.classList.toggle('hidden', isInputMode);
            inputArea.classList.toggle('hidden', !isInputMode);

            if (!isInputMode) {
                let options = [currentQ];
                let potentialOptions = elements.filter(el => el.number !== currentQ.number);
                if (activeQuizFormat.includes('period-group')) {
                    potentialOptions = potentialOptions.filter(el => el.group !== null);
                }
                const otherElements = shuffleArray(potentialOptions);

                for (let i = 0; options.length < choiceCount && i < otherElements.length; i++) { options.push(otherElements[i]); }
                
                optionsGrid.innerHTML = ''; 
                shuffleArray(options).forEach(option => { 
                    const button = document.createElement('button'); 
                    button.textContent = currentFormat.getOption(option);
                    button.className = 'option-btn'; 
                    button.dataset.number = option.number; 
                    button.addEventListener('click', checkAnswer); 
                    optionsGrid.appendChild(button); 
                });
            } else {
                answerInput.placeholder = currentFormat.aText.split('\n')[1] || "ç­”ãˆã‚’å…¥åŠ›";
                answerInput.value = '';
                answerInput.classList.remove('correct', 'incorrect');
                answerInput.focus();
            }
            updateInfo();
            startTimer();
        }

        function updateInfo() {
            if(isEndlessMode) { progressTextEl.textContent = `Q.${score + 1}`; } else { progressTextEl.textContent = `Q.${questionIndex + 1} / ${currentQuestions.length}`; }
            scoreTextEl.textContent = `Score: ${score}`;

            if(isSurvivalMode) {
                 livesDisplay.textContent = `â¤ï¸ Ã— ${lives}`;
            } else {
                 livesDisplay.textContent = '';
            }
        }
        
        function handleAnswer(isCorrect) {
            clearInterval(quizTimer);
            if (isCorrect) {
                score++;
            } else {
                if(isHardcoreMode) {
                    setTimeout(showResult, 1500);
                    return;
                }
                if(isSurvivalMode) {
                    lives--;
                    if(lives <= 0) {
                        setTimeout(showResult, 1500);
                        return;
                    }
                }
            }

            if (!isCorrect && isEndlessMode && isSurvivalMode) {
                setTimeout(showResult, 1500);
                return;
            }

             setTimeout(() => {
                questionIndex++;
                displayQuestion();
            }, 1500);
        }

        function checkAnswer(e) {
            if (isAnswered) return; isAnswered = true;
            const selectedButton = e.target;
            const correctNumber = currentQuestions[questionIndex % currentQuestions.length].number;
            const isCorrect = parseInt(selectedButton.dataset.number) === correctNumber;
            selectedButton.classList.add(isCorrect ? 'correct' : 'incorrect');
            if (!isCorrect) get(`[data-number="${correctNumber}"]`)?.classList.add('correct');
            handleAnswer(isCorrect);
        }

        function checkInputAction() {
            if (isAnswered) return; isAnswered = true;
            const userAnswer = answerInput.value.trim();
            const correctAnswer = getCorrectAnswerString();
            const isCorrect = userAnswer.toLowerCase() === correctAnswer.toLowerCase();
            answerInput.classList.add(isCorrect ? 'correct' : 'incorrect');
            if(!isCorrect) answerInput.value = correctAnswer;
            handleAnswer(isCorrect);
        }
        
        function showResult() {
            let earnedCoins = 0;
            if (isHardcoreMode) {
                const allCorrect = score === currentQuestions.length;
                earnedCoins = allCorrect ? Math.floor(score / 2) : 0;
            } else if (isSurvivalMode && isEndlessMode) {
                earnedCoins = Math.floor((score / 2) * (score/3));
            } else if (isSurvivalMode) {
                earnedCoins = Math.floor(score / 2) + lives;
            } else {
                earnedCoins = Math.floor(score / 2);
            }
            totalCoins += earnedCoins; 
            updateCoinDisplay(); 
            resultMessageEl.textContent = `æ­£è§£æ•°: ${score}å•\nã‚³ã‚¤ãƒ³ã‚’ ${earnedCoins} æšç²å¾—ã—ã¾ã—ãŸï¼`; 
            resultOverlay.classList.remove('hidden'); 
        }
        function showTitleScreen() { quizScreen.classList.add('hidden'); titleScreen.classList.remove('hidden'); getAll('.modal-overlay').forEach(el => el.classList.add('hidden')); }
        
        function showInfoPopup(title, message, buttonText = 'é–‰ã˜ã‚‹', callback = null) {
            infoTitleEl.textContent = title;
            infoMessageEl.textContent = message;
            closeInfoBtn.textContent = buttonText;
            infoCloseCallback = callback;
            infoOverlay.classList.remove('hidden');
        }

        function showConfirmPopup(message, action, title = "ç¢ºèª", noAction = null) {
            confirmTitleEl.textContent = title;
            confirmMessageEl.textContent = message;
            confirmAction = action;
            confirmNoAction = noAction;
            confirmOverlay.classList.remove('hidden');
        }
        
        function handleUpgrade() {
            if (currentUpgradeLevel >= upgradeTiers.length - 1) return; const nextTier = upgradeTiers[currentUpgradeLevel + 1];
            showConfirmPopup(`ğŸª™Ã—${nextTier.cost}ã§ç¯„å›²æ‹¡å¼µã‚’ã—ã¾ã™ã‹ï¼Ÿ`, () => {
                if (totalCoins >= nextTier.cost) {
                    totalCoins -= nextTier.cost;
                    currentUpgradeLevel++;
                    unlockedMaxRange = upgradeTiers[currentUpgradeLevel].max;
                    save(RANGE_UPGRADE_KEY, currentUpgradeLevel);
                    updateCoinDisplay();
                    updateUpgradeButton();
                    showInfoPopup("ç¯„å›²æ‹¡å¼µ", `æœ€å¤§${unlockedMaxRange}ã¾ã§è¨­å®šå¯èƒ½ã«ãªã‚Šã¾ã—ãŸï¼`);
                } else { showInfoPopup("ã‚³ã‚¤ãƒ³ä¸è¶³", "ã‚³ã‚¤ãƒ³ãŒè¶³ã‚Šã¾ã›ã‚“ã€‚"); }
            }, "ç¯„å›²æ‹¡å¼µ");
        }
        
        function renderGenreButtons() {
            genreSelector.innerHTML = '';
            genreKeys.forEach(key => {
                const btn = document.createElement('button');
                btn.dataset.genre = key;
                btn.textContent = genreData[key];
                btn.className = `genre-btn ${key}`;
                if (!unlockedGenres[key]) {
                    btn.classList.add('locked', 'locked-item');
                } else if (!selectedGenres.has(key)) {
                    btn.classList.add('deselected');
                }
                genreSelector.appendChild(btn);
            });
        }
        
        let unlockTarget = { type: null, key: null, name: '' };

        function handleGenreClick(e) {
            const btn = e.target.closest('.genre-btn'); if (!btn) return;
            const genre = btn.dataset.genre;
            if (btn.classList.contains('locked')) {
                unlockTarget = { type: 'genre', key: genre, name: genreData[genre] };
                unlockItemNameEl.textContent = `ã‚¸ãƒ£ãƒ³ãƒ«ã€Œ${unlockTarget.name}ã€ã¯ãƒ­ãƒƒã‚¯ã•ã‚Œã¦ã„ã¾ã™â€¦`;
                unlockStep1Overlay.classList.remove('hidden');
            } else {
                if (selectedGenres.has(genre)) {
                    selectedGenres.delete(genre);
                    btn.classList.add('deselected');
                } else {
                    selectedGenres.add(genre);
                    btn.classList.remove('deselected');
                }
            }
        }
        
        function showUnlockChoicePopup() { unlockChoiceOverlay.classList.remove('hidden'); }

        function attemptUnlock(method) {
            if (!unlockTarget.type) return;
            const cost = method === 'key' ? 7 : 1;
            if (totalCoins < cost) { showInfoPopup("ã‚³ã‚¤ãƒ³ä¸è¶³", "ã‚³ã‚¤ãƒ³ãŒè¶³ã‚Šã¾ã›ã‚“ã€‚"); return; }
            totalCoins -= cost;
            updateCoinDisplay();
            const success = method === 'key' ? true : Math.random() <= 0.18;
            
            if (success) {
                if(unlockTarget.type === 'genre') {
                    unlockedGenres[unlockTarget.key] = true;
                    save(GENRE_UNLOCK_KEY, unlockedGenres);
                    renderGenreButtons();
                    showInfoPopup("æˆåŠŸï¼", `ã‚¸ãƒ£ãƒ³ãƒ«ã€Œ${unlockTarget.name}ã€ã®ã‚¢ãƒ³ãƒ­ãƒƒã‚¯ã«æˆåŠŸã—ã¾ã—ãŸï¼`);
                } else if (unlockTarget.type === 'format') {
                    unlockedFormats[unlockTarget.key] = true;
                    save(FORMAT_UNLOCK_KEY, unlockedFormats);
                    showInfoPopup("æˆåŠŸï¼", `å½¢å¼ã€Œ${unlockTarget.name}ã€ã®ã‚¢ãƒ³ãƒ­ãƒƒã‚¯ã«æˆåŠŸã—ã¾ã—ãŸï¼`, 'å½¢å¼ä¸€è¦§ã«æˆ»ã‚‹', () => {
                        updateFormatButtons();
                        formatOverlay.classList.remove('hidden');
                    });
                }
            } else {
                pickFailOverlay.classList.remove('hidden');
            }
        }
        
        function handleCoinClick() {
            if (min === 11 && max === 23 && !load(FIB_BONUS_KEY)) { totalCoins += 112; save(FIB_BONUS_KEY, true); showInfoPopup('éš ã—ãƒœãƒ¼ãƒŠã‚¹ï¼', 'ãƒ•ã‚£ãƒœãƒŠãƒƒãƒãƒœãƒ¼ãƒŠã‚¹ã§ 112 ã‚³ã‚¤ãƒ³ç²å¾—ï¼'); updateCoinDisplay(); return; }
            if (min === 12 && max === 48 && !load(N2_BONUS_KEY)) { totalCoins += 128; save(N2_BONUS_KEY, true); showInfoPopup('éš ã—ãƒœãƒ¼ãƒŠã‚¹ï¼', '2â¿â»Â¹ãƒœãƒ¼ãƒŠã‚¹ã§ 128 ã‚³ã‚¤ãƒ³ç²å¾—ï¼'); updateCoinDisplay(); return; }
            coinInfoOverlay.classList.remove('hidden');
        }
        
        function setDefaultRange() { min = 1; max = unlockedMaxRange >= 36 ? 36 : 20; updateRangeDisplay(); }
        
        function buildFormatButtons() {
            formatSelectionGrid.innerHTML = '';
            formatOrder.forEach(key => {
                const format = formatData[key];
                const btn = document.createElement('button');
                btn.className = `format-btn format-btn-${format.classNum}`;
                btn.dataset.format = key;
                btn.textContent = format.text;
                formatSelectionGrid.appendChild(btn);
            });
        }
        
        function updateFormatButtons() {
            getAll('#format-selection-grid .format-btn').forEach(btn => {
                const format = btn.dataset.format;
                btn.classList.remove('locked', 'selected', 'deselected', 'locked-item');
                if (!unlockedFormats[format]) {
                    btn.classList.add('locked', 'locked-item');
                } else {
                    if (selectedFormats.has(format)) {
                        btn.classList.add('selected');
                    } else {
                        btn.classList.add('deselected');
                    }
                }
            });
            updateMainFormatButton();
        }

        function updateMainFormatButton() {
            clearInterval(formatButtonInterval);
            const selectedArray = Array.from(selectedFormats);
            const colors = selectedArray.map(key => formatData[key]?.color).filter(Boolean);
            const lightColorTexts = ['#ffd700', '#90ee90', '#b0c4de'];
            
            if (colors.length === 0) {
                 formatButton.style.background = 'var(--light-gray)';
                 formatButton.style.color = 'var(--text-color)';
            } else if (colors.length === 1) {
                formatButton.style.background = colors[0];
                formatButton.style.color = lightColorTexts.includes(colors[0]) ? 'black' : 'white';
            } else {
                let colorIndex = 0;
                const updateColor = () => {
                    const currentColor = colors[colorIndex];
                    formatButton.style.background = currentColor;
                    formatButton.style.color = lightColorTexts.includes(currentColor) ? 'black' : 'white';
                    colorIndex = (colorIndex + 1) % colors.length;
                };
                updateColor();
                formatButtonInterval = setInterval(updateColor, 1000);
            }
        }
        
        function updateTimerSettingsUI() {
            timerModeBtn.textContent = timerEnabled ? 'ã‚ªãƒ³' : 'ã‚ªãƒ•';
            timerModeBtn.classList.toggle('active', timerEnabled);
            timerControls.classList.toggle('hidden', !timerEnabled);
            timerValueEl.textContent = timerDuration;
        }

        function adjustTimer(amount) {
            timerDuration = Math.max(3, Math.min(45, timerDuration + amount));
            updateTimerSettingsUI();
        }
        
        function updateChoiceCountUI() {
            getAll('.choice-count-btn').forEach(btn => {
                btn.classList.toggle('selected', parseInt(btn.dataset.count) === choiceCount);
            });
            optionsGrid.style.gridTemplateColumns = `repeat(${Math.min(choiceCount/2, 4)}, 1fr)`;
        }

        function startTimer() {
            clearInterval(quizTimer);
            if (!timerEnabled) {
                timerDisplay.textContent = '';
                return;
            }
            let timeLeft = timerDuration;
            timerDisplay.textContent = `${timeLeft}s`;
            quizTimer = setInterval(() => {
                timeLeft--;
                timerDisplay.textContent = `${timeLeft}s`;
                if (timeLeft <= 0) {
                    clearInterval(quizTimer);
                    if (!isAnswered) {
                        isAnswered = true;
                        if(isInputMode) {
                            answerInput.classList.add('incorrect');
                            answerInput.value = getCorrectAnswerString();
                        } else {
                             const correctNumber = currentQuestions[questionIndex % currentQuestions.length].number;
                             get(`[data-number="${correctNumber}"]`)?.classList.add('correct');
                        }
                        handleAnswer(false);
                    }
                }
            }, 1000);
        }

        // --- Event Listeners ---
        getAll('.btn-adjust').forEach(button => button.addEventListener('click', (e) => {
            const target = e.target.dataset.target;
            const amount = parseInt(e.target.dataset.amount);
            if(target === 'timer') adjustTimer(amount);
            else adjustRange(target, amount);
        }));
        getAll('.btn-adjust-qc').forEach(button => button.addEventListener('click', (e) => adjustQuestionCount(parseInt(e.target.dataset.amount))));
        startButton.addEventListener('click', startGame);
        upgradeRangeBtn.addEventListener('click', handleUpgrade);
        genreSelector.addEventListener('click', handleGenreClick);
        pauseButton.addEventListener('click', () => pauseOverlay.classList.remove('hidden'));
        retryButton.addEventListener('click', () => showConfirmPopup('ãƒªãƒˆãƒ©ã‚¤ã—ã¾ã™ã‹ï¼Ÿ', () => { pauseOverlay.classList.add('hidden'); startGame(); }));
        backToTitleButton.addEventListener('click', () => showConfirmPopup('ã‚¿ã‚¤ãƒˆãƒ«ã«æˆ»ã‚Šã¾ã™ã‹ï¼Ÿ', showTitleScreen));
        
        confirmYesBtn.addEventListener('click', () => { if (confirmAction) confirmAction(); confirmAction = null; confirmNoAction = null; confirmOverlay.classList.add('hidden'); });
        confirmNoBtn.addEventListener('click', () => { if (confirmNoAction) confirmNoAction(); confirmAction = null; confirmNoAction = null; confirmOverlay.classList.add('hidden'); });

        coinDisplay.addEventListener('click', handleCoinClick);
        
        closePauseButton.addEventListener('click', () => pauseOverlay.classList.add('hidden'));
        closeCoinInfoBtn.addEventListener('click', () => coinInfoOverlay.classList.add('hidden'));
        closeResultBtn.addEventListener('click', showTitleScreen);
        closeInfoBtn.addEventListener('click', () => {
            infoOverlay.classList.add('hidden');
            if (infoCloseCallback) {
                infoCloseCallback();
                infoCloseCallback = null;
            }
        });
        
        // Unlock Flow
        unlockNextBtn.addEventListener('click', () => {
            unlockStep1Overlay.classList.add('hidden'); 
            const noAction = unlockTarget.type === 'format' ? () => {updateFormatButtons(); formatOverlay.classList.remove('hidden');} : null;
            showConfirmPopup("ğŸ”‘ã‹ğŸ§·ã§ãƒ­ãƒƒã‚¯è§£é™¤ã—ã¦ã¿ã¾ã™ã‹ï¼Ÿ", showUnlockChoicePopup, "ç¢ºèª", noAction);
        });
        
        const backToUnlockChoice = () => {
            showUnlockChoicePopup();
        };

        unlockKeyBtn.addEventListener('click', () => { unlockChoiceOverlay.classList.add('hidden'); showConfirmPopup(`éµğŸ”‘ã§æœ¬å½“ã«è§£æ”¾ã—ã¾ã™ã‹ï¼Ÿ (ğŸª™Ã—7)`, () => attemptUnlock('key'), "ç¢ºèª", backToUnlockChoice); });
        unlockPickBtn.addEventListener('click', () => { unlockChoiceOverlay.classList.add('hidden'); showConfirmPopup(`ãƒ”ãƒƒã‚¯ğŸ§·ã§æœ¬å½“ã«è§£æ”¾ã—ã¾ã™ã‹ï¼Ÿ (ğŸª™Ã—1)`, () => attemptUnlock('pick'), "ç¢ºèª", backToUnlockChoice); });
        unlockCancelBtn.addEventListener('click', () => { 
            unlockChoiceOverlay.classList.add('hidden');
            if(unlockTarget.type === 'format') {
                updateFormatButtons();
                formatOverlay.classList.remove('hidden');
            }
        });
        
        // Settings
        settingsBtn.addEventListener('click', () => settingsOverlay.classList.remove('hidden'));
        closeSettingsBtn.addEventListener('click', () => { save(QC_KEY, questionCount); save(INPUT_KEY, isInputMode); save(TIMER_ENABLED_KEY, timerEnabled); save(TIMER_DURATION_KEY, timerDuration); save(CHOICE_COUNT_KEY, choiceCount); save(SURVIVAL_KEY, isSurvivalMode); save(HARDCORE_KEY, isHardcoreMode); save(ENDLESS_KEY, isEndlessMode); settingsOverlay.classList.add('hidden'); });
        resetRangeBtn.addEventListener('click', setDefaultRange);
        resetQcBtn.addEventListener('click', () => adjustQuestionCount(10 - questionCount));
        
        survivalModeBtn.addEventListener('click', () => { 
            isSurvivalMode = !isSurvivalMode; 
            if(isSurvivalMode) isHardcoreMode = false;
            updateSurvivalModeUI();
            updateHardcoreModeUI();
        });
         hardcoreModeBtn.addEventListener('click', () => { 
            isHardcoreMode = !isHardcoreMode; 
            if(isHardcoreMode) {
                isSurvivalMode = false;
                isEndlessMode = false;
            }
            updateHardcoreModeUI();
            updateSurvivalModeUI();
        });

        endlessModeBtn.addEventListener('click', () => { 
            isEndlessMode = !isEndlessMode; 
            updateEndlessModeDisplay(); 
        });

        inputModeBtn.addEventListener('click', () => { isInputMode = !isInputMode; updateInputModeDisplay(); });
        timerModeBtn.addEventListener('click', () => { timerEnabled = !timerEnabled; updateTimerSettingsUI(); });
        resetTimerBtn.addEventListener('click', () => { timerDuration = 10; updateTimerSettingsUI(); });
        choiceCountGrid.addEventListener('click', (e) => {
            if(e.target.classList.contains('choice-count-btn')) {
                choiceCount = parseInt(e.target.dataset.count);
                updateChoiceCountUI();
            }
        });
        
        // Pick Fail
        pickFailBackBtn.addEventListener('click', () => { pickFailOverlay.classList.add('hidden'); showUnlockChoicePopup(); });
        pickFailRetryBtn.addEventListener('click', () => { pickFailOverlay.classList.add('hidden'); showConfirmPopup(`æœ¬å½“ã«ãƒªãƒˆãƒ©ã‚¤ã—ã¾ã™ã‹ï¼Ÿ (ğŸª™Ã—1)`, () => attemptUnlock('pick')); });
        pickFailCloseBtn.addEventListener('click', () => pickFailOverlay.classList.add('hidden'));

        // Format
        formatButton.addEventListener('click', () => { updateFormatButtons(); formatOverlay.classList.remove('hidden'); });
        closeFormatBtn.addEventListener('click', () => { save(FORMAT_KEY, selectedFormats); save(FORMAT_UNLOCK_KEY, unlockedFormats); formatOverlay.classList.add('hidden'); });
        formatSelectionGrid.addEventListener('click', (e) => {
            const btn = e.target.closest('.format-btn');
            if(!btn) return;
            const formatKey = btn.dataset.format;

            if (btn.classList.contains('locked')) {
                formatOverlay.classList.add('hidden');
                unlockTarget = { type: 'format', key: formatKey, name: btn.textContent.trim() };
                unlockItemNameEl.textContent = `å½¢å¼ã€Œ${unlockTarget.name}ã€ã¯ãƒ­ãƒƒã‚¯ã•ã‚Œã¦ã„ã¾ã™â€¦`;
                unlockStep1Overlay.classList.remove('hidden');
            } else {
                 if (selectedFormats.has(formatKey)) {
                    if (selectedFormats.size > 1) {
                        selectedFormats.delete(formatKey);
                    } else {
                        formatOverlay.classList.add('hidden');
                        showInfoPopup('æ³¨æ„', 'å½¢å¼ã¯å°‘ãªãã¨ã‚‚ä¸€ã¤ä»¥ä¸Šè¨­å®šã—ã¦ãã ã•ã„ã€‚','å½¢å¼ä¸€è¦§ã«æˆ»ã‚‹', () => {
                            updateFormatButtons();
                            formatOverlay.classList.remove('hidden');
                        });
                    }
                } else {
                    selectedFormats.add(formatKey);
                }
                 updateFormatButtons(); 
            }
        });
        
        // Input Mode Listeners
        submitAnswerBtn.addEventListener('click', checkInputAction);
        answerInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                checkInputAction();
            }
        });

        // Abort button
        abortButton.addEventListener('mousedown', () => {
            abortTimer = setTimeout(showTitleScreen, 1000);
            abortButton.classList.add('holding');
        });
         abortButton.addEventListener('touchstart', (e) => {
            e.preventDefault();
            abortTimer = setTimeout(showTitleScreen, 1000);
            abortButton.classList.add('holding');
        });
        abortButton.addEventListener('mouseup', () => {
            clearTimeout(abortTimer);
            abortButton.classList.remove('holding');
        });
        abortButton.addEventListener('mouseleave', () => {
            clearTimeout(abortTimer);
            abortButton.classList.remove('holding');
        });
        abortButton.addEventListener('touchend', () => {
            clearTimeout(abortTimer);
            abortButton.classList.remove('holding');
        });


        // --- Initial setup ---
        document.addEventListener('DOMContentLoaded', loadGameData);

    </script>
</body>
</html>

